/* global $, ThreeDeeTouch, Windows, MSApp, navigator, chrome, FastClick *//* global StatusBar, networkinterface, links, SunCalc, md5, sjcl, Camera *//* OpenSprinkler App
 * Copyright (C) 2015 - present, Samer Albahra. All rights reserved.
 *
 * This file is part of the OpenSprinkler project <http://opensprinkler.com>.
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License version 3 as
 * published by the Free Software Foundation.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */var DEFAULT_WEATHER_SERVER_URL="https://weather.opensprinkler.com",WEATHER_SERVER_URL="https://weather.opensprinkler.com",isIEMobile=/IEMobile/.test(navigator.userAgent),isAndroid=/Android|\bSilk\b/.test(navigator.userAgent),isiOS=/iP(ad|hone|od)/.test(navigator.userAgent),isFireFox=/Firefox/.test(navigator.userAgent),isWinApp=/MSAppHost/.test(navigator.userAgent),isOSXApp=isOSXApp||!1,isChromeApp="object"==typeof chrome&&"object"==typeof chrome.storage,isFileCapable=!isiOS&&!isAndroid&&!isIEMobile&&!isOSXApp&&!isWinApp&&window.FileReader,isTouchCapable="ontouchstart"in window||"onmsgesturechange"in window,isMetric=-1===["US","BM","PW"].indexOf(navigator.languages[0].split("-")[1]),// Small wrapper to handle Chrome vs localStorage usage
storage={get:function(e,t){if(t=t||function(){},isChromeApp)chrome.storage.local.get(e,t);else{var a={},n;for(n in"string"==typeof e&&(e=[e]),e)e.hasOwnProperty(n)&&(a[e[n]]=localStorage.getItem(e[n]));t(a)}},set:function(e,t){if(t=t||function(){},isChromeApp)chrome.storage.local.set(e,t);else{if("object"==typeof e)for(var a in e)e.hasOwnProperty(a)&&localStorage.setItem(a,e[a]);t(!0)}},remove:function(e,t){if(t=t||function(){},isChromeApp)chrome.storage.local.remove(e,t);else{for(var a in"string"==typeof e&&(e=[e]),e)e.hasOwnProperty(a)&&localStorage.removeItem(e[a]);t(!0)}}},// Define general regex patterns
regex={gps:/^[-+]?([1-8]?\d(\.\d+)?|90(\.0+)?),\s*[-+]?(180(\.0+)?|((1[0-7]\d)|([1-9]?\d))(\.\d+)?)$/},// Define the status bar color(s) and use a darker color for Android
statusBarPrimary=isAndroid?"#121212":"#1D1D1D",statusBarOverlay=isAndroid?"#151515":"#202020",// Define the amount of times the app will retry an HTTP request before marking it failed
retryCount=2,// Initialize controller array which will store JSON data
controller={},switching=!1,currentCoordinates=[0,0],// Initialize variables to keep track of current page count
pageHistoryCount=-1,goingBack=!1,// Define the mapping between options and JSON keys
keyIndex={tz:1,ntp:2,dhcp:3,ip1:4,ip2:5,ip3:6,ip4:7,gw1:8,gw2:9,gw3:10,gw4:11,hp0:12,hp1:13,ar:14,ext:15,seq:16,sdt:17,mas:18,mton:19,mtof:20,urs:21,rso:22,wl:23,den:24,ipas:25,devid:26,con:27,lit:28,dim:29,bst:30,uwt:31,ntp1:32,ntp2:33,ntp3:34,ntp4:35,lg:36,mas2:37,mton2:38,mtof2:39,fpr0:41,fpr1:42,re:43,dns1:44,dns2:45,dns3:46,dns4:47,sar:48,ife:49,sn1t:50,sn1o:51,sn2t:52,sn2o:53,sn1on:54,sn1of:55,sn2on:56,sn2of:57,subn1:58,subn2:59,subn3:60,subn4:61},// Array to hold all notifications currently displayed within the app
notifications=[],timers={},curr183,currIp,currPrefix,currAuth,currPass,currAuthUser,currAuthPass,currLocal,currLang,language,deviceip,errorTimeout,weather,openPanel;// Initialize global variables
// Prevent errors from bubbling up on Windows
// Redirect jQuery Mobile DOM manipulation to prevent error
if(isWinApp&&$(window).on("error",function(e,t,a){return window.console.log(e,t,a),!0}),window.MSApp){if(window.Windows&&Windows.UI&&Windows.UI.ApplicationSettings&&Windows.UI.ApplicationSettings.SettingsPane){// Add link to privacy statement
var settingsPane=Windows.UI.ApplicationSettings.SettingsPane.getForCurrentView();// Bind the privacy policy to the settings panel
settingsPane.addEventListener("commandsrequested",function(e){var t=e.request.applicationCommands,a=new Windows.UI.ApplicationSettings.SettingsCommand("privacy","Privacy Policy",function(){window.open("https://albahra.com/journal/privacy-policy")});t.append(a)})}MSApp.execUnsafeLocalFunction&&($.fn.oldDomManIp=$.fn.domManip,$.fn.domManip=function(e,t,a){var i=this;return MSApp.execUnsafeLocalFunction(function(){return i.oldDomManIp(e,t,a)})})}$(document).one("deviceready",function(){try{//Change the status bar to match the headers
StatusBar.overlaysWebView(!1),StatusBar.styleLightContent(),StatusBar.backgroundColorByHexString(statusBarPrimary),$.mobile.window.on("statusTap",function(){$("body, html").animate({scrollTop:0},700)})}catch(e){}// Hide the splash screen
// For Android and Windows Phone devices catch the back button and redirect it
setTimeout(function(){try{navigator.splashscreen.hide()}catch(e){}},500),$.mobile.document.on("backbutton",function(){return!(isIEMobile&&$.mobile.document.data("iabOpen"))&&(checkChangesBeforeBack(),!1)}),updateDeviceIP(),isiOS&&ThreeDeeTouch.isAvailable(function(e){e&&(ThreeDeeTouch.enableLinkPreview(),ThreeDeeTouch.configureQuickActions([{type:"sites",title:_("Manage Sites"),iconType:"Location"},{type:"addprogram",title:_("Add Program"),iconType:"Add"},{type:"stopall",title:_("Stop All Stations"),iconType:"Pause"}]),ThreeDeeTouch.onHomeIconPressed=function(e){"sites"===e.type?changePage("#site-control"):"addprogram"===e.type?changePage("#addprogram"):"stopall"===e.type&&stopAllStations()})})}).one("mobileinit",function(){(isChromeApp||"file:"===window.location.protocol)&&($.mobile.hashListeningEnabled=!1),$.support.cors=!0,$.mobile.allowCrossDomainPages=!0,loadUnitSetting()}).on("pagebeforechange",function(t,e){var a=e.toPage,i=$(".ui-page-active"),n;// Pagebeforechange event triggers twice (before and after)
// and this check ensures we get the before state
// Animations are patchy if the page isn't scrolled to the top.
// This scrolls the page before the animation fires off.
"string"==typeof e.toPage&&(n=$.mobile.path.parseUrl(a).hash,0<i.length&&n==="#"+i.attr("id")||("popup"!==e.options.role&&!$(".ui-popup-active").length&&$.mobile.silentScroll(0),"#programs"===n?getPrograms(e.options.programToExpand):"#addprogram"===n?addProgram(e.options.copyID):"#manual"===n?getManual():"#about"===n?showAbout():"#runonce"===n?getRunonce():"#os-options"===n?showOptions(e.options.expandItem):"#preview"===n?getPreview():"#logs"===n?getLogs():"#forecast"===n?showForecast():"#loadingPage"===n?checkConfigured(!0):"#start"===n?showStart():"#site-control"===n?showSites():"#sprinklers"===n&&(0===$(n).length?showHome(e.options.firstLoad):$(n).one("pageshow",refreshStatus))));// Grabs the new page hash
})// Handle OS resume event triggered by PhoneGap
.on("resume",function(){// If we don't have a current device IP set, there is nothing else to update
void 0===currIp||(// If cloud token is available then sync sites
// Indicate the weather and device status are being updated
cloudSync(),showLoading("#weather,#footer-running"),updateController(updateWeather,networkFail))}).on("pause",function(){// Handle application being paused/closed
}).on("pagebeforeshow",function(t){var e="#"+t.target.id;// Modify the header and footer visibility before page show event
"#start"==e||"#loadingPage"==e?$("#header,#footer,#footer-menu").hide():$("#header,#footer,#footer-menu").show(),storage.get("showDisabled",function(t){t.showDisabled&&"true"===t.showDisabled&&$(e).addClass("show-hidden").find(".station-hidden").show()})}).on("pageshow",function(t){var e="#"+t.target.id,a=$(e);if(goingBack?goingBack=!1:pageHistoryCount++,fixInputClick(a),isControllerConnected()&&"#site-control"!=e&&"#start"!=e&&"#loadingPage"!=e){// Update the controller status every 5 seconds and the program and station data every 30 seconds
var i=setInterval(refreshStatus,5e3),n;checkOSVersion(216)||(n=setInterval(refreshData,2e4)),a.one("pagehide",function(){clearInterval(i),clearInterval(n)})}}).on("popupafteropen",function(){// When a popup opens that has an overlay, update the status bar background color to match
if($(".ui-overlay-b:not(.ui-screen-hidden)").length)try{StatusBar.backgroundColorByHexString(statusBarOverlay)}catch(e){}}).on("popupafterclose",function(){$(".ui-page-active").children().add("#sprinklers-settings").removeClass("blur-filter");// When a popup is closed, change the header back to the default color
try{StatusBar.backgroundColorByHexString(statusBarPrimary)}catch(e){}}).on("popupbeforeposition",function(){$(".ui-page-active").children().add("#sprinklers-settings").addClass("blur-filter")}).on("popupbeforeposition","#localization",checkCurrLang).one("pagebeforeshow","#loadingPage",initApp);function initApp(){//Update the language on the page using the browser's locale
//After jQuery mobile is loaded set initial configuration
// Correctly handle popup events and prevent history navigation on custom selectmenu popup
// Bind event handler to open panel when swiping right
// Extend collapsible widget with event before change
//Update site based on selector
// Bind footer menu button
// Initialize the app header
//Attach FastClick handler
// Start interval loop which will update timers/clocks
// Handle keybinds
// Initialize external panel
// If cloud token is available then sync sites
//On initial load check if a valid site exists for auto connect
updateLang(),currLocal||$.ajaxSetup({timeout:1e4}),isIEMobile&&insertStyle(".ui-toolbar-back-btn{display:none!important}ul{list-style:none!important;}"),isChromeApp&&insertStyle("html,body{overflow-y:scroll}"),isAndroid?(insertStyle(".ui-toolbar-back-btn{display:none!important}"),$(this).ajaxStart(function(){try{navigator.app.clearCache()}catch(e){}})):isFireFox?$.ajaxSetup({xhr:function(){return new window.XMLHttpRequest({mozSystem:!0})}}):$.ajaxSetup({cache:!1}),$.mobile.defaultPageTransition=isAndroid||isIEMobile?"fade":"slide",$.mobile.hoverDelay=0,$.mobile.activeBtnClass="activeButton",isOSXApp||$.mobile.document.on("click",".iab",function(){var e=$(this),t=window.open(this.href,"_blank","location="+(isAndroid?"yes":"no")+",enableViewportScale="+(e.hasClass("iabNoScale")?"no":"yes")+",toolbarposition=top,closebuttoncaption="+(e.hasClass("iabNoScale")?_("Back"):_("Done")));return isIEMobile&&($.mobile.document.data("iabOpen",!0),t.addEventListener("exit",function(){$.mobile.document.removeData("iabOpen")})),setTimeout(function(){e.removeClass("ui-btn-active")},100),!1}),$.mobile.document.on("click",".ui-select .ui-btn",function(){var e=$(this),t=e.attr("id").replace("-button","-listbox"),a=$("#"+t);return a.popup("destroy").detach().addClass("ui-page-theme-a"),$.mobile.pageContainer.append(a),a.popup({history:!1,positionTo:e,overlayTheme:"b"}).popup("open"),e.off("click").on("click",function(){a.popup("open")}),!1}),$.mobile.document.on("swiperight swipeleft",".ui-page",function(t){var e=$(".ui-page-active");"INPUT"===t.target.tagName||"TEXTAREA"===t.target.tagName||"open"===e.jqmData("panel")||e.find(".ui-popup-active").length||("swiperight"===t.type?openPanel():showNotifications())}),$.widget("mobile.collapsible",$.mobile.collapsible,{_handleExpandCollapse:function(e){this._trigger("before"+(e?"collapse":"expand"))&&this._superApply(arguments)}}),$("#site-selector").on("change",function(){updateSite($(this).val())}),$("#footer-menu").on("click",function(){showHomeMenu(this)}),$("#header,#footer").toolbar(),FastClick.attach(document.body),updateTimers(),$.mobile.document.on("keydown",function(t){var e=$(t.target).prop("tagName");if("INPUT"!==e&&"TEXTAREA"!==e){var a=t.keyCode,i=t.altKey,n=$("#mainMenu-popup").hasClass("ui-popup-active");if(77===a){var s=$("#mainMenu");0<s.length?$("#mainMenu").popup("close"):showHomeMenu()}else(n||i)&&80===a?(t.preventDefault(),changePage("#programs")):(n||i)&&79===a?(t.preventDefault(),changePage("#os-options")):(n||i)&&86===a?(t.preventDefault(),changePage("#preview")):(n||i)&&76===a?(t.preventDefault(),changePage("#logs")):(n||i)&&82===a?(t.preventDefault(),changePage("#runonce")):(n||i)&&68===a&&(t.preventDefault(),showRainDelay())}}),bindPanel(),currLocal||"undefined"!=typeof cordova||updateDeviceIP(),cloudSync(),setTimeout(function(){checkConfigured(!0)},200)}// Handle main switches for manual mode
function flipSwitched(){if(!switching){//Find out what the switch was changed to
var e=$(this),t=e.attr("id"),a=e.is(":checked"),i="mmm"===t?"mm":t,n;n=a?sendToOS("/cv?pw=&"+i+"=1"):sendToOS("/cv?pw=&"+i+"=0"),$.when(n).then(function(){refreshStatus(),"mmm"===t&&$("#mm_list .green").removeClass("green"),checkStatus()},function(){switching=!0,setTimeout(function(){switching=!1},200),e.prop("checked",!a).flipswitch("refresh")})}}// Wrapper function to communicate with OpenSprinkler
function sendToOS(t,a){t=t.replace("pw=","pw="+encodeURIComponent(currPass)),a=a||"text";// Designate AJAX queue based on command type
var i=/\/(?:cv|cs|cr|cp|uwa|dp|co|cl|cu|up|cm)/.exec(t),n=i?"change":"default",// Use POST when sending data to the controller (requires firmware 2.1.8 or newer)
s=i&&checkOSVersion(300),o={url:currPrefix+currIp+(s?t.split("?")[0]:t),type:s?"POST":"GET",data:s?getUrlVars(t):null,dataType:a,shouldRetry:function(e,t){return!(0===e.status&&"abort"===e.statusText||retryCount<t)||($.ajaxq.abort(n),!1)}},d;return currAuth&&$.extend(o,{beforeSend:function(e){e.setRequestHeader("Authorization","Basic "+btoa(currAuthUser+":"+currAuthPass))}}),curr183&&$.extend(o,{cache:"true"}),d=$.ajaxq(n,o).then(function(e){// In case the data type was incorrect, attempt to fix.
// If fix not possible, return string
if("string"==typeof e)try{e=$.parseJSON(e)}catch(t){return e}// Don't need to handle this situation for OSPi or firmware below 2.1.0
// Only show error messages on setting change requests
return"object"!=typeof e||"number"!=typeof e.result?e:1===e.result?e:2===e.result?(/\/(?:cv|cs|cr|cp|uwa|dp|co|cl|cu|up|cm)/.exec(t)&&showerror(_("Check device password and try again.")),$.Deferred().reject({status:401})):32===e.result?$.Deferred().reject({status:404}):/\/(?:cv|cs|cr|cp|uwa|dp|co|cl|cu|up|cm)/.exec(t)?(48===e.result?showerror(_("The selected station is already running or is scheduled to run.")):showerror(_("Please check input and try again.")),$.Deferred().reject(e)):void 0;// Return as successful
},function(a){("timeout"===a.statusText||0===a.status)&&/\/(?:cv|cs|cr|cp|uwa|dp|co|cl|cu|cm)/.exec(t)?showerror(_("Connection timed-out. Please try again.")):401===a.status&&showerror(_("Check device password and try again."))}),d}function networkFail(){changeStatus(0,"red","<p class='running-text center'>"+_("Network Error")+"</p>",function(){showLoading("#weather,#footer-running"),refreshStatus(),updateWeather()})}// Gather new controller information and load home page
function newLoad(){// Get the current site name from the site select drop down
var e=$("#site-selector").val(),t="<div class='logo'></div><h1 style='padding-top:5px'>"+_("Connecting to")+" "+e+"</h1><p class='cancel tight center inline-icon'><span class='btn-no-border ui-btn ui-icon-delete ui-btn-icon-notext'></span>Cancel</p>";//Empty object which will store device data
//Empty notifications
//Empty timers object
//Clear the current queued AJAX requests (used for previous controller connection)
$.mobile.loading("show",{html:currLocal?"<h1>"+_("Loading")+"</h1>":t,textVisible:!0,theme:"b"}),$(".ui-loader").css({"box-shadow":"none","margin-top":"-4em"}).find(".cancel").one("click",function(){$.ajaxq.abort("default"),changePage("#site-control",{transition:"none"})}),controller={},clearNotifications(),timers={},$.ajaxq.abort("default"),updateController(function(){var t=$(".weatherAdjust"),a=$(".changePassword");// Check if a firmware update is available
// Check for unused expansion boards
// Check if a cloud token is available and if so show logout button otherwise show login
$.mobile.loading("hide"),checkURLandUpdateWeather(),checkOSVersion(210)?t.css("display",""):t.hide(),isOSPi()||checkOSVersion(208)?a.css("display",""):a.hide(),currLocal?$("#info-list").find("li[data-role='list-divider']").text(_("Information")):($("#info-list").find("li[data-role='list-divider']").text(e),document.title="OpenSprinkler - "+e),checkFirmwareUpdate(),detectUnusedExpansionBoards(),checkOSVersion(213)&&255!==controller.options.hwv&&fixPasswordHash(e),currLocal||"number"!=typeof controller.settings.eip||checkPublicAccess(controller.settings.eip),updateLoginButtons(),isOSPi()&&showUnifiedFirmwareNotification(),controller.options.firstRun?showGuidedSetup():goHome(!0)},function(t){$.ajaxq.abort("default"),controller={},$.mobile.loading("hide");var a=function(){currLocal?storage.remove(["sites"],function(){window.location.reload()}):"site-control"===$(".ui-page-active").attr("id")?i():($.mobile.document.one("pageshow",i),changePage("#site-control",{transition:"none"}))},i=function(){showerror(_("Unable to connect to")+" "+e,3500)};"object"==typeof t&&401===t.status?($(".ui-popup-active").find("[data-role='popup']").popup("close"),changePassword({fixIncorrect:!0,name:e,callback:newLoad,cancel:a})):a()})}// Update controller information
function updateController(e,t){e=e||function(){},t=t||function(){};var a=function(){$("html").trigger("datarefresh"),checkStatus(),e()};isControllerConnected()&&checkOSVersion(216)?sendToOS("/ja?pw=","json").then(function(e){if("undefined"==typeof e||$.isEmptyObject(e))return void t();// The /ja call does not contain special station data, so let's cache it
var i=controller.special;// Restore the station cache to the object
// Fix the station status array
controller=e,controller.special=i,controller.status=controller.status.sn,a()},t):$.when(updateControllerPrograms(),updateControllerStations(),updateControllerOptions(),updateControllerStatus(),updateControllerSettings()).then(a,t)}function updateControllerPrograms(e){return e=e||function(){},!0===curr183?sendToOS("/gp?d=0").done(function(t){for(var a=t.match(/(nprogs|nboards|mnp)=[\w|\d|.\"]+/g),n=/pd=\[\];(.*);/.exec(t),s={},o=0,d,l;o<a.length;o++)""!==a[o]&&(d=a[o].split("="),s[d[0]]=parseInt(d[1]));if(s.pd=[],null!==n)for(n=n[1].split(";"),o=0;o<n.length;o++)l=n[o].split("="),l=l[1].replace("[",""),l=l.replace("]",""),s.pd[o]=parseIntArray(l.split(","));controller.programs=s,e()}):sendToOS("/jp?pw=","json").done(function(t){controller.programs=t,e()})}function updateControllerStations(e){return e=e||function(){},!0===curr183?sendToOS("/vs").done(function(t){var a=/snames=\[(.*?)\];/.exec(t),n=t.match(/(?:masop|mo)\s?[=|:]\s?\[(.*?)\]/);a=a[1].split(","),a.pop();for(var s=0;s<a.length;s++)a[s]=a[s].replace(/'/g,"");n=parseIntArray(n[1].split(",")),controller.stations={snames:a,masop:n,maxlen:a.length},e()}):sendToOS("/jn?pw=","json").done(function(t){controller.stations=t,e()})}function updateControllerOptions(e){return e=e||function(){},!0===curr183?sendToOS("/vo").done(function(t){var a=t.match(/var sd\s*=/),n={},s,d,l;if(a){for(var r=/(tz|htp|htp2|nbrd|seq|sdt|mas|mton|mtoff|urs|rst|wl|ipas)\s?[=|:]\s?([\w|\d|.\"]+)/gm,c;null!==(s=r.exec(t));)c=s[1].replace("nbrd","ext").replace("mtoff","mtof"),n[c]=+s[2];n.ext--,n.fwv="1.8.3-ospi"}else{var p=[1,2,12,13,14,15,16,17,18,19,20,21,22,23,25,26];for(s=/var opts=\[(.*)\];/.exec(t),s=s[1].replace(/"/g,"").split(","),d=0;d<s.length-1;d+=4)l=+s[d+3],-1!==$.inArray(l,p)&&(n[keyIndex[l]]=+s[d+2]);n.fwv=183}controller.options=n,e()}):sendToOS("/jo?pw=","json").done(function(t){controller.options=t,e()})}function updateControllerStatus(e){return e=e||function(){},!0===curr183?sendToOS("/sn0").then(function(t){var a=t.toString().match(/\d+/);a=parseIntArray(a[0].split("")),controller.status=a,e()},function(){controller.status=[]}):sendToOS("/js?pw=","json").then(function(t){controller.status=t.sn,e()},function(){controller.status=[]})}function updateControllerSettings(e){return e=e||function(){},!0===curr183?sendToOS("").then(function(e){var t=/(ver|devt|nbrd|tz|en|rd|rs|mm|rdst|urs)\s?[=|:]\s?([\w|\d|.\"]+)/gm,a=e.match(/loc\s?[=|:]\s?[\"|'](.*)[\"|']/),n=e.match(/lrun=\[(.*)\]/),s=e.match(/ps=\[(.*)\];/),o={},d,l;for(s=s[1].split("],["),l=s.length-1;0<=l;l--)s[l]=parseIntArray(s[l].replace(/\[|\]/g,"").split(","));for(;null!==(d=t.exec(e));)o[d[1]]=+d[2];o.loc=a[1],o.ps=s,o.lrun=parseIntArray(n[1].split(",")),controller.settings=o},function(){if(controller.settings&&controller.stations){var e=[],t;for(t=0;t<controller.stations.maxlen;t++)e.push([0,0]);controller.settings.ps=e}}):sendToOS("/jc?pw=").then(function(t){if("object"!=typeof t)try{t=JSON.parse(t)}catch(e){var a=/,"wto":\{.*?\}/,i=t.match(a);t=t.replace(a,"");try{t=JSON.parse(t),handleCorruptedWeatherOptions(i)}catch(t){return!1}}// Update the current coordinates if the user's location is using them
if("undefined"==typeof t.lrun&&(t.lrun=[0,0,0,0]),t.loc.match(regex.gps)){var n=t.loc.split(",");currentCoordinates=[parseFloat(n[0]),parseFloat(n[1])]}controller.settings=t,e()},function(){if(controller.settings&&controller.stations){var e=[],t;for(t=0;t<controller.stations.maxlen;t++)e.push([0,0]);controller.settings.ps=e}})}function updateControllerStationSpecial(e){return e=e||function(){},sendToOS("/je?pw=","json").then(function(t){controller.special=t,e()},function(){controller.special={}})}// Multi site functions
function checkConfigured(e){storage.get(["sites","current_site","cloudToken"],function(t){var a=t.sites,i=t.current_site,n;return a=parseSites(a),n=Object.keys(a),n.length?null!==i&&i in a?void(updateSiteList(n,i),currIp=a[i].os_ip,currPass=a[i].os_pw,currPrefix="undefined"!=typeof a[i].ssl&&"1"===a[i].ssl?"https://":"http://","undefined"!=typeof a[i].auth_user&&"undefined"!=typeof a[i].auth_pw?(currAuth=!0,currAuthUser=a[i].auth_user,currAuthPass=a[i].auth_pw):currAuth=!1,curr183=!!a[i].is183,newLoad()):($.mobile.loading("hide"),void changePage("#site-control",{transition:e?"none":void 0})):void(e&&(void 0===t.cloudToken||null===t.cloudToken?changePage("#start",{transition:"none"}):changePage("#site-control",{transition:"none"})))})}function fixPasswordHash(e){storage.get(["sites"],function(t){var a=parseSites(t.sites);if(!isMD5(currPass)){var i=md5(currPass);sendToOS("/sp?pw=&npw="+encodeURIComponent(i)+"&cpw="+encodeURIComponent(i),"json").done(function(t){var n=t.result;return n&&!(1<n)&&void(a[e].os_pw=currPass=i,storage.set({sites:JSON.stringify(a)},cloudSaveSites))})}})}// Add a new site
function submitNewUser(e,t){document.activeElement.blur(),$.mobile.loading("show");var a=$.mobile.path.parseUrl($("#os_ip").val()).hrefNoHash.replace(/https?:\/\//,""),i=function(i,n){$.mobile.loading("hide");var s;if(("string"==typeof i&&i.match(/var (en|sd)\s*=/)||"number"==typeof i.fwv&&203===i.fwv)&&(s=!0),void 0!==i.fwv||!0===s){var o=$("#os_name").val(),d=$("#os_pw").val(),l=$("#save_pw").is(":checked");""===o&&(o="Site "+(Object.keys(n).length+1)),n[o]={},n[o].os_ip=currIp=a,"number"==typeof i.fwv&&213<=i.fwv&&"number"==typeof i.wl&&(d=md5(d)),n[o].os_pw=l?d:"",currPass=d,e?(n[o].ssl="1",currPrefix="https://"):currPrefix="http://",t?(n[o].auth_user=$("#os_auth_user").val(),n[o].auth_pw=$("#os_auth_pw").val(),currAuth=!0,currAuthUser=n[o].auth_user,currAuthPass=n[o].auth_pw):currAuth=!1,!0==s&&(n[o].is183="1",curr183=!0),$("#os_name,#os_ip,#os_pw,#os_auth_user,#os_auth_pw").val(""),storage.set({sites:JSON.stringify(n),current_site:o},function(){cloudSaveSites(),updateSiteList(Object.keys(n),o),newLoad()})}else showerror(_("Check IP/Port and try again."))},n=function(a){return t||401!==a.status?void(e?($.mobile.loading("hide"),showerror(_("Check IP/Port and try again."))):submitNewUser(!0)):void s()},s=function(){$("#addnew-auth").length?submitNewUser(e,!0):d()},o=function(){return btoa($("#os_auth_user").val()+":"+$("#os_auth_pw").val())},d=function(){$.mobile.loading("hide");var t=$("<div class='ui-content' id='addnew-auth'><form method='post' novalidate><p class='center smaller'>"+_("Authorization Required")+"</p><label for='os_auth_user'>"+_("Username:")+"</label><input autocomplete='off' autocorrect='off' autocapitalize='off' spellcheck='false' type='text' name='os_auth_user' id='os_auth_user'><label for='os_auth_pw'>"+_("Password:")+"</label><input type='password' name='os_auth_pw' id='os_auth_pw'><input type='submit' value='"+_("Submit")+"'></form></div>").enhanceWithin();t.on("submit","form",function(){return submitNewUser(e,!0),!1}),$("#addnew-content").hide(),$("#addnew").append(t).popup("reposition",{positionTo:"window"})},l;return a?!0!==t&&$("#os_useauth").is(":checked")?void s():void(//Submit form data to the server
!0===$("#os_usessl").is(":checked")&&(e=!0),l=e?"https://":"http://",t&&($("#addnew-auth").hide(),$("#addnew-content").show(),$("#addnew").popup("reposition",{positionTo:"window"})),$.ajax({url:l+a+"/jo?pw="+md5($("#os_pw").val()),type:"GET",dataType:"json",timeout:1e4,global:!1,beforeSend:function(e){t&&e.setRequestHeader("Authorization","Basic "+o())},error:function(e){return t||401!==e.status?void $.ajax({url:l+a,type:"GET",dataType:"text",timeout:1e4,global:!1,cache:!0,beforeSend:function(e){t&&e.setRequestHeader("Authorization","Basic "+o())},success:function(e){storage.get("sites",function(t){var a=parseSites(t.sites);i(e,a)})},error:n}):void s()},success:function(e){storage.get("sites",function(t){var a=parseSites(t.sites);i(e,a)})}})):void showerror(_("An IP address is required to continue."))}function parseSites(e){return e===void 0||null===e?{}:JSON.parse(e)}function showSiteSelect(e){$("#site-select").popup("destroy").remove();var t=$("<div data-role='popup' id='site-select' data-theme='a' data-overlay-theme='b'><div data-role='header' data-theme='b'><h1>"+_("Select Site")+"</h1></div><div class='ui-content'><ul data-role='none' class='ui-listview ui-corner-all ui-shadow'></ul></div></div>");e&&t.find("ul").html(e),t.one("popupafterclose",function(){$(this).popup("destroy").remove()}).popup({history:!1,positionTo:"window"}).enhanceWithin().popup("open")}function showAddNew(e,t){$("#addnew").popup("destroy").remove();var a=!!e,i=$("<div data-role='popup' id='addnew' data-theme='a' data-overlay-theme='b'><div data-role='header' data-theme='b'><h1>"+_("New Device")+"</h1></div><div class='ui-content' id='addnew-content'><form method='post' novalidate>"+(a?"":"<p class='center smaller'>"+_("Note: The name is used to identify the OpenSprinkler within the app. OpenSprinkler IP can be either an IP or hostname. You can also specify a port by using IP:Port")+"</p>")+"<label for='os_name'>"+_("Open Sprinkler Name:")+"</label><input autocorrect='off' spellcheck='false' type='text' name='os_name' id='os_name' placeholder='Home'>"+(a?"":"<label for='os_ip'>"+_("Open Sprinkler IP:")+"</label>")+"<input "+(a?"data-role='none' style='display:none' ":"")+"autocomplete='off' autocorrect='off' autocapitalize='off' spellcheck='false' type='url' pattern='' name='os_ip' id='os_ip' value='"+(a?e:"")+"' placeholder='home.dyndns.org'><label for='os_pw'>"+_("Open Sprinkler Password:")+"</label><input type='password' name='os_pw' id='os_pw' value=''><label for='save_pw'>"+_("Save Password")+"</label><input type='checkbox' data-wrapper-class='save_pw' name='save_pw' id='save_pw' data-mini='true' checked='checked'>"+(a?"":"<div data-theme='a' data-mini='true' data-role='collapsible'><h4>"+_("Advanced")+"</h4><fieldset data-role='controlgroup' data-type='horizontal' data-mini='true' class='center'><input type='checkbox' name='os_usessl' id='os_usessl'><label for='os_usessl'>"+_("Use SSL")+"</label><input type='checkbox' name='os_useauth' id='os_useauth'><label for='os_useauth'>"+_("Use Auth")+"</label></fieldset></div>")+"<input type='submit' data-theme='b' value='"+_("Submit")+"'></form></div></div>");return i.find("form").on("submit",function(){return submitNewUser(),!1}),i.one("popupafterclose",function(){$(this).popup("destroy").remove()}).popup({history:!1,positionTo:"window"}).enhanceWithin(),t?$(".ui-popup-active").children().first().one("popupafterclose",function(){i.popup("open")}).popup("close"):i.popup("open"),fixInputClick(i),i.find(".ui-collapsible-heading-toggle").on("click",function(){var e=$(this).parents(".ui-collapsible").hasClass("ui-collapsible-collapsed"),t=$(".ui-page-active"),a=parseInt(t.css("min-height"));e?t.css("min-height",a+65+"px"):t.css("min-height",a-65+"px"),i.popup("reposition",{positionTo:"window"})}),!1}var showSites=function(){function e(){storage.get(["sites","current_site","cloudToken"],function(t){if(o=parseSites(t.sites),$.isEmptyObject(o)){if("string"!=typeof t.cloudToken)return void changePage("#start");n(),a.find(".ui-content").html("<p class='center'>"+_("Please add a site by tapping the 'Add' button in the top right corner.")+"</p>")}else{var s="<div data-role='collapsible-set'>",d=[],r=0;l=Object.keys(o).length,isControllerConnected()&&l&&t.current_site in o||n(),o=sortObj(o),$.each(o,function(e,t){d.push(e),e=htmlEscape(e),s+="<fieldset "+(1===l?"data-collapsed='false'":"")+" id='site-"+r+"' data-role='collapsible'><h3><a class='ui-btn ui-btn-corner-all connectnow yellow' data-site='"+r+"' href='#'>"+_("connect")+"</a>"+e+"</h3><form data-site='"+r+"' novalidate><div class='ui-field-contain'><label for='cnm-"+r+"'>"+_("Change Name")+"</label><input id='cnm-"+r+"' type='text' value='"+e+"'></div><div class='ui-field-contain'><label for='cip-"+r+"'>"+_("Change IP")+"</label><input id='cip-"+r+"' type='url' value='"+t.os_ip+"' autocomplete='off' autocorrect='off' autocapitalize='off' pattern='' spellcheck='false'></div><div class='ui-field-contain'><label for='cpw-"+r+"'>"+_("Change Password")+"</label><input id='cpw-"+r+"' type='password'></div><fieldset data-mini='true' data-role='collapsible'><h3><span style='line-height:23px'>"+_("Advanced")+"</span><button data-helptext='"+_("These options are only for an OpenSprinkler behind a proxy capable of SSL and/or Basic Authentication.")+"' class='collapsible-button-right help-icon btn-no-border ui-btn ui-icon-info ui-btn-icon-notext'></button></h3><label for='usessl-"+r+"'><input data-mini='true' type='checkbox' id='usessl-"+r+"' name='usessl-"+r+"'"+("undefined"!=typeof t.ssl&&"1"===t.ssl?" checked='checked'":"")+">"+_("Use SSL")+"</label><label for='useauth-"+r+"'><input class='useauth' data-user='"+t.auth_user+"' data-pw='"+t.auth_pw+"' data-mini='true' type='checkbox' id='useauth-"+r+"' name='useauth-"+r+"'"+("undefined"!=typeof t.auth_user&&"undefined"!=typeof t.auth_pw?" checked='checked'":"")+">"+_("Use Auth")+"</label></fieldset><input class='submit' type='submit' value='"+_("Save Changes to")+" "+e+"'><a data-role='button' class='deletesite' data-site='"+r+"' href='#' data-theme='b'>"+_("Delete")+" "+e+"</a></form></fieldset>",testSite(t,r,function(e,t){a.find("#site-"+e+" .connectnow").removeClass("yellow").addClass(t?"green":"red")}),r++}),s=$(s+"</div>"),s.find("form").one("change input",function(){$(this).find(".submit").addClass("hasChanges")}),s.find(".connectnow").on("click",function(){return updateSite(d[$(this).data("site")]),!1}),s.find(".help-icon").on("click",showHelpText),s.find(".useauth").on("change",function(){var e=$(this);if(e.is(":checked")){var t=$("<div data-role='popup' data-theme='a'><form method='post' class='ui-content' novalidate><label for='auth_user'>"+_("Username:")+"</label><input autocomplete='off' autocorrect='off' autocapitalize='off' spellcheck='false' type='text' name='auth_user' id='auth_user'><label for='auth_pw'>"+_("Password:")+"</label><input type='password' name='auth_pw' id='auth_pw'><input type='submit' class='submit' value='"+_("Submit")+"'></form></div>").enhanceWithin(),a=!1;t.find(".submit").on("click",function(){return e.data({user:t.find("#auth_user").val(),pw:t.find("#auth_pw").val()}),a=!0,t.popup("close"),!1}),t.one("popupafterclose",function(){a||e.attr("checked",!1).checkboxradio("refresh")}),openPopup(t)}else e.data({user:"",pw:""})}),s.find("form").on("submit",function(){var a=$(this),i=a.data("site"),n=d[i],l=s.find("#cip-"+i).val(),r=s.find("#cpw-"+i).val(),c=s.find("#cnm-"+i).val(),p=s.find("#useauth-"+i).is(":checked"),u=s.find("#usessl-"+i).is(":checked")?"1":void 0,m=s.find("#useauth-"+i).data("user"),h=s.find("#useauth-"+i).data("pw"),b=""!==l&&l!==o[n].os_ip||u!==o[n].ssl||m!==o[n].auth_user||h!==o[n].auth_pw,g=n===t.current_site,f=""!==c&&c!==n;return a.find(".submit").removeClass("hasChanges"),p?(o[n].auth_user=m,o[n].auth_pw=h):(delete o[n].auth_user,delete o[n].auth_pw),"1"===u?o[n].ssl=u:delete o[n].ssl,""!==l&&l!==o[n].os_ip&&(o[n].os_ip=l),""!==r&&r!==o[n].os_pw&&(isMD5(o[n].os_pw)&&(r=md5(r)),o[n].os_pw=r),f&&(o[c]=o[n],delete o[n],n=c,g&&(storage.set({current_site:n}),t.current_site=n),updateSiteList(Object.keys(o),t.current_site)),storage.set({sites:JSON.stringify(o)},cloudSaveSites),showerror(_("Site updated successfully")),n===t.current_site&&(""!==r&&(currPass=r),b&&checkConfigured()),f&&!a.find(".submit").hasClass("preventUpdate")&&e(),!1}),s.find(".deletesite").on("click",function(){var a=d[$(this).data("site")];return $("#site-selector").val()===a&&n(),delete o[a],storage.set({sites:JSON.stringify(o)},function(){return cloudSaveSites(),updateSiteList(Object.keys(o),t.current_site),$.isEmptyObject(o)?storage.get("cloudToken",function(){if(null===t.cloudToken||void 0===t.cloudToken)return currIp="",currPass="",void changePage("#start")}):(e(),showerror(_("Site deleted successfully"))),!1}),!1}),a.find(".ui-content").html(s.enhanceWithin())}"string"==typeof t.cloudToken&&a.find(".ui-content").prepend(addSyncStatus(t.cloudToken))})}function t(){d=changeHeader({title:_("Manage Sites"),animate:!!isControllerConnected(),leftBtn:{icon:"carat-l",text:_("Back"),class:"ui-toolbar-back-btn",on:function(){a.find(".hasChanges").addClass("preventUpdate"),checkChangesBeforeBack()}},rightBtn:{icon:"plus",text:_("Add"),on:function(){"undefined"==typeof deviceip?showAddNew():s.popup("open").popup("reposition",{positionTo:d.eq(2)})}}}),e(),$.mobile.pageContainer.append(s),s.popup({history:!1,positionTo:d.eq(2)}).enhanceWithin(),$("#site-control").remove(),$.mobile.pageContainer.append(a)}var a=$("<div data-role='page' id='site-control'><div class='ui-content'></div></div>"),n=function(){var t=function(){d.eq(0).hide(),$("#header").show(),$("#footer, #footer-menu").hide()};a.hasClass("ui-page-active")?t():a.one("pagebeforeshow",function(a){a.stopImmediatePropagation(),t()}),a.on("swiperight swipeleft",function(t){t.stopImmediatePropagation()}),document.title="OpenSprinkler"},s=$("<div data-role='popup' id='addsite' data-theme='b'><ul data-role='listview'><li data-icon='false'><a href='#' id='site-add-scan'>"+_("Scan For Device")+"</a></li><li data-icon='false'><a href='#' id='site-add-manual'>"+_("Manually Add Device")+"</a></li></ul></div>"),o,d,l;return s.find("#site-add-scan").on("click",function(){return s.popup("close"),startScan(),!1}),s.find("#site-add-manual").on("click",function(){return showAddNew(!1,!0),!1}),a.on("pagehide",function(){s.popup("destroy").detach(),a.detach()}),$("html").on("siterefresh",function(){a.hasClass("ui-page-active")&&e()}),t}();function addSyncStatus(e){var t=$("<div class='ui-bar smaller ui-bar-a ui-corner-all logged-in-alert'><div class='inline ui-btn ui-icon-recycle btn-no-border ui-btn-icon-notext ui-mini'></div><div class='inline syncStatus'>"+_("Synced with OpenSprinkler.com")+" ("+getTokenUser(e)+")</div><div class='inline ui-btn ui-icon-delete btn-no-border ui-btn-icon-notext ui-mini logout'></div></div>");return t.find(".logout").on("click",logout),t.find(".ui-icon-recycle").on("click",function(){var e=$(this);e.addClass("spin"),cloudSync(function(){e.removeClass("spin")})}),t}function testSite(e,t,a){$.ajax({url:("1"===e.ssl?"https://":"http://")+e.os_ip+"/jo?pw="+encodeURIComponent(e.os_pw),type:"GET",dataType:"json",beforeSend:function(t){"undefined"!=typeof e.auth_user&&"undefined"!=typeof e.auth_pw&&t.setRequestHeader("Authorization","Basic "+btoa(e.auth_user+":"+e.auth_pw))}}).then(function(){a(t,!0)},function(){a(t,!1)})}// Update the panel list of sites
function updateSiteList(e,t){var a="",i=$("#site-selector");$.each(e,function(){a+="<option "+(this.toString()===t?"selected ":"")+"value='"+htmlEscape(this)+"'>"+this+"</option>"}),$("#info-list").find("li[data-role='list-divider']").text(t),i.html(a),i.parent().parent().hasClass("ui-select")&&i.selectmenu("refresh")}// Change the current site
function updateSite(e){storage.get("sites",function(t){var a=parseSites(t.sites);e in a&&closePanel(function(){storage.set({current_site:e},checkConfigured)})})}function findLocalSiteName(e,t){for(var a in e)if(e.hasOwnProperty(a)&&-1!==currIp.indexOf(e[a].os_ip))return void t(a);t(!1)}// Automatic device detection functions
function updateDeviceIP(e){var t=function(t){deviceip=t,"function"==typeof e&&e(t)},a;if(isChromeApp)chrome.system.network.getNetworkInterfaces(function(e){for(var n in e)e.hasOwnProperty(n)&&/^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$/.test(e[n].address)&&(a=e[n].address);t(a)});else try{networkinterface.getWiFiIPAddress(function(e){a=e.ip,t(a)})}catch(e){findRouter(function(e,a){t(e?a:void 0)})}}function isLocalIP(e){var t=parseIntArray(e.split("."));// Check if the IP is on a private network, if not don't enable automatic scanning
return 10===t[0]||127===t[0]||172===t[0]&&17<t[1]&&32>t[1]||192===t[0]&&168===t[1]}function startScan(e,t){/*
		The type represents the OpenSprinkler model as defined below
		0 - OpenSprinkler using firmware 2.0+
		1 - OpenSprinkler Pi (Python) using 1.9+
		2 - OpenSprinkler using firmware 1.8.3
		3 - OpenSprinkler Pi (Python) using 1.8.3
	*/var a=deviceip.split("."),n=1,s=0,o="",d="",l=[],r=!1,c,p,u,m,h,b,g,f,v;// Start scan
for(t=t||0,e="number"==typeof e?e:80,storage.get("sites",function(e){var t=parseSites(e.sites),a;for(a in t)t.hasOwnProperty(a)&&l.push(t[a].os_ip)}),u=function(){n++},m=function(e){n++;var t=$.mobile.path.parseUrl(this.url).authority,a,i;if(-1===$.inArray(t,l)){if("text"===this.dataType){if(i=e.match(/var\s*ver=(\d+)/),!i)return;a=i[1]}else{if(!e.hasOwnProperty("fwv"))return;a=e.fwv}s++,o+="<li><a class='ui-btn ui-btn-icon-right ui-icon-carat-r' href='#' data-ip='"+t+"'>"+t+"<p>"+_("Firmware")+": "+getOSVersion(a)+"</p></a></li>"}},b=function(){return!0==r?($.mobile.loading("hide"),clearInterval(g),!1):void(245==n&&($.mobile.loading("hide"),clearInterval(g),s?(o=$(o),o.find("a").on("click",function(){return addFound($(this).data("ip")),!1}),showSiteSelect(o)):0===t?startScan(8080,1):1===t?startScan(80,2):2===t?startScan(8080,3):showerror(_("No new devices were detected on your network"))))},a.pop(),h=a.join("."),0===t?v=_("Scanning for OpenSprinkler"):1===t?v=_("Scanning for OpenSprinkler Pi"):2===t?v=_("Scanning for OpenSprinkler (1.8.3)"):3===t&&(v=_("Scanning for OpenSprinkler Pi (1.8.3)")),$.mobile.loading("show",{html:"<h1>"+v+"</h1><p class='cancel tight center inline-icon'><span class='btn-no-border ui-btn ui-icon-delete ui-btn-icon-notext'></span>"+_("Cancel")+"</p>",textVisible:!0,theme:"b"}),$(".ui-loader").find(".cancel").one("click",function(){r=!0}),c=1;244>=c;c++)a=h+"."+c,2>t?(d="/jo",f="json"):f="text",p="http://"+a+(e&&80!==e?":"+e:"")+d,$.ajax({url:p,type:"GET",dataType:f,timeout:6e3,global:!1,error:u,success:m});g=setInterval(b,200)}function findRouter(e){e=e||function(){};var t=["192.168.1.1","10.0.1.1","192.168.1.220","192.168.2.1","10.1.1.1","192.168.11.1","192.168.0.1","192.168.0.30","192.168.0.50","192.168.10.1","192.168.20.1","192.168.30.1","192.168.62.1","192.168.102.1","192.168.1.254","192.168.0.227","10.0.0.138","192.168.123.254","192.168.4.1","10.0.0.2","10.0.2.1","10.0.3.1","10.0.4.1","10.0.5.1"],a=t.length,n=0,s=function(e,t){n++,!0===e&&(l=t)},o=function(){(n===a||"string"==typeof l)&&(clearInterval(d),"string"==typeof l?e(!0,l):e(!1))},d,l,r;for(r=0;r<a;r++)"string"!=typeof l&&ping(t[r],s);d=setInterval(o,50)}function ping(t,a){a=a||function(){},t&&""!==t||a(!1),$.ajax({url:"http://"+t,type:"GET",timeout:6e3,global:!1}).then(function(){a(!0,t)},function(i){"timeout"===i.statusText?a(!1):a(!0,t)})}// Show popup for new device after populating device IP with selected result
function addFound(e){$("#site-select").one("popupafterclose",function(){showAddNew(e)}).popup("close")}// Weather functions
function showZimmermanAdjustmentOptions(e,t){var a=Math.round;$(".ui-popup-active").find("[data-role='popup']").popup("close");// Sensitivity and baseline values for Humidity, Temp and Rainfall for Zimmerman adjustment
var i=$.extend({},{h:100,t:100,r:100,bh:30,bt:70,br:0},unescapeJSON(e.value)),// Enable Zimmerman extension to set weather conditions as baseline for adjustment
n=checkOSVersion(2162);// OSPi stores in imperial so convert to metric and adjust to nearest 1/10ths of a degree and mm
isMetric&&(i.bt=a(10*(5*(i.bt-32)/9))/10,i.br=a(10*(25.4*i.br))/10);var s=$("<div data-role='popup' data-theme='a' id='adjustmentOptions'><div data-role='header' data-theme='b'><h1>"+_("Weather Adjustment Options")+"</h1></div><div class='ui-content'><p class='rain-desc center smaller'>"+_("Set the baseline weather conditions for your location. ")+_("The Zimmerman method will adjust the watering duration based on differences from this reference point.")+"</p><div class='ui-grid-b'><div class='ui-block-a'><label class='center'>"+_("Temp")+(isMetric?" &#176;C":" &#176;F")+"</label><input data-wrapper-class='pad_buttons' class='bt' type='number' "+(isMetric?"min='-20' max='50'":"min='0' max='120'")+" value='"+i.bt+(n?"'>":"' disabled='disabled'>")+"</div><div class='ui-block-b'><label class='center'>"+_("Rain")+(isMetric?" mm":" \"")+"</label><input data-wrapper-class='pad_buttons' class='br' type='number' "+(isMetric?"min='0' max='25' step='0.1'":"min='0' max='1' step='0.01'")+" value='"+i.br+(n?"'>":"' disabled='disabled'>")+"</div><div class='ui-block-c'><label class='center'>"+_("Humidity")+" %</label><input data-wrapper-class='pad_buttons' class='bh' type='number'  min='0' max='100' value='"+i.bh+(n?"'>":"' disabled='disabled'>")+"</div></div><p class='rain-desc center smaller'>"+_("Set the sensitivity of the watering adjustment to changes in each of the above weather conditions.")+"</p><span><fieldset class='ui-grid-b incr'><div class='ui-block-a'><a href='#' data-role='button' data-mini='true' data-corners='true' data-icon='plus' data-iconpos='bottom'></a></div><div class='ui-block-b'><a href='#' data-role='button' data-mini='true' data-corners='true' data-icon='plus' data-iconpos='bottom'></a></div><div class='ui-block-c'><a href='#' data-role='button' data-mini='true' data-corners='true' data-icon='plus' data-iconpos='bottom'></a></div></fieldset><div class='ui-grid-b inputs'><div class='ui-block-a'><input data-wrapper-class='pad_buttons' class='t' type='number' min='0' max='100' value='"+i.t+"'></div><div class='ui-block-b'><input data-wrapper-class='pad_buttons' class='r' type='number'  min='0' max='100' value='"+i.r+"'></div><div class='ui-block-c'><input data-wrapper-class='pad_buttons' class='h' type='number'  min='0' max='100' value='"+i.h+"'></div></div><fieldset class='ui-grid-b decr'><div class='ui-block-a'><a href='#' data-role='button' data-mini='true' data-corners='true' data-icon='minus' data-iconpos='bottom'></a></div><div class='ui-block-b'><a href='#' data-role='button' data-mini='true' data-corners='true' data-icon='minus' data-iconpos='bottom'></a></div><div class='ui-block-c'><a href='#' data-role='button' data-mini='true' data-corners='true' data-icon='minus' data-iconpos='bottom'></a></div></fieldset></span><button class='submit' data-theme='b'>"+_("Submit")+"</button></div></div>"),o=function(e,t){var a=s.find(".inputs input").eq(e),i=parseInt(a.val());-1===t&&0===i||1===t&&100===i||a.val(i+t)};s.find(".submit").on("click",function(){var i={h:parseInt(s.find(".h").val()),t:parseInt(s.find(".t").val()),r:parseInt(s.find(".r").val())};return n&&($.extend(i,{bh:parseInt(s.find(".bh").val()),bt:parseFloat(s.find(".bt").val()),br:parseFloat(s.find(".br").val())}),isMetric&&(i.bt=a(100*(9*i.bt/5+32))/100,i.br=a(1e3*(i.br/25.4))/1e3)),e&&(e.value=escapeJSON(i)),t(),s.popup("close"),!1}),s.on("focus","input[type='number']",function(){this.value=""}).on("blur","input[type='number']",function(){// Generic min/max checker for Temp/Rain/Hum baseline as well as 0-100%
var e=parseFloat(this.min),t=parseFloat(this.max);""===this.value&&(this.value="0"),(this.value<e||this.value>t)&&(this.value=this.value<e?e:t)}),holdButton(s.find(".incr").children(),function(t){var e=$(t.currentTarget).index();return o(e,1),!1}),holdButton(s.find(".decr").children(),function(t){var e=$(t.currentTarget).index();return o(e,-1),!1}),$("#adjustmentOptions").remove(),s.css("max-width","380px"),openPopup(s,{positionTo:"window"})}function showAutoRainDelayAdjustmentOptions(e,t){$(".ui-popup-active").find("[data-role='popup']").popup("close");var a=$.extend({},{d:24},unescapeJSON(e.value)),i=$("<div data-role='popup' data-theme='a' id='adjustmentOptions'><div data-role='header' data-theme='b'><h1>"+_("Weather Adjustment Options")+"</h1></div><div class='ui-content'><p class='rain-desc center smaller'>"+_("If the weather reports any condition suggesting rain, a rain delay is automatically issued using the below set delay duration.")+"</p><label class='center' for='delay_duration'>"+_("Delay Duration (hours)")+"</label><div class='input_with_buttons'><button class='decr ui-btn ui-btn-icon-notext ui-icon-carat-l btn-no-border'></button><input id='delay_duration' type='number' pattern='[0-9]*' value='"+a.d+"'><button class='incr ui-btn ui-btn-icon-notext ui-icon-carat-r btn-no-border'></button></div><button class='submit' data-theme='b'>"+_("Submit")+"</button></div></div>"),n=function(e){var t=i.find("#delay_duration"),a=parseInt(t.val());-1===e&&0===a||1===e&&8760===a||t.val(a+e)};i.find(".submit").on("click",function(){return a={d:parseInt(i.find("#delay_duration").val())},e&&(e.value=escapeJSON(a)),t(),i.popup("close"),!1}),i.on("focus","input[type='number']",function(){this.value=""}).on("blur","input[type='number']",function(){(""===this.value||0>parseInt(this.value))&&(this.value="0")}),holdButton(i.find(".incr"),function(){return n(1),!1}),holdButton(i.find(".decr"),function(){return n(-1),!1}),$("#adjustmentOptions").remove(),i.css("max-width","380px"),openPopup(i,{positionTo:"window"})}// Validates a Weather Underground location to verify it contains the data needed for Weather Adjustments
function validateWULocation(e,t){controller.settings.wto&&"string"==typeof controller.settings.wto.key&&""!==controller.settings.wto.key||t(!1),$.ajax({url:"https://api.weather.com/v2/pws/observations/hourly/7day?stationId="+e+"&format=json&units=e&apiKey="+controller.settings.wto.key,cache:!0}).done(function(e){return!e||e.errors?void t(!1):void t(!0)}).fail(function(){t(!1)})}function showEToAdjustmentOptions(e,t){var a=Math.round;$(".ui-popup-active").find("[data-role='popup']").popup("close");// Elevation and baseline ETo for ETo adjustment.
var i=$.extend({},{baseETo:0,elevation:600},controller.settings.wto);isMetric&&(i.baseETo=a(10*(25.4*i.baseETo))/10,i.elevation=a(i.elevation/3.28));var n=$("<div data-role='popup' data-theme='a' id='adjustmentOptions'><div data-role='header' data-theme='b'><h1>"+_("Weather Adjustment Options")+"</h1></div><div class='ui-content'><p class='rain-desc center smaller'>"+_("Set the baseline potential evapotranspiration (ETo) and elevation for your location. ")+_("The ETo adjustment method will adjust the watering duration based on the difference between the baseline ETo and the current ETo.")+"</p><div class='ui-grid-a'><div class='ui-block-a'><label class='center'>"+_("Baseline ETo")+(isMetric?" (mm":"(in")+"/day)</label><input data-wrapper-class='pad_buttons' class='baseline-ETo' type='number' min='0' "+(isMetric?"max='25' step='0.1'":"max='1' step='0.01'")+" value='"+i.baseETo+"'></div><div class='ui-block-b'><label class='center'>"+_("Elevation")+(isMetric?" (m)":" (ft)")+"</label><input data-wrapper-class='pad_buttons' class='elevation' type='number' step='1'"+(isMetric?"min='-400' max='9000'":"min='-1400' max='30000'")+" value='"+i.elevation+"'></div></div><button class='detect-baseline-eto'>"+_("Detect baseline ETo")+"</button><button class='submit' data-theme='b'>"+_("Submit")+"</button></div></div>");n.find(".submit").on("click",function(){return i={baseETo:parseFloat(n.find(".baseline-ETo").val()),elevation:parseInt(n.find(".elevation").val())},isMetric&&(i.baseETo=a(100*(i.baseETo/25.4))/100,i.elevation=a(3.28*i.elevation)),e&&(e.value=escapeJSON(i)),t(),n.popup("close"),!1}),n.find(".detect-baseline-eto").on("click",function(){// Backup button contents so it can be restored after the request is completed.
var e=$(".detect-baseline-eto").html();return showLoading(".detect-baseline-eto"),$.ajax({url:WEATHER_SERVER_URL+"/baselineETo?loc="+encodeURIComponent(controller.settings.loc),contentType:"application/json; charset=utf-8",success:function(e){var t=e.eto;// Convert to metric if necessary.
isMetric&&(t=a(100*(25.4*t))/100),$(".baseline-ETo").val(t),window.alert("Detected baseline ETo for configured location is "+t+(isMetric?"mm":"in")+"/day")},error:function(e,t){// Use the response body for HTTP errors and the error type for JQuery errors.
var a="Unable to detect baseline ETo: "+(e.status?e.responseText+"("+e.status+")":t);window.alert(a),window.console.error(a)},complete:function(){$(".detect-baseline-eto").html(e)}}),!1}),n.on("focus","input[type='number']",function(){this.value=""}).on("blur","input[type='number']",function(){// Generic min/max checker for each option.
var e=parseFloat(this.min),t=parseFloat(this.max);""===this.value&&(this.value="0"),(this.value<e||this.value>t)&&(this.value=this.value<e?e:t)}),$("#adjustmentOptions").remove(),n.css("max-width","380px"),openPopup(n,{positionTo:"window"})}function formatTemp(e){var t=Math.round;return e=isMetric?t(10*((e-32)*(5/9)))/10+" &#176;C":t(10*e)/10+" &#176;F",e}function formatPrecip(e){var t=Math.round;return e=isMetric?t(10*(25.4*e))/10+" mm":t(100*e)/100+" in",e}function formatHumidity(e){return Math.round(e)+" %"}function formatSpeed(e){var t=Math.round;return e=isMetric?t(10*(1.6*e))/10+" km/h":t(10*e)/10+" mph",e}function hideWeather(){$("#weather").empty().parents(".info-card").addClass("noweather")}function finishWeatherUpdate(){updateWeatherBox(),$.mobile.document.trigger("weatherUpdateComplete")}function updateWeather(){var e=new Date().getTime();if(weather&&weather.providedLocation===controller.settings.loc&&360000>e-weather.lastUpdated)return void finishWeatherUpdate();if(localStorage.weatherData)try{var t=JSON.parse(localStorage.weatherData);if(t.providedLocation===controller.settings.loc&&360000>e-t.lastUpdated)return weather=t,void finishWeatherUpdate()}catch(e){}return weather=void 0,""===controller.settings.loc?void hideWeather():void(showLoading("#weather"),$.ajax({url:WEATHER_SERVER_URL+"/weatherData?loc="+encodeURIComponent(controller.settings.loc),contentType:"application/json; charset=utf-8",success:function(e){// Hide the weather if no data is returned
return"object"==typeof e?void(currentCoordinates=e.location,weather=e,e.lastUpdated=new Date().getTime(),e.providedLocation=controller.settings.loc,localStorage.weatherData=JSON.stringify(e),finishWeatherUpdate()):void hideWeather()}}))}function checkURLandUpdateWeather(){var e=function(e){WEATHER_SERVER_URL=e?currPrefix+e:DEFAULT_WEATHER_SERVER_URL,updateWeather()};return controller.settings.wsp?"weather.opensprinkler.com"===controller.settings.wsp?void e():void e(controller.settings.wsp):$.get(currPrefix+currIp+"/su").then(function(t){var a=t.match(/value="([\w|:|/|.]+)" name=wsp/);e(a?a[1]:void 0)})}function updateWeatherBox(){$("#weather").html("<div title='"+weather.description+"' class='wicon'><img src='http://openweathermap.org/img/w/"+weather.icon+".png'></div><div class='inline tight'>"+formatTemp(weather.temp)+"</div><br><div class='inline location tight'>"+_("Current Weather")+"</div>"+("object"==typeof weather.alert?"<div><button class='tight help-icon btn-no-border ui-btn ui-icon-alert ui-btn-icon-notext ui-corner-all'></button>"+weather.alert.type+"</div>":"")).off("click").on("click",function(){return changePage("#forecast"),!1}).parents(".info-card").removeClass("noweather")}function coordsToLocation(e,t,a,i){i=i||e+","+t,$.getJSON("https://maps.googleapis.com/maps/api/geocode/json?latlng="+e+","+t+"&key=AIzaSyDaT_HTZwFojXmvYIhwWudK00vFXzMmOKc&result_type=locality|sublocality|administrative_area_level_1|country",function(e){if(0===e.results.length)return void a(i);e=e.results,i=e[0].formatted_address;var t=!1;for(var n in e)if(e.hasOwnProperty(n)&&(-1<$.inArray("locality",e[n].types)||-1<$.inArray("sublocality",e[n].types)||-1<$.inArray("postal_code",e[n].types)||-1<$.inArray("street_address",e[n].types))){t=!0;break}if(!1==t)return void a(i);e=e[n].address_components;var s="",o="";for(n in t=!1,e)e.hasOwnProperty(n)&&!t&&(""===s&&-1<$.inArray("locality",e[n].types)&&(s=e[n].long_name+", "+s),""===s&&-1<$.inArray("sublocality",e[n].types)&&(s=e[n].long_name+", "+s),-1<$.inArray("administrative_area_level_1",e[n].types)&&(s+=e[n].long_name,t=!0),-1<$.inArray("country",e[n].types)&&(o=e[n].long_name));t||(s+=o),a(s)})}function getSunTimes(e){e=e||new Date(1e3*controller.settings.devt);var t=SunCalc.getTimes(e,currentCoordinates[0],currentCoordinates[1]),a=t.sunrise,i=t.sunset,n=getTimezoneOffset();return a.setUTCMinutes(a.getUTCMinutes()+n),i.setUTCMinutes(i.getUTCMinutes()+n),a=60*a.getUTCHours()+a.getUTCMinutes(),i=60*i.getUTCHours()+i.getUTCMinutes(),[a,i]}function makeAttribution(e){if("string"!=typeof e)return"";var t="<div class='weatherAttribution'>";switch(e){case"DarkSky":t+="<a href='https://darksky.net/poweredby/' target='_blank'>"+_("Powered by Dark Sky")+"</a>";break;case"OWM":t+="<a href='https://openweathermap.org/' target='_blank'>"+_("Powered by OpenWeather")+"</a>";break;case"WUnderground":t+="<a href='https://wunderground.com/' target='_blank'>"+_("Powered by Weather Underground")+"</a>";break;case"local":t+=_("Powered by your Local PWS");break;case"Manual":t+=_("Using manual watering");break;default:t+=_("Unrecognised weather provider");}return t+"</div>"}function showForecast(){var e=$("<div data-role='page' id='forecast'><div class='ui-content' role='main'><ul data-role='listview' data-inset='true'>"+makeForecast()+"</ul>"+makeAttribution(weather.weatherProvider)+"</div></div>");changeHeader({title:_("Forecast"),leftBtn:{icon:"carat-l",text:_("Back"),class:"ui-toolbar-back-btn",on:goBack},rightBtn:{icon:"refresh",text:_("Refresh"),on:function(){$.mobile.loading("show"),$.mobile.document.one("weatherUpdateComplete",function(){$.mobile.loading("hide")}),updateWeather()}}}),e.one("pagehide",function(){e.remove()}),e.find(".alert").on("click",function(){openPopup($("<div data-role='popup' data-theme='a'><div data-role='header' data-theme='b'><h1>"+weather.alert.name+"</h1></div><div class='ui-content'><span style='white-space: pre-wrap'>"+$.trim(weather.alert.message)+"</span></div></div>"))}),$("#forecast").remove(),$.mobile.pageContainer.append(e)}function makeForecast(){var e="",t=controller.settings.sunrise?controller.settings.sunrise:getSunTimes()[0],a=controller.settings.sunset?controller.settings.sunset:getSunTimes()[1],n=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],s,o,d;for(e+="<li data-icon='false' class='center'><div>"+_("Now")+"</div><br><div title='"+weather.description+"' class='wicon'><img src='http://openweathermap.org/img/w/"+weather.icon+".png'></div><span>"+formatTemp(weather.temp)+"</span><br><span>"+_("Sunrise")+"</span><span>: "+pad(parseInt(t/60)%24)+":"+pad(t%60)+"</span> <span>"+_("Sunset")+"</span><span>: "+pad(parseInt(a/60)%24)+":"+pad(a%60)+"</span></li>",s=1;s<weather.forecast.length;s++)o=new Date(1e3*weather.forecast[s].date),d=getSunTimes(o),t=d[0],a=d[1],e+="<li data-icon='false' class='center'><div>"+o.toLocaleDateString()+"</div><br><div title='"+weather.forecast[s].description+"' class='wicon'><img src='http://openweathermap.org/img/w/"+weather.forecast[s].icon+".png'></div><span>"+_(n[o.getDay()])+"</span><br><span>"+_("Low")+"</span><span>: "+formatTemp(weather.forecast[s].temp_min)+"  </span><span>"+_("High")+"</span><span>: "+formatTemp(weather.forecast[s].temp_max)+"</span><br><span>"+_("Sunrise")+"</span><span>: "+pad(parseInt(t/60)%24)+":"+pad(t%60)+"</span> <span>"+_("Sunset")+"</span><span>: "+pad(parseInt(a/60)%24)+":"+pad(a%60)+"</span></li>";return e}function overlayMap(e){$("#location-list").popup("destroy").remove(),$.mobile.loading("show"),e=e||function(){};var t=$("<div data-role='popup' id='location-list' data-theme='a' style='background-color:rgb(229, 227, 223);'><a href='#' data-rel='back' class='ui-btn ui-corner-all ui-shadow ui-btn-b ui-icon-delete ui-btn-icon-notext ui-btn-right'>"+_("Close")+"</a><iframe style='border:none' src='"+getAppURLPath()+"map.html' width='100%' height='100%' seamless=''></iframe></div>"),a=function(e){e=e||function(e){e&&n.get(0).contentWindow.postMessage({type:"currentLocation",payload:{lat:e.coords.latitude,lon:e.coords.longitude}},"*")};var t=function(t){clearTimeout(a),$.mobile.loading("hide"),t||showerror(_("Unable to retrieve your current location")),e(t)},a;try{a=setTimeout(function(){$.mobile.loading("show",{html:"<div class='logo'></div><h1 style='padding-top:5px'>"+_("Attempting to retrieve your current location")+"</h1></p>",textVisible:!0,theme:"b"})},100),navigator.geolocation.getCurrentPosition(function(e){clearTimeout(a),t(e)},function(){t(!1)},{timeout:1e4})}catch(e){t(!1)}},i=function(e,t){var a=$("#wtkey").val();""===a||$.ajax({url:"https://api.weather.com/v3/location/near?format=json&product=pws&apiKey="+a+"&geocode="+encodeURIComponent(e)+","+encodeURIComponent(t),cache:!0}).done(function(e){var t=[];e.location.stationId.forEach(function(a,i){t.push({id:a,lat:e.location.latitude[i],lon:e.location.longitude[i],message:e.location.stationId[i]})}),0<t.length&&(t=encodeURIComponent(JSON.stringify(t)),n.get(0).contentWindow.postMessage({type:"pwsData",payload:t},"*"))})},n=t.find("iframe"),s=$("#loc").val(),o={lat:s.match(regex.gps)?s.split(",")[0]:currentCoordinates[0],lon:s.match(regex.gps)?s.split(",")[1]:currentCoordinates[1]},d=!1;// Wire in listener for communication from iframe
$.mobile.window.off("message onmessage").on("message onmessage",function(n){var s=n.originalEvent.data;if("undefined"!=typeof s.WS){var o=s.WS.split(",");e(1<o.length?o:s.WS,s.station),d=!0,t.popup("destroy").remove()}else!0===s.loaded?$.mobile.loading("hide"):"object"==typeof s.location?i(s.location[0],s.location[1]):!0===s.dismissKeyboard?document.activeElement.blur():!0===s.getLocation&&a()}),n.one("load",function(){0===o.lat&&0===o.lon&&a(),this.contentWindow.postMessage({type:"startLocation",payload:{start:o}},"*")}),t.one("popupafterclose",function(){!1==d&&e(!1)}),openPopup(t,{beforeposition:function(){t.css({width:window.innerWidth-36,height:window.innerHeight-28})},x:0,y:0}),i(o.lat,o.lon)}// Ensure error codes align with reboot causes in Firmware defines.h
var rebootReasons={0:_("None"),1:_("Factory Reset"),2:_("Reset Button"),3:_("WiFi Change"),4:_("Web Request"),5:_("Web Request"),6:_("WiFi Configure"),7:_("Firmware Update"),8:_("Weather Failure"),9:_("Network Failure"),10:_("Clock Update"),99:_("Power On")},weatherErrors={"-4":_("Empty Response"),"-3":_("Timed Out"),"-2":_("Connection Failed"),"-1":_("No Response"),0:_("Success"),1:_("Weather Data Error"),10:_("Building Weather History"),11:_("Weather Provider Respnse Incomplete"),12:_("Weather Provider Request Failed"),2:_("Location Error"),20:_("Location Request Error"),21:_("Location Not Found"),22:_("Invalid Location Format"),3:_("PWS Error"),30:_("Invalid WUnderground PWS"),31:_("Invalid WUnderground Key"),32:_("WUnderground Authentication Error"),33:_("Unsupported WUnderground Method"),34:_("No WUnderground PWS Provided"),4:_("Adjustment Method Error"),40:_("Unsupported Adjustment Method"),41:_("No Adjustment Method Provided"),5:_("Adjustment Options Error"),50:_("Corrupt Adjustment Options"),51:_("Missing Adjustment Option"),99:_("Unexpected Error")};// Ensure error codes align with App errors.ts (codes > 0) and HTTP error codes in Firmware defines.h (codes < 0)
function getRebootReason(e){return e in rebootReasons?rebootReasons[e]:_("Unrecognised")+" ("+e+")"}function getWeatherError(e){var t=Math.floor(e/10);if(e in weatherErrors)return weatherErrors[e];return 59>=e&&10<=e&&t in weatherErrors?weatherErrors[t]:_("Unrecognised")+" ("+e+")"}function getWeatherStatus(e){return 0>e?"<font class='debugWUError'>"+_("Offline")+"</font>":0<e?"<font class='debugWUError'>"+_("Error")+"</font>":"<font class='debugWUOK'>"+_("Online")+"</font>"}function getWiFiRating(e){return-80>e?_("Unuseable"):-70>e?_("Poor"):-60>e?_("Fair"):-50>e?_("Good"):_("Excellent")}function debugWU(){var e="<div data-role='popup' id='debugWU' class='ui-content ui-page-theme-a'>";return e+="<div class='debugWUHeading'>System Status</div><table class='debugWUTable'>"+("number"==typeof controller.settings.lupt?"<tr><td>"+_("Last Reboot")+"</td><td>"+(1e3>controller.settings.lupt?"--":dateToString(new Date(1e3*controller.settings.lupt),null,2))+"</td></tr>":"")+("number"==typeof controller.settings.lrbtc?"<tr><td>"+_("Reboot Reason")+"</td><td>"+getRebootReason(controller.settings.lrbtc)+"</td></tr>":"")+("number"==typeof controller.settings.RSSI?"<tr><td>"+_("WiFi Strength")+"</td><td>"+getWiFiRating(controller.settings.RSSI)+"</td></tr>":"")+("number"==typeof controller.settings.wterr?"<tr><td>"+_("Weather Service")+"</td><td>"+getWeatherStatus(controller.settings.wterr)+"</td></tr>":"")+"</table><div class='debugWUHeading'>Watering Level</div><table class='debugWUTable'>"+("undefined"==typeof controller.options.uwt?"":"<tr><td>"+_("Method")+"</td><td>"+getAdjustmentMethod(controller.options.uwt).name+"</td></tr>")+("undefined"==typeof controller.options.wl?"":"<tr><td>"+_("Watering Level")+"</td><td>"+controller.options.wl+" %</td></tr>")+("number"==typeof controller.settings.lswc?"<tr><td>"+_("Last Updated")+"</td><td>"+(0===controller.settings.lswc?_("Never"):humaniseDuration(1e3*controller.settings.devt,1e3*controller.settings.lswc))+"</td></tr>":"")+"</table><div class='debugWUHeading'>Weather Service Details</div><div class='debugWUScrollable'><table class='debugWUTable'>","object"==typeof controller.settings.wtdata&&0<Object.keys(controller.settings.wtdata).length&&(e+=("undefined"==typeof controller.settings.wtdata.h?"":"<tr><td>"+_("Mean Humidity")+"</td><td>"+formatHumidity(controller.settings.wtdata.h)+"</td></tr>")+("undefined"==typeof controller.settings.wtdata.t?"":"<tr><td>"+_("Mean Temp")+"</td><td>"+formatTemp(controller.settings.wtdata.t)+"</td></tr>")+("undefined"==typeof controller.settings.wtdata.p?"":"<tr><td>"+_("Total Rain")+"</td><td>"+formatPrecip(controller.settings.wtdata.p)+"</td></tr>")+("undefined"==typeof controller.settings.wtdata.eto?"":"<tr><td>"+_("ETo")+"</td><td>"+formatPrecip(controller.settings.wtdata.eto)+"</td></tr>")+("undefined"==typeof controller.settings.wtdata.radiation?"":"<tr><td>"+_("Mean Radiation")+"</td><td>"+controller.settings.wtdata.radiation+" kWh/m2</td></tr>")+("undefined"==typeof controller.settings.wtdata.minT?"":"<tr><td>"+_("Min Temp")+"</td><td>"+formatTemp(controller.settings.wtdata.minT)+"</td></tr>")+("undefined"==typeof controller.settings.wtdata.maxT?"":"<tr><td>"+_("Max Temp")+"</td><td>"+formatTemp(controller.settings.wtdata.maxT)+"</td></tr>")+("undefined"==typeof controller.settings.wtdata.minH?"":"<tr><td>"+_("Min Humidity")+"</td><td>"+formatHumidity(controller.settings.wtdata.minH)+"</td></tr>")+("undefined"==typeof controller.settings.wtdata.maxH?"":"<tr><td>"+_("Max Humidity")+"</td><td>"+formatHumidity(controller.settings.wtdata.maxH)+"</td></tr>")+("undefined"==typeof controller.settings.wtdata.wind?"":"<tr><td>"+_("Mean Wind")+"</td><td>"+formatSpeed(controller.settings.wtdata.wind)+"</td></tr>")),e+="number"==typeof controller.settings.lwc?"<tr><td>"+_("Last Request")+"</td><td>"+dateToString(new Date(1e3*controller.settings.lwc),null,2)+"</td></tr>":"",e+="number"==typeof controller.settings.wterr?"<tr><td>"+_("Last Response")+"</td><td>"+getWeatherError(controller.settings.wterr)+"</td></tr>":"",e+="</table></div>","string"==typeof controller.settings.wtdata.weatherProvider&&(e+="<hr>",e+=makeAttribution(controller.settings.wtdata.weatherProvider)),e+="</div>",openPopup($(e)),!1}function showRainDelay(){$(".ui-popup-active").find("[data-role='popup']").popup("close"),showDurationBox({title:_("Change Rain Delay"),callback:raindelay,label:_("Duration"),maximum:31536e3,granularity:2,preventCompression:!0,incrementalUpdate:!1,updateOnChange:!1,helptext:_("Enable manual rain delay by entering a value into the input below. To turn off a currently enabled rain delay use a value of 0.")})}/** Returns the adjustment method for the corresponding ID, or a list of all methods if no ID is specified. */function getAdjustmentMethod(e){var t=[{name:_("Manual"),id:0},{name:"Zimmerman",id:1},{name:_("Auto Rain Delay"),id:2,minVersion:216},{name:"ETo",id:3,minVersion:216}];return void 0===e?t:t[e&-129]}function getCurrentAdjustmentMethodId(){return controller.options.uwt&-129}function getRestriction(e){return[{isCurrent:0,name:_("None")},{isCurrent:!!(1&controller.options.uwt>>7),name:_("California Restriction")}][e]}function setRestriction(e,t){return t=t||-129&controller.options.uwt,1===e&&(t|=128),t}function testAPIKey(e,t){$.ajax({url:"https://api.weather.com/v2/pws/observations/current?stationId=KMAHANOV10&format=json&units=m&apiKey="+e,cache:!0}).done(function(e){return e.errors?void t(!1):void t(!0)}).fail(function(){t(!1)})}// Panel functions
function bindPanel(){var e=$("#sprinklers-settings"),t=function(){return controller&&controller.settings&&controller.settings.en&&1===controller.settings.en?_("Disable"):_("Enable")};e.enhanceWithin().panel().removeClass("hidden").panel("option","classes.modal","needsclick ui-panel-dismiss"),e.find("a[href='#site-control']").on("click",function(){return changePage("#site-control"),!1}),e.find("a[href='#about']").on("click",function(){return changePage("#about"),!1}),e.find(".cloud-login").on("click",function(){return requestCloudAuth(),!1}),e.find("a[href='#debugWU']").on("click",debugWU),e.find("a[href='#localization']").on("click",languageSelect),e.find(".export_config").on("click",function(){return"object"!=typeof controller.stations.stn_spe||"object"==typeof controller.special||controller.stations.stn_spe.every(function(t){return 0===t})?getExportMethod():updateControllerStationSpecial(getExportMethod),!1}),e.find(".import_config").on("click",function(){return storage.get("backup",function(e){getImportMethod(e.backup)}),!1}),e.find(".toggleOperation").on("click",function(){var e=$(this),a=1-controller.settings.en;return areYouSure(_("Are you sure you want to")+" "+t().toLowerCase()+" "+_("operation?"),"",function(){sendToOS("/cv?pw=&en="+a).done(function(){$.when(updateControllerSettings(),updateControllerStatus()).done(function(){checkStatus(),e.find("span:first").html(t()).attr("data-translate",t())})})}),!1}).find("span:first").html(t()).attr("data-translate",t()),e.find(".reboot-os").on("click",function(){return areYouSure(_("Are you sure you want to reboot OpenSprinkler?"),"",function(){$.mobile.loading("show"),sendToOS("/cv?pw=&rbt=1").done(function(){$.mobile.loading("hide"),showerror(_("OpenSprinkler is rebooting now"))})}),!1}),e.find(".changePassword > a").on("click",changePassword),e.find("#downgradeui").on("click",function(){return areYouSure(_("Are you sure you want to downgrade the UI?"),"",function(){var e="http://rayshobby.net/scripts/java/svc"+getOSVersion();sendToOS("/cu?jsp="+encodeURIComponent(e)+"&pw=").done(function(){storage.remove(["sites","current_site","lang","provider","wapikey","runonce"]),location.reload()})}),!1}),e.find("#logout").on("click",function(){return logout(),!1}),openPanel=function(){var e=$("#sprinklers-settings"),t=function(){var t=controller&&controller.settings&&controller.settings.en&&1===controller.settings.en?_("Disable"):_("Enable");e.find(".toggleOperation span:first").html(t).attr("data-translate",t)};return $("html").on("datarefresh",t),function(){var a=$(".ui-page-active").attr("id");"start"!==a&&"loadingPage"!==a&&isControllerConnected()&&1===$(".ui-page-active").length&&(t(),e.panel("open"))}}()}// Device setting management functions
function showOptions(e){var t=Math.abs,a=Math.round,n="",s=$("<div data-role='page' id='os-options'><div class='ui-content' role='main'><div data-role='collapsibleset' id='os-options-list'></div><a class='submit preventBack' style='display:none'></a></div></div>"),o=function(e,t,a){return"<div class='ui-field-contain'><fieldset data-role='controlgroup' class='ui-mini center sensor-options' data-type='horizontal'><legend class='left'>"+_("Sensor")+(a?" "+a+" ":" ")+_("Type")+"</legend><input class='noselect' type='radio' name='o"+e+"' id='o"+e+"-none' value='0'"+(0===t?" checked='checked'":"")+"><label for='o"+e+"-none'>"+_("None")+"</label><input class='noselect' type='radio' name='o"+e+"' id='o"+e+"-rain' value='1'"+(1===t?" checked='checked'":"")+"><label for='o"+e+"-rain'>"+_("Rain")+"</label>"+(52===e?"":"<input class='noselect' type='radio' name='o"+e+"' id='o"+e+"-flow' value='2'"+(2===t?" checked='checked'":"")+"><label for='o"+e+"-flow'>"+_("Flow")+"</label>")+(checkOSVersion(219)?"<input class='noselect' type='radio' name='o"+e+"' id='o"+e+"-soil' value='3'"+(3===t?" checked='checked'":"")+"><label for='o"+e+"-soil'>"+_("Soil")+"</label>":"")+(checkOSVersion(217)?"<input class='noselect' type='radio' name='o"+e+"' id='o"+e+"-program' value='240'"+(240===t?" checked='checked'":"")+"><label for='o"+e+"-program'>"+_("Program Switch")+"</label>":"")+"</fieldset></div>"},d=function(){var e={},t=!1,i=isOSPi(),n=l.eq(2),o;return n.prop("disabled",!0),s.find(".submit").removeClass("hasChanges"),s.find("#os-options-list").find(":input,button").filter(":not(.noselect)").each(function(){var n=$(this),d=n.attr("id"),l=n.val(),r;if(!d||!l&&""!==l)return!0;switch(d){case"o1":var c=l.split(":");c[0]=parseInt(c[0],10),c[1]=parseInt(c[1],10),c[1]=(c[1]/15>>0)/4,c[0]+=0<=c[0]?c[1]:-c[1],l=4*(c[0]+12)>>0;break;case"datetime":var p=new Date(1e3*l);return e.tyy=p.getUTCFullYear(),e.tmm=p.getUTCMonth(),e.tdd=p.getUTCDate(),e.thh=p.getUTCHours(),e.tmi=p.getUTCMinutes(),e.ttt=a(p.getTime()/1e3),!0;case"ip_addr":return(r=l.split("."),"0.0.0.0"===r)?(showerror(_("A valid IP address is required when DHCP is not used")),t=!0,!1):(e.o4=r[0],e.o5=r[1],e.o6=r[2],e.o7=r[3],!0);case"subnet":return(r=l.split("."),"0.0.0.0"===r)?(showerror(_("A valid subnet address is required when DHCP is not used")),t=!0,!1):(e.o58=r[0],e.o59=r[1],e.o60=r[2],e.o61=r[3],!0);case"gateway":return(r=l.split("."),"0.0.0.0"===r)?(showerror(_("A valid gateway address is required when DHCP is not used")),t=!0,!1):(e.o8=r[0],e.o9=r[1],e.o10=r[2],e.o11=r[3],!0);case"dns":return(r=l.split("."),"0.0.0.0"===r)?(showerror(_("A valid DNS address is required when DHCP is not used")),t=!0,!1):(e.o44=r[0],e.o45=r[1],e.o46=r[2],e.o47=r[3],!0);case"ntp_addr":return r=l.split("."),e.o32=r[0],e.o33=r[1],e.o34=r[2],e.o35=r[3],!0;case"wtkey":return!0;case"wto":if(l=escapeJSON($.extend({},unescapeJSON(l),{key:s.find("#wtkey").val()})),escapeJSON(controller.settings.wto)===l)return!0;break;case"isMetric":return isMetric=n.is(":checked"),storage.set({isMetric:isMetric}),!0;case"o12":return i||(e.o12=255&l,e.o13=255&l>>8),!0;case"o31":if(3===parseInt(l)&&!unescapeJSON($("#wto")[0].value).baseETo)return showerror(_("You must specify a baseline ETo adjustment method option to use the ET adjustment method.")),t=!0,!1;var u=s.find("#weatherRestriction");u.length&&(l=setRestriction(parseInt(u.val()),l));break;case"o18":case"o37":parseInt(l)>8*(parseInt(s.find("#o15").val())+1)&&(l=0);break;case"o41":return"gallon"===s.find("#o41-units").val()&&(l*=3.78541),"milliliter"===s.find("#o41-units").val()&&(l*=3.78541),e.o41=255&100*l,e.o42=255&100*l>>8,!0;case"o2":case"o3":case"o14":case"o16":case"o21":case"o22":case"o25":case"o36":case"o48":case"o50":case"o51":case"o52":case"o53":if(l=n.is(":checked")?1:0,!checkOSVersion(219)&&!l)return!0;}i&&("loc"===d||"lg"===d?d="o"+d:(o=/\d+/.exec(d),d="o"+Object.keys(keyIndex).find(function(e){return keyIndex[e]===o}))),!0===checkOSVersion(208)&&"loc"===d&&(l=l.replace(/\s/g,"_")),e[d]=l}),t?(n.prop("disabled",!1),void s.find(".submit").addClass("hasChanges")):void("undefined"!=typeof controller.options.fpr0&&("undefined"==typeof controller.options.urs?("undefined"!=typeof controller.options.sn1t&&(e.o50=s.find("input[name='o50'][type='radio']:checked").val()),"undefined"!=typeof controller.options.sn2t&&(e.o52=s.find("input[name='o52'][type='radio']:checked").val())):e.o21=s.find("input[name='o21'][type='radio']:checked").val()),e=transformKeys(e),$.mobile.loading("show"),sendToOS("/co?pw=&"+$.param(e)).done(function(){$.mobile.document.one("pageshow",function(){showerror(_("Settings have been saved"))}),goBack(),updateController(updateWeather)}).fail(function(){n.prop("disabled",!1),s.find(".submit").addClass("hasChanges")}))},l=changeHeader({title:_("Edit Options"),leftBtn:{icon:"carat-l",text:_("Back"),class:"ui-toolbar-back-btn",on:checkChangesBeforeBack},rightBtn:{icon:"check",text:_("Submit"),class:"submit",on:d}}),r,c,p;if(s.find(".submit").on("click",d),n="<fieldset data-role='collapsible'"+("string"!=typeof e||"system"===e?" data-collapsed='false'":"")+"><legend>"+_("System")+"</legend>","undefined"!=typeof controller.options.ntp&&(n+="<div class='ui-field-contain datetime-input'><label for='datetime'>"+_("Device Time")+"</label><button "+(controller.options.ntp?"disabled ":"")+"data-mini='true' id='datetime' value='"+(controller.settings.devt+60*new Date(1e3*controller.settings.devt).getTimezoneOffset())+"'>"+dateToString(new Date(1e3*controller.settings.devt)).slice(0,-3)+"</button></div>"),!isOSPi()&&"undefined"!=typeof controller.options.tz){for(r=["-12:00","-11:30","-11:00","-10:00","-09:30","-09:00","-08:30","-08:00","-07:00","-06:00","-05:00","-04:30","-04:00","-03:30","-03:00","-02:30","-02:00","+00:00","+01:00","+02:00","+03:00","+03:30","+04:00","+04:30","+05:00","+05:30","+05:45","+06:00","+06:30","+07:00","+08:00","+08:45","+09:00","+09:30","+10:00","+10:30","+11:00","+11:30","+12:00","+12:45","+13:00","+13:45","+14:00"],c=controller.options.tz-48,c=(0<=c?"+":"-")+pad(t(c)/4>>0)+":"+(15*(t(c)%4)/10>>0)+15*(t(c)%4)%10,n+="<div class='ui-field-contain'><label for='o1' class='select'>"+_("Timezone")+"</label><select "+(checkOSVersion(210)&&"object"==typeof weather?"disabled='disabled' ":"")+"data-mini='true' id='o1'>",p=0;p<r.length;p++)n+="<option "+(r[p]===c?"selected":"")+" value='"+r[p]+"'>"+r[p]+"</option>";n+="</select></div>"}if(n+="<div class='ui-field-contain'><label for='loc'>"+_("Location")+"</label><button data-mini='true' id='loc' value='"+("''"===controller.settings.loc.trim()?_("Not specified"):controller.settings.loc)+"'><span>"+controller.settings.loc+"</span><a class='ui-btn btn-no-border ui-btn-icon-notext ui-icon-delete ui-btn-corner-all clear-loc'></a></button></div>","undefined"!=typeof controller.options.lg&&(n+="<label for='o36'><input data-mini='true' id='o36' type='checkbox' "+(1===controller.options.lg?"checked='checked'":"")+">"+_("Enable Logging")+"</label>"),n+="<label for='isMetric'><input data-mini='true' id='isMetric' type='checkbox' "+(isMetric?"checked='checked'":"")+">"+_("Use Metric")+"</label>",n+="</fieldset><fieldset data-role='collapsible'"+("string"==typeof e&&"master"===e?" data-collapsed='false'":"")+"><legend>"+_("Configure Master")+"</legend>","undefined"!=typeof controller.options.mas){for(n+="<div class='ui-field-contain ui-field-no-border'><label for='o18' class='select'>"+_("Master Station")+" "+("undefined"==typeof controller.options.mas2?"":"1")+"</label><select data-mini='true' id='o18'><option value='0'>"+_("None")+"</option>",p=0;p<controller.stations.snames.length&&(n+="<option "+(1===isStationMaster(p)?"selected":"")+" value='"+(p+1)+"'>"+controller.stations.snames[p]+"</option>",checkOSVersion(214)||7!==p);p++);n+="</select></div>","undefined"!=typeof controller.options.mton&&(n+="<div "+(0===controller.options.mas?"style='display:none' ":"")+"class='ui-field-no-border ui-field-contain duration-field'><label for='o19'>"+_("Master On Adjustment")+"</label><button data-mini='true' id='o19' value='"+controller.options.mton+"'>"+controller.options.mton+"s</button></div>"),"undefined"!=typeof controller.options.mtof&&(n+="<div "+(0===controller.options.mas?"style='display:none' ":"")+"class='ui-field-no-border ui-field-contain duration-field'><label for='o20'>"+_("Master Off Adjustment")+"</label><button data-mini='true' id='o20' value='"+controller.options.mtof+"'>"+controller.options.mtof+"s</button></div>")}if("undefined"!=typeof controller.options.mas2){for(n+="<hr style='width:95%' class='content-divider'>",n+="<div class='ui-field-contain ui-field-no-border'><label for='o37' class='select'>"+_("Master Station")+" 2</label><select data-mini='true' id='o37'><option value='0'>"+_("None")+"</option>",p=0;p<controller.stations.snames.length&&(n+="<option "+(2===isStationMaster(p)?"selected":"")+" value='"+(p+1)+"'>"+controller.stations.snames[p]+"</option>",checkOSVersion(214)||7!==p);p++);n+="</select></div>","undefined"!=typeof controller.options.mton2&&(n+="<div "+(0===controller.options.mas2?"style='display:none' ":"")+"class='ui-field-no-border ui-field-contain duration-field'><label for='o38'>"+_("Master On Delay")+"</label><button data-mini='true' id='o38' value='"+controller.options.mton2+"'>"+controller.options.mton2+"s</button></div>"),"undefined"!=typeof controller.options.mtof2&&(n+="<div "+(0===controller.options.mas2?"style='display:none' ":"")+"class='ui-field-no-border ui-field-contain duration-field'><label for='o39'>"+_("Master Off Delay")+"</label><button data-mini='true' id='o39' value='"+controller.options.mtof2+"'>"+controller.options.mtof2+"s</button></div>")}if(n+="</fieldset><fieldset data-role='collapsible'"+("string"==typeof e&&"station"===e?" data-collapsed='false'":"")+"><legend>"+_("Station Handling")+"</legend>","undefined"!=typeof controller.options.ext){for(n+="<div class='ui-field-contain'><label for='o15' class='select'>"+_("Number of Stations")+("number"==typeof controller.options.dexp&&255>controller.options.dexp&&0<=controller.options.dexp?" <span class='nobr'>("+(8*controller.options.dexp+8)+" "+_("available")+")</span>":"")+"</label><select data-mini='true' id='o15'>",p=0;p<=(controller.options.mexp||5);p++)n+="<option "+(controller.options.ext===p?"selected":"")+" value='"+p+"'>"+(8*p+8)+" "+_("stations")+"</option>";n+="</select></div>"}if("undefined"!=typeof controller.options.sdt&&(n+="<div class='ui-field-contain duration-field'><label for='o17'>"+_("Station Delay")+"</label><button data-mini='true' id='o17' value='"+controller.options.sdt+"'>"+dhms2str(sec2dhms(controller.options.sdt))+"</button></div>"),n+="<label for='showDisabled'><input data-mini='true' class='noselect' id='showDisabled' type='checkbox' "+("true"===localStorage.showDisabled?"checked='checked'":"")+">"+_("Show Disabled")+" "+_("(Changes Auto-Saved)")+"</label>","undefined"!=typeof controller.options.seq&&(n+="<label for='o16'><input data-mini='true' id='o16' type='checkbox' "+(1===controller.options.seq?"checked='checked'":"")+">"+_("Sequential")+"</label>"),n+="</fieldset><fieldset data-role='collapsible'"+("string"==typeof e&&"weather"===e?" data-collapsed='false'":"")+"><legend>"+_("Weather and Sensors")+"</legend>","undefined"!=typeof controller.options.uwt){for(n+="<div class='ui-field-contain'><label for='o31' class='select'>"+_("Weather Adjustment Method")+"<button data-helptext='"+_("Weather adjustment uses OpenWeatherMaps data in conjunction with the selected method to adjust the watering percentage.")+"' class='help-icon btn-no-border ui-btn ui-icon-info ui-btn-icon-notext'></button></label><select data-mini='true' id='o31'>",p=0;p<getAdjustmentMethod().length;p++){var u=getAdjustmentMethod()[p];// Skip unsupported adjustment options.
(!u.minVersion||checkOSVersion(u.minVersion))&&(n+="<option "+(u.id===getCurrentAdjustmentMethodId()?"selected":"")+" value='"+p+"'>"+u.name+"</option>")}if(n+="</select></div>","object"==typeof controller.settings.wto&&(n+="<div class='ui-field-contain"+(0===getCurrentAdjustmentMethodId()?" hidden":"")+"'><label for='wto'>"+_("Adjustment Method Options")+"</label><button data-mini='true' id='wto' value='"+escapeJSON(controller.settings.wto)+"'>"+_("Tap to Configure")+"</button></div>"),checkOSVersion(214)){for(n+="<div class='ui-field-contain'><label for='weatherRestriction' class='select'>"+_("Weather-Based Restrictions")+"<button data-helptext='"+_("Prevents watering when the selected restriction is met.")+"' class='help-icon btn-no-border ui-btn ui-icon-info ui-btn-icon-notext'></button></label><select data-mini='true' class='noselect' id='weatherRestriction'>",p=0;2>p;p++){var m=getRestriction(p);n+="<option "+(!0===m.isCurrent?"selected":"")+" value='"+p+"'>"+m.name+"</option>"}n+="</select></div>"}}if("undefined"!=typeof controller.options.wl&&(n+="<div class='ui-field-contain duration-field'><label for='o23'>"+_("% Watering")+"<button data-helptext='"+_("The watering percentage scales station run times by the set value. When weather adjustment is used the watering percentage is automatically adjusted.")+"' class='help-icon btn-no-border ui-btn ui-icon-info ui-btn-icon-notext'></button></label><button "+(controller.options.uwt&&0<getCurrentAdjustmentMethodId()?"disabled='disabled' ":"")+"data-mini='true' id='o23' value='"+controller.options.wl+"'>"+controller.options.wl+"%</button></div>"),("undefined"!=typeof controller.options.urs||"undefined"!=typeof controller.options.sn1t)&&("undefined"==typeof controller.options.fpr0?n+="<label for='o21'><input data-mini='true' id='o21' type='checkbox' "+(1===controller.options.urs?"checked='checked'":"")+">"+_("Use Rain Sensor")+"</label>":n+="undefined"==typeof controller.options.urs?"undefined"==typeof controller.options.sn1t?"":o(keyIndex.sn1t,controller.options.sn1t,1):o(keyIndex.urs,controller.options.urs)),"undefined"!=typeof controller.options.rso&&(n+="<label for='o22'><input "+(1===controller.options.urs||240===controller.options.urs?"":"data-wrapper-class='hidden' ")+"data-mini='true' id='o22' type='checkbox' "+(1===controller.options.rso?"checked='checked'":"")+">"+_("Normally Open")+"</label>"),"undefined"!=typeof controller.options.sn1o&&(n+="<label for='o51'><input "+(1===controller.options.sn1t||3===controller.options.sn1t||240===controller.options.sn1t?"":"data-wrapper-class='hidden' ")+"data-mini='true' id='o51' type='checkbox' "+(1===controller.options.sn1o?"checked='checked'":"")+">"+_("Normally Open")+"</label>"),"undefined"!=typeof controller.options.fpr0&&(n+="<div class='ui-field-contain"+(2===controller.options.urs||2===controller.options.sn1t?"":" hidden")+"'><label for='o41'>"+_("Flow Pulse Rate")+"</label><table><tr style='width:100%;vertical-align: top;'><td style='width:100%'><div class='ui-input-text controlgroup-textinput ui-btn ui-body-inherit ui-corner-all ui-mini ui-shadow-inset ui-input-has-clear'><input data-role='none' data-mini='true' type='number' pattern='^[-+]?[0-9]*.?[0-9]*$' id='o41' value='"+(256*controller.options.fpr1+controller.options.fpr0)/100+"'></div></td><td class='tight-select'><select id='o41-units' class='noselect' data-mini='true'><option selected='selected' value='liter'>L/pulse</option><option value='milliliter'>mL/pulse</option><option value='gallon'>Gal/pulse</option></select></td></tr></table></div>"),"undefined"!=typeof controller.options.sn1on&&(n+="<div class='"+(1===controller.options.sn1t||3===controller.options.sn1t?"":"hidden ")+"ui-field-no-border ui-field-contain duration-field'><label for='o54'>"+_("Sensor 1 Delayed On Time")+"</label><button data-mini='true' id='o54' value='"+controller.options.sn1on+"'>"+controller.options.sn1on+"m</button></div>"),"undefined"!=typeof controller.options.sn1of&&(n+="<div class='"+(1===controller.options.sn1t||3===controller.options.sn1t?"":"hidden ")+"ui-field-no-border ui-field-contain duration-field'><label for='o55'>"+_("Sensor 1 Delayed Off Time")+"</label><button data-mini='true' id='o55' value='"+controller.options.sn1of+"'>"+controller.options.sn1of+"m</button></div>"),checkOSVersion(217)&&(n+="<label id='prgswitch' class='center smaller"+(240===controller.options.urs||240===controller.options.sn1t||240===controller.options.sn2t?"":" hidden")+"'>"+_("When using program switch, a switch is connected to the sensor port to trigger Program 1 every time the switch is pressed for at least 1 second.")+"</label>"),"undefined"!=typeof controller.options.sn2t&&checkOSVersion(219)&&(n+=o(keyIndex.sn2t,controller.options.sn2t,2)),"undefined"!=typeof controller.options.sn2o&&(n+="<label for='o53'><input "+(1===controller.options.sn2t||3===controller.options.sn2t||240===controller.options.sn2t?"":"data-wrapper-class='hidden' ")+"data-mini='true' id='o53' type='checkbox' "+(1===controller.options.sn2o?"checked='checked'":"")+">"+_("Normally Open")+"</label>"),"undefined"!=typeof controller.options.sn2on&&(n+="<div class='"+(1===controller.options.sn2t||3===controller.options.sn2t?"":"hidden ")+"ui-field-no-border ui-field-contain duration-field'><label for='o56'>"+_("Sensor 2 Delayed On Time")+"</label><button data-mini='true' id='o56' value='"+controller.options.sn2on+"'>"+controller.options.sn2on+"m</button></div>"),"undefined"!=typeof controller.options.sn2of&&(n+="<div class='"+(1===controller.options.sn2t||3===controller.options.sn2t?"":"hidden ")+"ui-field-no-border ui-field-contain duration-field'><label for='o57'>"+_("Sensor 2 Delayed Off Time")+"</label><button data-mini='true' id='o57' value='"+controller.options.sn2of+"'>"+controller.options.sn2of+"m</button></div>"),"undefined"!=typeof controller.options.sn2t&&(n+="<label id='prgswitch-2' class='center smaller"+(240===controller.options.urs||240===controller.options.sn1t||240===controller.options.sn2t?"":" hidden")+"'>"+_("When using program switch, a switch is connected to the sensor port to trigger Program 2 every time the switch is pressed for at least 1 second.")+"</label>"),"undefined"!=typeof controller.settings.ifkey&&(n+="</fieldset><fieldset data-role='collapsible'"+("string"==typeof e&&"integrations"===e?" data-collapsed='false'":"")+"><legend>"+_("Integrations")+"</legend>",n+="<div class='ui-field-contain'><label for='ifkey'>"+_("IFTTT Key")+"<button data-helptext='"+_("To enable IFTTT, a Maker channel key is required which can be obtained from https://ifttt.com")+"' class='help-icon btn-no-border ui-btn ui-icon-info ui-btn-icon-notext'></button></label><input autocomplete='off' autocorrect='off' autocapitalize='off' spellcheck='false' data-mini='true' type='text' id='ifkey' value='"+controller.settings.ifkey+"'></div>",n+="<div class='ui-field-contain'><label for='o49'>"+_("IFTTT Events")+"<button data-helptext='"+_("Select which events to send to IFTTT for use in recipes.")+"' class='help-icon btn-no-border ui-btn ui-icon-info ui-btn-icon-notext'></button></label><button data-mini='true' id='o49' value='"+controller.options.ife+"'>Configure Events</button></div>"),n+="</fieldset><fieldset class='full-width-slider' data-role='collapsible'"+("string"==typeof e&&"lcd"===e?" data-collapsed='false'":"")+"><legend>"+_("LCD Screen")+"</legend>","undefined"!=typeof controller.options.con&&(n+="<div class='ui-field-contain'><label for='o27'>"+_("Contrast")+"</label><input type='range' id='o27' min='0' max='255' step='10' data-highlight='true' value='"+controller.options.con+"'></div>"),"undefined"!=typeof controller.options.lit&&(n+="<div class='ui-field-contain'><label for='o28'>"+_("Brightness")+"</label><input type='range' id='o28' min='0' max='255' step='10' data-highlight='true' value='"+controller.options.lit+"'></div>"),"undefined"!=typeof controller.options.dim&&(n+="<div class='ui-field-contain'><label for='o29'>"+_("Idle Brightness")+"</label><input type='range' id='o29' min='0' max='255' step='10' data-highlight='true' value='"+controller.options.dim+"'></div>"),n+="</fieldset><fieldset data-role='collapsible' data-theme='b'"+("string"==typeof e&&"advanced"===e?" data-collapsed='false'":"")+"><legend>"+_("Advanced")+"</legend>",checkOSVersion(219)&&"undefined"!=typeof controller.options.uwt&&"object"==typeof controller.settings.wto&&(n+="<div class='ui-field-contain'><label for='wtkey'>"+_("Wunderground Key").replace("Wunderground","Wunder&shy;ground")+"<button data-helptext='"+_("We use OpenWeatherMap normally however with a user provided API key the weather source will switch to Weather Underground.")+"' class='help-icon btn-no-border ui-btn ui-icon-info ui-btn-icon-notext'></button></label><table><tr style='width:100%;vertical-align: top;'><td style='width:100%'><div class='"+(controller.settings.wto.key&&""!==controller.settings.wto.key?"green ":"")+"ui-input-text controlgroup-textinput ui-btn ui-body-inherit ui-corner-all ui-mini ui-shadow-inset ui-input-has-clear'><input data-role='none' data-mini='true' autocomplete='off' autocorrect='off' autocapitalize='off' spellcheck='false' type='text' id='wtkey' value='"+(controller.settings.wto.key||"")+"'><a href='#' tabindex='-1' aria-hidden='true' data-helptext='"+_("An invalid API key has been detected.")+"' class='hidden help-icon ui-input-clear ui-btn ui-icon-alert ui-btn-icon-notext ui-corner-all'></a></div></td><td><button class='noselect' data-mini='true' id='verify-api'>"+_("Verify")+"</button></td></tr></table></div>"),"undefined"!=typeof controller.options.hp0&&(n+="<div class='ui-field-contain'><label for='o12'>"+_("HTTP Port (restart required)")+"</label><input data-mini='true' type='number' pattern='[0-9]*' id='o12' value='"+(256*controller.options.hp1+controller.options.hp0)+"'></div>"),"undefined"!=typeof controller.options.devid&&(n+="<div class='ui-field-contain'><label for='o26'>"+_("Device ID (restart required)")+"<button data-helptext='"+_("Device ID modifies the last byte of the MAC address.")+"' class='help-icon btn-no-border ui-btn ui-icon-info ui-btn-icon-notext'></button></label><input data-mini='true' type='number' pattern='[0-9]*' max='255' id='o26' value='"+controller.options.devid+"'></div>"),"undefined"==typeof controller.options.rlp?!0!==checkOSVersion(215)&&"undefined"!=typeof controller.options.bst&&(n+="<div class='ui-field-contain duration-field'><label for='o30'>"+_("Boost Time")+"<button data-helptext='"+_("Boost time changes how long the boost converter is activated with a range from 0 to 1000 milliseconds.")+"' class='help-icon btn-no-border ui-btn ui-icon-info ui-btn-icon-notext'></button></label><button data-mini='true' id='o30' value='"+controller.options.bst+"'>"+controller.options.bst+"ms</button></div>"):n+="<div class='ui-field-contain duration-field'><label for='o30'>"+_("Relay Pulse")+"<button data-helptext='"+_("Relay pulsing is used for special situations where rapid pulsing is needed in the output with a range from 1 to 2000 milliseconds. A zero value disables the pulsing option.")+"' class='help-icon btn-no-border ui-btn ui-icon-info ui-btn-icon-notext'></button></label><button data-mini='true' id='o30' value='"+controller.options.rlp+"'>"+controller.options.rlp+"ms</button></div>","undefined"!=typeof controller.options.ntp&&checkOSVersion(210)){var h=[controller.options.ntp1,controller.options.ntp2,controller.options.ntp3,controller.options.ntp4].join(".");n+="<div class='"+(1===controller.options.ntp?"":"hidden ")+"ui-field-contain duration-field'><label for='ntp_addr'>"+_("NTP IP Address")+"</label><button data-mini='true' id='ntp_addr' value='"+h+"'>"+h+"</button></div>"}if("undefined"!=typeof controller.options.dhcp&&checkOSVersion(210)){var b=[controller.options.ip1,controller.options.ip2,controller.options.ip3,controller.options.ip4].join("."),g=[controller.options.gw1,controller.options.gw2,controller.options.gw3,controller.options.gw4].join(".");if(n+="<div class='"+(1===controller.options.dhcp?"hidden ":"")+"ui-field-contain duration-field'><label for='ip_addr'>"+_("IP Address")+"</label><button data-mini='true' id='ip_addr' value='"+b+"'>"+b+"</button></div>",n+="<div class='"+(1===controller.options.dhcp?"hidden ":"")+"ui-field-contain duration-field'><label for='gateway'>"+_("Gateway Address")+"</label><button data-mini='true' id='gateway' value='"+g+"'>"+g+"</button></div>","undefined"!=typeof controller.options.subn1){var f=[controller.options.subn1,controller.options.subn2,controller.options.subn3,controller.options.subn4].join(".");n+="<div class='"+(1===controller.options.dhcp?"hidden ":"")+"ui-field-contain duration-field'><label for='subnet'>"+_("Subnet Mask")+"</label><button data-mini='true' id='subnet' value='"+f+"'>"+f+"</button></div>"}if("undefined"!=typeof controller.options.dns1){var v=[controller.options.dns1,controller.options.dns2,controller.options.dns3,controller.options.dns4].join(".");n+="<div class='"+(1===controller.options.dhcp?"hidden ":"")+"ui-field-contain duration-field'><label for='dns'>"+_("DNS Address")+"</label><button data-mini='true' id='dns' value='"+v+"'>"+v+"</button></div>"}n+="<label for='o3'><input data-mini='true' id='o3' type='checkbox' "+(1===controller.options.dhcp?"checked='checked'":"")+">"+_("Use DHCP (restart required)")+"</label>"}"undefined"!=typeof controller.options.ntp&&(n+="<label for='o2'><input data-mini='true' id='o2' type='checkbox' "+(1===controller.options.ntp?"checked='checked'":"")+">"+_("NTP Sync")+"</label>"),"undefined"!=typeof controller.options.ar&&(n+="<label for='o14'><input data-mini='true' id='o14' type='checkbox' "+(1===controller.options.ar?"checked='checked'":"")+">"+_("Auto Reconnect")+"</label>"),"undefined"!=typeof controller.options.ipas&&(n+="<label for='o25'><input data-mini='true' id='o25' type='checkbox' "+(1===controller.options.ipas?"checked='checked'":"")+">"+_("Ignore Password")+"</label>"),"undefined"!=typeof controller.options.sar&&(n+="<label for='o48'><input data-mini='true' id='o48' type='checkbox' "+(1===controller.options.sar?"checked='checked'":"")+">"+_("Special Station Auto-Refresh")+"</label>"),n+="</fieldset><fieldset data-role='collapsible' data-theme='b'"+("string"==typeof e&&"reset"===e?" data-collapsed='false'":"")+"><legend>"+_("Reset")+"</legend>",n+="<button data-mini='true' class='center-div reset-log'>"+_("Clear Log Data")+"</button>",n+="<button data-mini='true' class='center-div reset-options'>"+_("Reset All Options")+"</button>",n+="<button data-mini='true' class='center-div reset-stations'>"+_("Reset All Station Data")+"</button>",30<=controller.options.hwv&&40>controller.options.hwv&&(n+="<hr class='divider'><button data-mini='true' class='center-div reset-wireless'>"+_("Reset Wireless Settings")+"</button>"),n+="</fieldset>",s.find("#os-options-list").html(n).one("change input",":not(.noselect)",function(){l.eq(2).prop("disabled",!1),s.find(".submit").addClass("hasChanges")}).find("fieldset").each(function(){var e=$(this);1===e.children().length&&e.remove()}),s.find(".clear-loc").on("click",function(t){t.stopImmediatePropagation(),areYouSure(_("Are you sure you want to clear the current location?"),"",function(){s.find("#loc").val("''").removeClass("green").find("span").text(_("Not specified")),s.find("#o1").selectmenu("enable"),l.eq(2).prop("disabled",!1),s.find(".submit").addClass("hasChanges")})}),s.find("#showDisabled").on("change",function(){return storage.set({showDisabled:this.checked}),!1}),s.find("#loc").on("click",function(){var e=$(this);e.prop("disabled",!0),overlayMap(function(t,a){if(!1===t)""===e.val()&&(e.removeClass("green"),s.find("#o1").selectmenu("enable"));else{if(checkOSVersion(210)&&s.find("#o1").selectmenu("disable"),"string"==typeof t)e.val(t).find("span").text(t);else{t[0]=parseFloat(t[0]).toFixed(5),t[1]=parseFloat(t[1]).toFixed(5),"string"==typeof a&&validateWULocation(a,function(t){t?e.addClass("green"):!t&&e.removeClass("green")});// Update the PWS location (either with the PWS station or reset to undefined)
var i=s.find("#wto");// The value will be undefined if running an older HW version without an SD card.
i&&void 0!==i.val()&&i.val(escapeJSON($.extend({},unescapeJSON(i.val()),{pws:a||""}))),e.val(t),coordsToLocation(t[0],t[1],function(t){e.find("span").text(t)})}l.eq(2).prop("disabled",!1),s.find(".submit").addClass("hasChanges")}e.prop("disabled",!1)})}),s.find("#wto").on("click",function(){var e=this,t=unescapeJSON(this.value),a={pws:t.pws,key:t.key},i=parseInt(s.find("#o31").val()),n=function(){e.value=escapeJSON($.extend({},unescapeJSON(e.value),a)),l.eq(2).prop("disabled",!1),s.find(".submit").addClass("hasChanges")};1===i?showZimmermanAdjustmentOptions(this,n):2===i?showAutoRainDelayAdjustmentOptions(this,n):3===i&&showEToAdjustmentOptions(this,n)}),s.find(".reset-log").on("click",clearLogs),s.find(".reset-options").on("click",function(){resetAllOptions(function(){$.mobile.document.one("pageshow",function(){showerror(_("Settings have been saved"))}),goBack()})}),s.find(".reset-stations").on("click",function(){for(var e="",t=0;t<controller.stations.snames.length;t++)e+="s"+t+"=S"+pad(t+1)+"&";if(controller.options.mas)for(t=0;t<controller.settings.nbrd;t++)e+="m"+t+"=255&";if("object"==typeof controller.stations.ignore_rain)for(t=0;t<controller.settings.nbrd;t++)e+="i"+t+"=0&";if("object"==typeof controller.stations.ignore_sn1)for(t=0;t<controller.settings.nbrd;t++)e+="j"+t+"=0&";if("object"==typeof controller.stations.ignore_sn2)for(t=0;t<controller.settings.nbrd;t++)e+="k"+t+"=0&";if("object"==typeof controller.stations.act_relay)for(t=0;t<controller.settings.nbrd;t++)e+="a"+t+"=0&";if("object"==typeof controller.stations.stn_dis)for(t=0;t<controller.settings.nbrd;t++)e+="d"+t+"=0&";if("object"==typeof controller.stations.stn_seq)for(t=0;t<controller.settings.nbrd;t++)e+="q"+t+"=255&";areYouSure(_("Are you sure you want to reset all stations?"),_("This will reset all station names and attributes"),function(){$.mobile.loading("show"),storage.get(["sites","current_site"],function(e){var t=parseSites(e.sites);t[e.current_site].notes={},t[e.current_site].images={},t[e.current_site].lastRunTime={},storage.set({sites:JSON.stringify(t)},cloudSaveSites)}),sendToOS("/cs?pw=&"+e).done(function(){showerror(_("Stations have been updated")),updateController()})})}),s.find(".reset-wireless").on("click",function(){areYouSure(_("Are you sure you want to reset the wireless settings?"),_("This will delete the stored SSID/password for your wireless network and return the device to access point mode"),function(){sendToOS("/cv?pw=&ap=1").done(function(){$.mobile.document.one("pageshow",function(){showerror(_("Wireless settings have been reset. Please follow the OpenSprinkler user manual on restoring connectivity."))}),goBack()})})}),s.find("#o3").on("change",function(){var e=$(this),t=e.is(":checked"),a=s.find("#ip_addr,#gateway,#dns,#subnet").parents(".ui-field-contain");t?a.addClass("hidden"):a.removeClass("hidden")}),s.find(".sensor-options input[type='radio']").on("change",function(){var e=this.value,t=parseInt(this.id.match(/o(\d+)/)[1],10);"2"===e?s.find("#o41").parents(".ui-field-contain").removeClass("hidden"):(21===t||50===t)&&s.find("#o41").parents(".ui-field-contain").addClass("hidden"),"1"===e||"3"===e||"240"===e?s.find("#o"+(t+1)).parent().removeClass("hidden"):s.find("#o"+(t+1)).parent().addClass("hidden"),"240"===$("input[name='o21'][type='radio']:checked").val()||"240"===$("input[name='o50'][type='radio']:checked").val()?s.find("#prgswitch").removeClass("hidden"):s.find("#prgswitch").addClass("hidden"),"240"===$("input[name='o52'][type='radio']:checked").val()?s.find("#prgswitch-2").removeClass("hidden"):s.find("#prgswitch-2").addClass("hidden"),"1"===e||"3"===e?s.find("#o"+(t+4)+",#o"+(t+5)).parent().removeClass("hidden"):s.find("#o"+(t+4)+",#o"+(t+5)).parent().addClass("hidden")}),s.find("#o21").on("change",function(){s.find("#o22").parent().toggleClass("hidden",$(this).is(":checked"))}),s.find("#verify-api").on("click",function(){var e=s.find("#wtkey"),t=$(this);t.prop("disabled",!0),testAPIKey(e.val(),function(a){!0===a?(e.parent().find(".ui-icon-alert").hide(),e.parent().removeClass("red").addClass("green")):(e.parent().find(".ui-icon-alert").removeClass("hidden").show(),e.parent().removeClass("green").addClass("red")),t.prop("disabled",!1)})}),s.find(".help-icon").on("click",showHelpText),s.find(".duration-field button:not(.help-icon)").on("click",function(){var e=$(this),t=e.attr("id"),a=s.find("label[for='"+t+"']").text(),i=e.parent().find(".help-icon").data("helptext"),n=240;if(l.eq(2).prop("disabled",!1),s.find(".submit").addClass("hasChanges"),"ip_addr"===t||"gateway"===t||"dns"===t||"ntp_addr"===t||"subnet"===t)showIPRequest({title:a,ip:e.val().split("."),callback:function(t){e.val(t.join(".")).text(t.join("."))}});else if("o19"===t||"o38"===t)showSingleDurationInput({data:e.val(),title:a,callback:function(t){e.val(t).text(t+"s")},label:_("Seconds"),maximum:60,helptext:i});else if("o30"===t)showSingleDurationInput({data:e.val(),title:a,callback:function(t){e.val(t).text(t+"ms")},label:_("Milliseconds"),maximum:2e3,helptext:i});else if("o20"===t||"o39"===t)showSingleDurationInput({data:e.val(),title:a,callback:function(t){e.val(t).text(t+"s")},label:_("Seconds"),maximum:checkOSVersion(217)?0:60,minimum:-60,helptext:i});else if("o23"===t)showSingleDurationInput({data:e.val(),title:a,callback:function(t){e.val(t).text(t+"%")},label:_("% Watering"),maximum:250,helptext:i});else if("o17"===t){var o=0;checkOSVersion(210)&&(n=checkOSVersion(214)?57600:64800),checkOSVersion(211)&&(o=-3540,n=3540),checkOSVersion(217)&&(o=-600,n=600),showSingleDurationInput({data:e.val(),title:a,label:_("Seconds"),callback:function(t){e.val(t),e.text(dhms2str(sec2dhms(t)))},maximum:n,minimum:o})}else("o54"===t||"o55"===t||"o56"===t||"o57"===t)&&showSingleDurationInput({data:e.val(),title:a,callback:function(t){e.val(t).text(t+"m")},label:_("Minutes"),maximum:240,minimum:0,helptext:i});return!1}),s.find("#o2").on("change",function(){var e=$(this).is(":checked");// Switch state of device time input based on NTP status
s.find(".datetime-input button").prop("disabled",e),s.find("#ntp_addr").parents(".ui-field-contain").toggleClass("hidden",!e)}),s.find("#o18,#o37").on("change",function(){s.find("#o19,#o20").parents(".ui-field-contain").toggle(0!==parseInt(s.find("#o18").val())),"undefined"!=typeof controller.options.mas2&&s.find("#o38,#o39").parents(".ui-field-contain").toggle(0!==parseInt(s.find("#o37").val()))}),s.find("#o31").on("change",function(){s.find("#o23").prop("disabled",0!==parseInt(this.value)),s.find("#wto").click().parents(".ui-field-contain").toggleClass("hidden",0===parseInt(this.value))}),s.find("#wtkey").on("change input",function(){s.find("#wtkey").siblings(".help-icon").hide(),s.find("#wtkey").parent().removeClass("red green")}),s.find("#o49").on("click",function(){var e={program:_("Program Start"),sensor1:_("Sensor 1 Update"),flow:_("Flow Sensor Update"),weather:_("Weather Adjustment Update"),reboot:_("Controller Reboot"),run:_("Station Run"),sensor2:_("Sensor 2 Update"),rain:_("Rain Delay Update")},t=this,n=parseInt(t.value),o="",d=0,r=0;$.each(e,function(e,t){o+="<label for='ifttt-"+e+"'><input class='needsclick' data-iconpos='right' id='ifttt-"+e+"' type='checkbox' "+(getBitFromByte(n,d)?"checked='checked'":"")+">"+t+"</label>",d++});var c=$("<div data-role='popup' data-theme='a'><div data-role='controlgroup' data-mini='true' class='tight'><div class='ui-bar ui-bar-a'>"+_("Select IFTTT Events")+"</div>"+o+"<input data-wrapper-class='attrib-submit' class='submit' data-theme='b' type='submit' value='"+_("Submit")+"' /></div></div>");c.find(".submit").on("click",function(){d=0,$.each(e,function(e){r|=c.find("#ifttt-"+e).is(":checked")<<d,d++}),c.popup("close"),n===r||(t.value=r,l.eq(2).prop("disabled",!1),s.find(".submit").addClass("hasChanges"))}),openPopup(c)}),s.find(".datetime-input").on("click",function(){var e=$(this).find("button");if(!e.prop("disabled"))return l.eq(2).prop("disabled",!1),s.find(".submit").addClass("hasChanges"),showDateTimeInput(e.val(),function(t){e.text(dateToString(t).slice(0,-3)).val(a(t.getTime()/1e3))}),!1}),s.one("pagehide",function(){s.remove()}),l.eq(2).prop("disabled",!0),$("#os-options").remove(),$.mobile.pageContainer.append(s)}var showHomeMenu=function(){function e(){a=$(".ui-page-active"),i=a.attr("id"),n=a.hasClass("show-hidden"),s=$("<div data-role='popup' data-theme='a' id='mainMenu'><ul data-role='listview' data-inset='true' data-corners='false'><li data-role='list-divider'>"+_("Information")+"</li><li><a href='#preview' class='squeeze'>"+_("Preview Programs")+"</a></li>"+(checkOSVersion(206)||checkOSPiVersion("1.9")?"<li><a href='#logs'>"+_("View Logs")+"</a></li>":"")+"<li data-role='list-divider'>"+_("Programs and Settings")+"</li><li><a href='#raindelay'>"+_("Change Rain Delay")+"</a></li><li><a href='#runonce'>"+_("Run-Once Program")+"</a></li><li><a href='#programs'>"+_("Edit Programs")+"</a></li><li><a href='#os-options'>"+_("Edit Options")+"</a></li>"+(checkOSVersion(210)?"":"<li><a href='#manual'>"+_("Manual Control")+"</a></li>")+("sprinklers"===i||"runonce"===i||"programs"===i||"manual"===i||"addprogram"===i?"</ul><div class='ui-grid-a ui-mini tight'><div class='ui-block-a'><a class='ui-btn tight' href='#show-hidden'>"+(n?_("Hide"):_("Show"))+" "+_("Disabled")+"</a></div><div class='ui-block-b'><a class='ui-btn red tight' href='#stop-all'>"+_("Stop All Stations")+"</a></div></div>":"<li><a class='ui-btn red' href='#stop-all'>"+_("Stop All Stations")+"</a></li></ul>")+"</div>")}function t(t){t=t instanceof $?t:$(t),$(".ui-popup-active").find("[data-role='popup']").popup("close"),e(),s.on("click","a",function(){var e=$(this),t=e.attr("href");return s.popup("close"),"#stop-all"===t?stopAllStations():"#show-hidden"===t?n?($(".station-hidden").hide(),a.removeClass("show-hidden")):($(".station-hidden").show(),a.addClass("show-hidden")):"#raindelay"===t?showRainDelay():checkChanges(function(){changePage(t)}),!1}),$("#mainMenu").remove(),s.one("popupafterclose",function(){t.show()}),openPopup(s,{positionTo:t}),t.hide()}var a,i,n,s;return t}(),showHome=function(){function e(e){return!!isControllerConnected()&&void(p=!!controller.options.mas,u=!!controller.options.mas2,m="object"==typeof controller.stations.ignore_rain,h="object"==typeof controller.stations.ignore_sn1,b="object"==typeof controller.stations.ignore_sn2,g="object"==typeof controller.stations.act_relay,f="object"==typeof controller.stations.stn_dis,v="object"==typeof controller.stations.stn_seq,w="object"==typeof controller.stations.stn_spe,y="",k=$("#site-selector"),c(function(){for(S=0;S<controller.stations.snames.length;S++)n(S);t.find("#os-stations-list").html(y),l()}),t.find(".sitename").toggleClass("hidden",!!currLocal).text(k.val()),t.find(".waterlevel").text(controller.options.wl),d(),t.on("click",".station-settings",s),t.on("click",".home-info",function(){return changePage("#os-options",{expandItem:"weather"}),!1}),t.on("click",".card",function(){// Bind delegate handler to stop specific station (supported on firmware 2.1.0+ on Arduino)
if(!checkOSVersion(210))return!1;var e=$(this),t=e.data("station"),a=controller.status[t],i=controller.stations.snames[t],n;if(isStationMaster(t))return!1;if(a)n=_("Do you want to stop the selected station?");else if(e.find("span.nobr").length)n=_("Do you want to unschedule the selected station?");else return void showDurationBox({title:i,incrementalUpdate:!1,maximum:65535,seconds:0<C[x].lastRunTime[t]?C[x].lastRunTime[t]:0,helptext:_("Enter a duration to manually run "+i),callback:function(e){sendToOS("/cm?sid="+t+"&en=1&t="+e+"&pw=","json").done(function(){controller.settings.ps[t][0]=99,controller.settings.ps[t][1]=e,refreshStatus(),showerror(_("Station has been queued")),C[x].lastRunTime[t]=e,storage.set({sites:JSON.stringify(C)},cloudSaveSites)})}});areYouSure(n,controller.stations.snames[t],function(){sendToOS("/cm?sid="+t+"&en=0&pw=").done(function(){controller.settings.ps[t][0]=0,controller.settings.ps[t][1]=0,controller.status[S]=0,delete timers["station-"+t],refreshStatus(),showerror(_("Station has been stopped"))})})}).on("click","img",function(){var e=$(this),t=e.parents(".card").data("station"),a=-1!==e.attr("src").indexOf("data:image/jpeg;base64");return a?areYouSure(_("Do you want to delete the current image?"),"",function(){delete C[x].images[t],storage.set({sites:JSON.stringify(C)},cloudSaveSites),r()}):takePicture(function(e){C[x].images[t]=e,storage.set({sites:JSON.stringify(C)},cloudSaveSites),r()}),!1}).on({pagebeforeshow:function(){var t=changeHeader({class:"logo",leftBtn:{icon:"bullets",on:function(){return openPanel(),!1}},rightBtn:{icon:"bell",class:"notifications",text:"<span class='notificationCount ui-li-count ui-btn-corner-all'>"+notifications.length+"</span>",on:function(){return showNotifications(),!1}},animate:!e});0===notifications.length&&$(t[2]).hide()}}),$("#sprinklers").remove(),$.mobile.pageContainer.append(t),!$.isEmptyObject(weather)&&updateWeatherBox())}var t=$("<div data-role='page' id='sprinklers'><div class='ui-panel-wrapper'><div class='ui-content' role='main'><div class='ui-grid-a ui-body ui-corner-all info-card noweather'><div class='ui-block-a'><div id='weather' class='pointer'></div></div><div class='ui-block-b center home-info pointer'><div class='sitename bold'></div><div id='clock-s' class='nobr'></div>"+_("Water Level")+": <span class='waterlevel'></span>%</div></div><div id='os-running-stations'></div><hr style='display:none' class='content-divider'><div id='os-stations-list' class='card-group center'></div></div></div></div>"),a=function(e,a){timers["station-"+e]={val:a,station:e,update:function(){t.find("#countdown-"+e).text("("+sec2hms(this.val)+" "+_("remaining")+")")},done:function(){t.find("#countdown-"+e).parent("p").empty().siblings(".station-status").removeClass("on").addClass("off")}}},n=function(e){var t=controller.stations.snames[e],i=0<controller.settings.ps[e][0],n=0<controller.status[e],s=i?pidname(controller.settings.ps[e][0]):"",o=controller.settings.ps[e][1],d=!!C[x].images[e];controller.status[e]&&0<o&&a(e,o),y+="<div data-station='"+e+"' class='ui-corner-all card"+(isStationDisabled(e)?" station-hidden' style='display:none":"")+"'>",y+="<div class='ui-body ui-body-a center'>",y+="<img src='"+(d?"data:image/jpeg;base64,"+C[x].images[e]:getAppURLPath()+"img/placeholder.png")+"' />",y+="<p class='station-name center inline-icon' id='station_"+e+"'>"+t+"</p>",y+="<span class='btn-no-border ui-btn ui-btn-icon-notext ui-corner-all card-icon station-status "+(n?"on":i?"wait":"off")+"'></span>",y+="<span class='btn-no-border ui-btn ui-btn-icon-notext ui-icon-wifi card-icon special-station "+(isStationSpecial(e)?"":"hidden")+"'></span>",y+="<span class='btn-no-border ui-btn "+(isStationMaster(e)?"ui-icon-master":"ui-icon-gear")+" card-icon ui-btn-icon-notext station-settings' data-station='"+e+"' id='attrib-"+e+"' "+(p?"data-um='"+(controller.stations.masop[parseInt(e/8)]&1<<e%8?1:0)+"' ":"")+(u?"data-um2='"+(controller.stations.masop2[parseInt(e/8)]&1<<e%8?1:0)+"' ":"")+(m?"data-ir='"+(controller.stations.ignore_rain[parseInt(e/8)]&1<<e%8?1:0)+"' ":"")+(h?"data-sn1='"+(controller.stations.ignore_sn1[parseInt(e/8)]&1<<e%8?1:0)+"' ":"")+(b?"data-sn2='"+(controller.stations.ignore_sn2[parseInt(e/8)]&1<<e%8?1:0)+"' ":"")+(g?"data-ar='"+(controller.stations.act_relay[parseInt(e/8)]&1<<e%8?1:0)+"' ":"")+(f?"data-sd='"+(controller.stations.stn_dis[parseInt(e/8)]&1<<e%8?1:0)+"' ":"")+(v?"data-us='"+(controller.stations.stn_seq[parseInt(e/8)]&1<<e%8?1:0)+"' ":"")+(w?"data-hs='"+(controller.stations.stn_spe[parseInt(e/8)]&1<<e%8?1:0)+"' ":"")+"></span>",!isStationMaster(e)&&(i||n)&&(y+="<p class='rem center'>"+(n?_("Running")+" "+s:_("Scheduled")+" "+(controller.settings.ps[e][2]?_("for")+" "+dateToString(new Date(1e3*controller.settings.ps[e][2])):s)),0<o&&(y+=" <span id='countdown-"+e+"' class='nobr'>("+sec2hms(o)+" "+_("remaining")+")</span>"),y+="</p>"),y+="</div></div>"},s=function(){$("#stn_attrib").popup("destroy").remove();var e=$(this),t=e.data("station"),a=e.siblings("[id='station_"+t+"']"),i=function(e){var a=d.find("#specialOpts"),s=controller.special&&controller.special.hasOwnProperty(t)?controller.special[t].sd:"",o=controller.special&&controller.special.hasOwnProperty(t)?controller.special[t].st:0;if(a.empty(),0===e)a.append("<p class='special-desc center small'>"+_("Select the station type using the dropdown selector above and configure the station properties.")+"</p>").enhanceWithin();else if(1===e)s=o===e?s:"0000000000000000",a.append("<div class='ui-bar-a ui-bar'>"+_("RF Code")+":</div><input class='center' data-corners='false' data-wrapper-class='tight ui-btn stn-name' id='rf-code' required='true' type='text' value='"+s+"'>").enhanceWithin();else if(2===e)s=parseRemoteStationData(o===e?s:"00000000005000"),a.append("<div class='ui-bar-a ui-bar'>"+_("Remote Address")+":</div><input class='center' data-corners='false' data-wrapper-class='tight ui-btn stn-name' id='remote-address' required='true' type='text' pattern='^(?:[0-9]{1,3}.){3}[0-9]{1,3}$' value='"+s.ip+"'><div class='ui-bar-a ui-bar'>"+_("Remote Port")+":</div><input class='center' data-corners='false' data-wrapper-class='tight ui-btn stn-name' id='remote-port' required='true' type='number' placeholder='80' min='0' max='65535' value='"+s.port+"'><div class='ui-bar-a ui-bar'>"+_("Remote Station (index)")+":</div><input class='center' data-corners='false' data-wrapper-class='tight ui-btn stn-name' id='remote-station' required='true' type='number' min='1' max='48' placeholder='1' value='"+(s.station+1)+"'>").enhanceWithin();else if(3===e){// Extended special station model to support GPIO stations
// Special data for GPIO Station is three bytes of ascii decimal (not hex)
// First two bytes are zero padded GPIO pin number (default GPIO05)
// Third byte is either 0 or 1 for active low (GND) or high (+5V) relays (default 1 for HIGH)
// Restrict selection to GPIO pins available on the RPi R2.
var l=5,r=1,c,p;"OSPi"===getHWVersion()?c=[5,6,7,8,9,10,11,12,13,16,18,19,20,21,23,24,25,26]:"2.3"===getHWVersion()&&(c=[2,10,12,13,14,15,18,19]),o===e&&(s=s.split(""),l=parseInt(s[0]+s[1]),r=parseInt(s[2])),p="<div class='ui-bar-a ui-bar'>"+_("GPIO Pin")+":</div><select class='center' data-corners='false' data-wrapper-class='tight ui-btn stn-name' id='gpio-pin'>";for(var u=0;u<c.length;u++)p+="<option value='"+c[u]+"' "+(c[u]===l?"selected='selected'":"")+">"+c[u];p+="</select>",p+="<div class='ui-bar-a ui-bar'>"+_("Active State")+":</div><select class='center' data-corners='false' data-wrapper-class='tight ui-btn stn-name' id='active-state'><option value='1' "+(1===r?"selected='selected'":"")+">"+_("HIGH")+"<option value='0' "+(0===r?"selected='selected'":"")+">"+_("LOW")+"</select>",a.append(p).enhanceWithin()}else 4===e&&(s=o===e?s.split(","):["server","80","On","Off"],a.append("<div class='ui-bar-a ui-bar'>"+_("Server Name")+":</div><input class='center  validate-length' data-corners='false' data-wrapper-class='tight ui-btn stn-name' id='http-server' required='true' type='text' value='"+s[0]+"'><div class='ui-bar-a ui-bar'>"+_("Server Port")+":</div><input class='center  validate-length' data-corners='false' data-wrapper-class='tight ui-btn stn-name' id='http-port' required='true' type='number' min='0' max='65535' value='"+parseInt(s[1])+"'><div class='ui-bar-a ui-bar'>"+_("On Command")+":</div><input class='center validate-length' data-corners='false' data-wrapper-class='tight ui-btn stn-name' id='http-on' required='true' type='text' value='"+s[2]+"'><div class='ui-bar-a ui-bar'>"+_("Off Command")+":</div><input class='center validate-length' data-corners='false' data-wrapper-class='tight ui-btn stn-name' id='http-off' required='true' type='text' value='"+s[3]+"'><div class='center smaller' id='character-tracking' style='color:#999;'><p>"+_("Note: There is a limit on the number of character used to configure this station type.")+"</p><span>"+_("Characters remaining")+": </span><span id='character-count'>placeholder</span></div>").enhanceWithin(),n(),$(".validate-length").on("input",n))},n=function(){var// Maximum size of special data when uri encoded. Needs to be less than sizeof(SpecialStationData) i.e. 247 bytes
e=d.find("#http-server").val()+","+d.find("#http-port").val()+","+d.find("#http-on").val()+","+d.find("#http-off").val(),t=encodeURIComponent(e).length;d.find("#character-count").text(240-t),240<t?(d.find(".attrib-submit").addClass("ui-disabled"),d.find("#character-tracking").addClass("red-text bold")):(d.find(".attrib-submit").removeClass("ui-disabled"),d.find("#character-tracking").removeClass("red-text bold"))},s=function(n){var l=parseInt(d.find("#hs").val());if(e.data("hs",l),1===l)e.data("specialData",d.find("#rf-code").val());else if(2===l){for(var r=d.find("#remote-address").val().split("."),c=parseInt(d.find("#remote-port").val())||80,p=(d.find("#remote-station").val()||1)-1,u="",m=0;4>m;m++)u+=pad(parseInt(r[m]).toString(16));if(u+=(256>c?"00":"")+pad(c.toString(16)),u+=pad(p.toString(16)),!0!==n)return $.mobile.loading("show"),d.find(".attrib-submit").addClass("ui-disabled"),void verifyRemoteStation(u,function(e){var t;if(!0===e)return void s(!0);!1===e||-1===e?t=_("Unable to reach the remote station."):-2===e?// Likely an invalid password since the firmware version is present but no other data
t=_("Password on remote controller does not match the password on this controller."):-3===e&&(// Remote controller is not configured as an extender
t=_("Remote controller is not configured as an extender. Would you like to do this now?")),d.one("popupafterclose",function(){$.mobile.loading("hide"),a.css("opacity","")}),$.mobile.loading("show",{html:"<h1>"+t+"</h1><button class='ui-btn cancel'>"+_("Cancel")+"</button><button class='ui-btn continue'>"+_("Continue")+"</button>",textVisible:!0,theme:"b"});var a=$(".ui-loader");a.css("opacity",".96"),a.find(".cancel").one("click",function(){$.mobile.loading("hide"),a.css("opacity","")}),a.find(".continue").one("click",function(){$.mobile.loading("hide"),a.css("opacity",""),-3===e&&convertRemoteToExtender(u),s(!0)}),d.find(".attrib-submit").removeClass("ui-disabled")});e.data("specialData",u)}else if(3===l){var h=pad(d.find("#gpio-pin").val()||"05");h+=d.find("#active-state").val()||"1",e.data("specialData",h)}else if(4===l){var b=d.find("#http-server").val();b+=","+d.find("#http-port").val(),b+=","+d.find("#http-on").val(),b+=","+d.find("#http-off").val(),e.data("specialData",b)}e.data("um",d.find("#um").is(":checked")?1:0),e.data("um2",d.find("#um2").is(":checked")?1:0),e.data("ir",d.find("#ir").is(":checked")?1:0),e.data("sn1",d.find("#sn1").is(":checked")?1:0),e.data("sn2",d.find("#sn2").is(":checked")?1:0),e.data("ar",d.find("#ar").is(":checked")?1:0),e.data("sd",d.find("#sd").is(":checked")?1:0),e.data("us",d.find("#us").is(":checked")?1:0),a.html(d.find("#stn-name").val()),C[x].notes[t]=d.find("#stn-notes").val(),storage.set({sites:JSON.stringify(C)},cloudSaveSites),o(t),d.popup("destroy").remove()},d="<div data-overlay-theme='b' data-role='popup' data-theme='a' id='stn_attrib'><fieldset style='margin:0' data-mini='true' data-corners='false' data-role='controlgroup'><form><div id='station-tabs'>";if("number"!=typeof t)return!1;// Setup two tabs for station configuration (Basic / Advanced) when applicable
w&&(d+="<ul class='tabs'><li class='current' data-tab='tab-basic'>Basic</li><li data-tab='tab-advanced'>Advanced</li></ul>"),d+="<div id='tab-basic' class='tab-content current'>",d+="<div class='ui-bar-a ui-bar'>"+_("Station Name")+":</div><input class='bold center' data-corners='false' data-wrapper-class='tight stn-name ui-btn' id='stn-name' type='text' value='"+a.text()+"'>","undefined"!=typeof navigator.camera&&"function"==typeof navigator.camera.getPicture&&(d+="<button class='changeBackground'>"+("string"==typeof C[x].images[t]?_("Change"):_("Add"))+" "+_("Image")+"</button>"),isStationMaster(t)||(p&&(d+="<label for='um'><input class='needsclick' data-iconpos='right' id='um' type='checkbox' "+(1===e.data("um")?"checked='checked'":"")+">"+_("Use Master")+" "+(u?"1":"")+"</label>"),u&&(d+="<label for='um2'><input class='needsclick' data-iconpos='right' id='um2' type='checkbox' "+(1===e.data("um2")?"checked='checked'":"")+">"+_("Use Master")+" 2</label>"),m&&(d+="<label for='ir'><input class='needsclick' data-iconpos='right' id='ir' type='checkbox' "+(1===e.data("ir")?"checked='checked'":"")+">"+_("Ignore Rain")+"</label>"),h&&(d+="<label for='sn1'><input class='needsclick' data-iconpos='right' id='sn1' type='checkbox' "+(1===e.data("sn1")?"checked='checked'":"")+">"+_("Ignore Sensor 1")+"</label>"),b&&(d+="<label for='sn2'><input class='needsclick' data-iconpos='right' id='sn2' type='checkbox' "+(1===e.data("sn2")?"checked='checked'":"")+">"+_("Ignore Sensor 2")+"</label>"),g&&(d+="<label for='ar'><input class='needsclick' data-iconpos='right' id='ar' type='checkbox' "+(1===e.data("ar")?"checked='checked'":"")+">"+_("Activate Relay")+"</label>"),f&&(d+="<label for='sd'><input class='needsclick' data-iconpos='right' id='sd' type='checkbox' "+(1===e.data("sd")?"checked='checked'":"")+">"+_("Disable")+"</label>"),v&&(d+="<label for='us'><input class='needsclick' data-iconpos='right' id='us' type='checkbox' "+(1===e.data("us")?"checked='checked'":"")+">"+_("Sequential")+"</label>")),d+="<div class='ui-bar-a ui-bar'>"+_("Station Notes")+":</div><textarea data-corners='false' class='tight stn-notes' id='stn-notes'>"+(C[x].notes[t]?C[x].notes[t]:"")+"</textarea>",d+="</div>",w&&(d+="<div id='tab-advanced' class='tab-content'><div class='ui-bar-a ui-bar'>"+_("Station Type")+":</div><select data-mini='true' id='hs'"+(isStationSpecial(t)?" class='ui-disabled'":"")+"><option data-hs='0' value='0'"+(isStationSpecial(t)?"":"selected")+">"+_("Standard")+"</option><option data-hs='1' value='1'>"+_("RF")+"</option><option data-hs='2' value='2'>"+_("Remote")+"</option><option data-hs='3' value='3'"+(checkOSVersion(217)?">":" disabled>")+_("GPIO")+"</option><option data-hs='4' value='4'"+(checkOSVersion(217)?">":" disabled>")+_("HTTP")+"</option></select><div id='specialOpts'></div></div></div>"),d+="<input data-wrapper-class='attrib-submit' data-theme='b' type='submit' value='"+_("Submit")+"' /></form></fieldset></div>",d=$(d).enhanceWithin().on("submit","form",function(){return s(t),!1}),d.find("ul.tabs li").click(function(){var e=$(this).attr("data-tab");$("ul.tabs li").removeClass("current"),$(".tab-content").removeClass("current"),$(this).addClass("current"),$("#"+e).addClass("current")}),d.find("#hs").on("change",function(){var e=parseInt($(this).val());return i(e),!1}),isStationSpecial(t)?updateControllerStationSpecial(function(){d.find("#hs").removeClass("ui-disabled").find("option[data-hs='"+controller.special[t].st+"']").prop("selected",!0),d.find("#hs").change()}):(d.find("#hs").removeClass("ui-disabled"),d.find("option[data-hs='0']").prop("selected",!0),d.find("#hs").change()),d.find(".changeBackground").on("click",function(a){a.preventDefault();var e=this;takePicture(function(a){C[x].images[t]=a,storage.set({sites:JSON.stringify(C)},cloudSaveSites),r(),e.innerHTML=_("Change")+" "+_("Image")})}),$.mobile.pageContainer.append(d);var l={history:!1};if(isiOS){var c=getPageTop();l.x=c.x,l.y=c.y}else l.positionTo="window";d.popup(l).popup("open")},o=function(e){var a=!0===checkOSVersion(208),i={},n={},o={},d={},l={},r={},c={},y={},k={},x={},S,C,T,j;for(C=0;C<controller.settings.nbrd;C++)for(p&&(i["m"+C]=0),u&&(n["n"+C]=0),v&&(o["q"+C]=0),w&&(d["p"+C]=0),m&&(l["i"+C]=0),h&&(r["j"+C]=0),b&&(c["k"+C]=0),g&&(y["a"+C]=0),f&&(k["d"+C]=0),j=0;8>j;j++)T=8*C+j,S=t.find("#attrib-"+T),p&&(i["m"+C]=i["m"+C]+(S.data("um")<<j)),u&&(n["n"+C]=n["n"+C]+(S.data("um2")<<j)),v&&(o["q"+C]=o["q"+C]+(S.data("us")<<j)),w&&(d["p"+C]=d["p"+C]+((S.data("hs")?1:0)<<j)),m&&(l["i"+C]=l["i"+C]+(S.data("ir")<<j)),h&&(r["j"+C]=r["j"+C]+(S.data("sn1")<<j)),b&&(c["k"+C]=c["k"+C]+(S.data("sn2")<<j)),g&&(y["a"+C]=y["a"+C]+(S.data("ar")<<j)),f&&(k["d"+C]=k["d"+C]+(S.data("sd")<<j)),T===e&&(x["s"+T]=a?t.find("#station_"+T).text().replace(/\s/g,"_"):t.find("#station_"+T).text(),w&&S.data("hs")&&(d.st=S.data("hs"),d.sd=S.data("specialData"),d.sid=e));$.mobile.loading("show"),sendToOS("/cs?pw=&"+$.param(x)+(p?"&"+$.param(i):"")+(u?"&"+$.param(n):"")+(v?"&"+$.param(o):"")+(w?"&"+$.param(d):"")+(m?"&"+$.param(l):"")+(h?"&"+$.param(r):"")+(b?"&"+$.param(c):"")+(g?"&"+$.param(y):"")+(f?"&"+$.param(k):"")).done(function(){showerror(_("Stations have been updated")),updateController(function(){$("html").trigger("datarefresh")})})},d=function(){timers.clock={val:controller.settings.devt,update:function(){t.find("#clock-s").text(dateToString(new Date(1e3*this.val),null,1))}}},l=function(){var e=t.find("#os-stations-list"),a=t.find("#os-running-stations"),i=t.find(".content-divider"),n=function(e,t){return e=$(e).data("station"),t=$(t).data("station"),e<t?-1:e>t?1:0};// Move running stations up
e.find(".station-status.on").parents(".card").appendTo(a),a.find(".station-status.off").parents(".card").appendTo(e),e.children().sort(n).detach().appendTo(e),a.children().sort(n).detach().appendTo(a),0===a.children().length?i.hide():i.show()},r=function(){var e=t.find("#os-stations-list"),s=e.children(),o=t.find("#os-running-stations").children(),r,S,T,j,P,O,D;if(t.hasClass("ui-page-active")){d(),c(),s.length+o.length>controller.stations.snames.length&&(o.detach().appendTo(e),s=e.children(),s.each(function(){var e=$(this);e.data("station")>=controller.stations.snames.length&&e.remove()})),t.find(".waterlevel").text(controller.options.wl),t.find(".sitename").text(k.val()),p=!!controller.options.mas,u=!!controller.options.mas2,m="object"==typeof controller.stations.ignore_rain,h="object"==typeof controller.stations.ignore_sn1,b="object"==typeof controller.stations.ignore_sn2,g="object"==typeof controller.stations.act_relay,f="object"==typeof controller.stations.stn_dis,v="object"==typeof controller.stations.stn_seq,w="object"==typeof controller.stations.stn_spe;for(var M=0;M<controller.stations.snames.length;M++)r=0<controller.settings.ps[M][0],S=0<controller.status[M],T=r?pidname(controller.settings.ps[M][0]):"",j=controller.settings.ps[M][1],D=!!C[x].images[M],P=s.filter("[data-station='"+M+"']"),0===P.length&&(P=o.filter("[data-station='"+M+"']")),0===P.length?(y="",n(M),e.append(y)):(P.find(".ui-body > img").attr("src",D?"data:image/jpeg;base64,"+C[x].images[M]:getAppURLPath()+"img/placeholder.png"),isStationDisabled(M)?(!t.hasClass("show-hidden")&&P.hide(),P.addClass("station-hidden")):P.show().removeClass("station-hidden"),P.find("#station_"+M).text(controller.stations.snames[M]),P.find(".special-station").removeClass("hidden").addClass(isStationSpecial(M)?"":"hidden"),P.find(".station-status").removeClass("on off wait").addClass(S?"on":r?"wait":"off"),isStationMaster(M)?P.find(".station-settings").removeClass("ui-icon-gear").addClass("ui-icon-master"):P.find(".station-settings").removeClass("ui-icon-master").addClass("ui-icon-gear"),P.find(".station-settings").data({um:p?controller.stations.masop[parseInt(M/8)]&1<<M%8?1:0:void 0,um2:u?controller.stations.masop2[parseInt(M/8)]&1<<M%8?1:0:void 0,ir:m?controller.stations.ignore_rain[parseInt(M/8)]&1<<M%8?1:0:void 0,sn1:h?controller.stations.ignore_sn1[parseInt(M/8)]&1<<M%8?1:0:void 0,sn2:b?controller.stations.ignore_sn2[parseInt(M/8)]&1<<M%8?1:0:void 0,ar:g?controller.stations.act_relay[parseInt(M/8)]&1<<M%8?1:0:void 0,sd:f?controller.stations.stn_dis[parseInt(M/8)]&1<<M%8?1:0:void 0,us:v?controller.stations.stn_seq[parseInt(M/8)]&1<<M%8?1:0:void 0,hs:w?controller.stations.stn_spe[parseInt(M/8)]&1<<M%8?1:0:void 0}),!isStationMaster(M)&&(r||S)?(O=S?_("Running")+" "+T:_("Scheduled")+" "+(controller.settings.ps[M][2]?_("for")+" "+dateToString(new Date(1e3*controller.settings.ps[M][2])):T),0<j&&(O+=" <span id='countdown-"+M+"' class='nobr'>("+sec2hms(j)+" "+_("remaining")+")</span>",controller.status[M]&&a(M,j)),0===P.find(".rem").length?P.find(".ui-body").append("<p class='rem center'>"+O+"</p>"):P.find(".rem").html(O)):P.find(".rem").remove());l()}},c=function(e){e=e||function(){},x=k.val(),storage.get("sites",function(a){C=parseSites(a.sites),"object"!=typeof C[x].images||$.isEmptyObject(C[x].images)?(C[x].images={},t.removeClass("has-images")):t.addClass("has-images"),"object"!=typeof C[x].notes&&(C[x].notes={}),"object"!=typeof C[x].lastRunTime&&(C[x].lastRunTime={}),e()})},p,u,m,h,b,g,f,v,w,y,k,x,S,C;return t.one("pageshow",function(){$("html").on("datarefresh",r)}),e}(),showStart=function(){var e=$("<div data-role='page' id='start'><ul data-role='none' id='welcome_list' class='ui-listview ui-listview-inset ui-corner-all'><li><div class='logo' id='welcome_logo'></div></li><li class='ui-li-static ui-body-inherit ui-first-child ui-last-child ui-li-separate'><p class='rain-desc'>"+_("Welcome to the OpenSprinkler application. This app only works with the OpenSprinkler controller which must be installed and setup on your home network.")+"</p><a class='iab iabNoScale ui-btn ui-mini center' target='_blank' href='https://opensprinkler.com/product/opensprinkler/'>"+_("Purchase OpenSprinkler")+"</a></li><li class='ui-first-child ui-last-child'><a href='#' class='ui-btn center cloud-login'>"+_("OpenSprinkler.com Login")+"</a></li><hr class='content-divider'><li id='auto-scan' class='ui-first-child'><a href='#' class='ui-btn ui-btn-icon-right ui-icon-carat-r'>"+_("Scan For Device")+"</a></li><li class='ui-first-child ui-last-child'><a class='ui-btn ui-btn-icon-right ui-icon-carat-r' data-rel='popup' href='#addnew'>"+_("Add Controller")+"</a></li></ul></div>"),t=function(){updateDeviceIP(function(e){//Change main menu items to reflect ability to automatically scan
return void 0===e?void a():isLocalIP(e)?void(n.removeClass("ui-first-child").find("a.ui-btn").text(_("Manually Add Device")),i.show()):void a();// Check if the IP is on a private network, if not don't enable automatic scanning
})},a=function(){n.addClass("ui-first-child").find("a.ui-btn").text(_("Add Controller")),i.hide()},i=e.find("#auto-scan"),n=i.next();return e.find("#auto-scan").find("a").on("click",function(){return startScan(),!1}),e.find("a[href='#addnew']").on("click",function(){showAddNew()}),e.find(".cloud-login").on("click",function(){return requestCloudAuth(),!1}),e.on("pagehide",function(){e.detach()}),function(){return!isControllerConnected()&&void($("#start").remove(),$.mobile.pageContainer.append(e),t())}}();function showGuidedSetup(){// Stub for guided setup page
}function isStationMaster(e){var t="number"==typeof controller.options.mas?controller.options.mas:0,a="number"==typeof controller.options.mas2?controller.options.mas2:0;return e++,t===e?1:a===e?2:0}function isStationDisabled(e){return"object"==typeof controller.stations.stn_dis&&0<(controller.stations.stn_dis[parseInt(e/8)]&1<<e%8)}function isStationSpecial(e){return"object"==typeof controller.stations.stn_spe&&0<(controller.stations.stn_spe[parseInt(e/8)]&1<<e%8)}function isStationSequential(e){return"object"==typeof controller.stations.stn_seq?0<(controller.stations.stn_seq[parseInt(e/8)]&1<<e%8):controller.options.seq}function parseRemoteStationData(e){e=e.split("");for(var t=[],a={},n=0,s;8>n;n++)s=parseInt(e[n]+e[n+1],16)||0,t.push(s),n++;return a.ip=t.join("."),a.port=parseInt(e[8]+e[9]+e[10]+e[11],16),a.station=parseInt(e[12]+e[13],16),a}function verifyRemoteStation(e,t){e=parseRemoteStationData(e),$.ajax({url:"http://"+e.ip+":"+e.port+"/jo?pw="+encodeURIComponent(currPass),type:"GET",dataType:"json"}).then(function(e){"object"==typeof e&&e.hasOwnProperty("fwv")?1===Object.keys(e).length?t(-2):e.hasOwnProperty("re")&&0!==e.re?t(!0):t(-3):t(-1)},function(){t(!1)})}function convertRemoteToExtender(e){e=parseRemoteStationData(e),$.ajax({url:"http://"+e.ip+":"+e.port+"/cv?re=1&pw="+encodeURIComponent(currPass),type:"GET",dataType:"json"})}// Current status related functions
function refreshStatus(){if(isControllerConnected()){var e=function(){return $("html").trigger("datarefresh"),void checkStatus()};checkOSVersion(216)?updateController(e,networkFail):$.when(updateControllerStatus(),updateControllerSettings(),updateControllerOptions()).then(e,networkFail)}}function refreshData(){isControllerConnected()&&(checkOSVersion(216)?updateController(null,networkFail):$.when(updateControllerPrograms(),updateControllerStations()).fail(networkFail))}// Actually change the status bar
function changeStatus(e,t,a,i){var n=$("#footer-running"),s="";i=i||function(){},1<e&&(timers.statusbar={val:e,type:"statusbar",update:function(){$("#countdown").text("("+sec2hms(this.val)+" "+_("remaining")+")")}}),isControllerConnected()&&"undefined"!=typeof controller.settings.curr&&(s+=_("Current")+": "+controller.settings.curr+" mA "),isControllerConnected()&&(2===controller.options.urs||2===controller.options.sn1t)&&"undefined"!=typeof controller.settings.flcrt&&"undefined"!=typeof controller.settings.flwrt&&(s+="<span style='padding-left:5px'>"+_("Flow")+": "+(flowCountToVolume(controller.settings.flcrt)/(controller.settings.flwrt/60)).toFixed(2)+" L/min</span>"),s=""===s?a:a+"<p class='running-text smaller center'>"+s+"</p>",n.removeClass().addClass(t).html(s).off("click").on("click",i)}// Update status bar based on device status
function checkStatus(){var e,t,a,n,s,o,d,l,r;if(!isControllerConnected())return void changeStatus(0,"transparent","<p class='running-text smaller'></p>");// Handle controller configured as extender
if(1===controller.options.re)return void changeStatus(0,"red","<p class='running-text center pointer'>"+_("Configured as Extender")+"</p>",function(){areYouSure(_("Do you wish to disable extender mode?"),"",function(){showLoading("#footer-running"),sendToOS("/cv?pw=&re=0").done(function(){updateController()})})});// Handle operation disabled
if(!controller.settings.en)return void changeStatus(0,"red","<p class='running-text center pointer'>"+_("System Disabled")+"</p>",function(){areYouSure(_("Do you want to re-enable system operation?"),"",function(){showLoading("#footer-running"),sendToOS("/cv?pw=&en=1").done(function(){updateController()})})});// Handle open stations
for(e={},r=0;r<controller.status.length;r++)controller.status[r]&&!isStationMaster(r)&&(e[r]=controller.status[r]);// Handle more than 1 open station
if(2<=Object.keys(e).length){for(r in t=0,e)e.hasOwnProperty(r)&&(l=controller.settings.ps[r][1],l>t&&(t=l));return a=Object.keys(e)[0],n=controller.settings.ps[a][0],s=pidname(n),o="<div><div class='running-icon'></div><div class='running-text pointer'>",o+=s+" "+_("is running on")+" "+Object.keys(e).length+" "+_("stations")+" ",0<t&&(o+="<span id='countdown' class='nobr'>("+sec2hms(t)+" "+_("remaining")+")</span>"),o+="</div></div>",void changeStatus(t,"green",o,goHome)}// Handle a single station open
for(d=!1,r=0;r<controller.stations.snames.length;r++)if(controller.settings.ps[r]&&controller.settings.ps[r][0]&&controller.status[r]&&!isStationMaster(r)){d=!0,n=controller.settings.ps[r][0],s=pidname(n),o="<div><div class='running-icon'></div><div class='running-text pointer'>",o+=s+" "+_("is running on station")+" <span class='nobr'>"+controller.stations.snames[r]+"</span> ",0<controller.settings.ps[r][1]&&(o+="<span id='countdown' class='nobr'>("+sec2hms(controller.settings.ps[r][1])+" "+_("remaining")+")</span>"),o+="</div></div>";break}if(d)return void changeStatus(controller.settings.ps[r][1],"green",o,goHome);// Handle rain delay enabled
if(controller.settings.rd)return void changeStatus(0,"red","<p class='running-text center pointer'>"+_("Rain delay until")+" "+dateToString(new Date(1e3*controller.settings.rdst))+"</p>",function(){areYouSure(_("Do you want to turn off rain delay?"),"",function(){showLoading("#footer-running"),sendToOS("/cv?pw=&rd=0").done(function(){updateController()})})});// Handle rain sensor triggered
if(1===controller.options.urs&&1===controller.settings.rs)return void changeStatus(0,"red","<p class='running-text center'>"+_("Rain detected")+"</p>");if(1===controller.settings.sn1)return void changeStatus(0,"red","<p class='running-text center'>Sensor 1 ("+(3===controller.options.sn1t?_("Soil"):_("Rain"))+_(") Activated")+"</p>");if(1===controller.settings.sn2)return void changeStatus(0,"red","<p class='running-text center'>Sensor 2 ("+(3===controller.options.sn2t?_("Soil"):_("Rain"))+_(") Activated")+"</p>");// Handle manual mode enabled
if(1===controller.settings.mm)return void changeStatus(0,"red","<p class='running-text center pointer'>"+_("Manual mode enabled")+"</p>",function(){areYouSure(_("Do you want to turn off manual mode?"),"",function(){showLoading("#footer-running"),sendToOS("/cv?pw=&mm=0").done(function(){updateController()})})});var c=controller.settings.lrun[2];// If last run duration is given, add it to the footer
if(0!==c){var p=controller.settings.lrun[1];return s=pidname(p),void changeStatus(0,"transparent","<p class='running-text smaller center pointer'>"+s+" "+_("last ran station")+" "+controller.stations.snames[controller.settings.lrun[0]]+" "+_("for")+" "+(c/60>>0)+"m "+c%60+"s "+_("on")+" "+dateToString(new Date(1e3*(controller.settings.lrun[3]-c)))+"</p>",goHome)}changeStatus(0,"transparent","<p class='running-text smaller center pointer'>"+_("System Idle")+"</p>",goHome)}function calculateTotalRunningTime(e){var t=Math.max,a=0,n=0;return $.each(controller.stations.snames,function(t){var i=e[t];isStationSequential(t)?a+=i:i>n&&(n=i)}),t(a,n)}// Handle timer update on the home page and status bar
function updateTimers(){var e=new Date().getTime();setInterval(function(){if(!isControllerConnected())return!1;// Handle time drift
var t=new Date().getTime(),a=t-e;// If no timers are defined then exit
if(2e3<a&&(checkStatus(),refreshStatus()),e=t,!$.isEmptyObject(timers))for(var i in timers)timers.hasOwnProperty(i)&&(0>=timers[i].val?("statusbar"===i&&(showLoading("#footer-running"),refreshStatus()),"function"==typeof timers[i].done&&timers[i].done(),delete timers[i]):"clock"===i?(++timers[i].val,timers[i].update()):("statusbar"===i||"number"==typeof timers[i].station)&&(--timers[i].val,timers[i].update()))},1e3)}function removeStationTimers(){for(var e in timers)timers.hasOwnProperty(e)&&"clock"!==e&&delete timers[e]}// Manual control functions
var getManual=function(){function e(){var e="<li data-role='list-divider' data-theme='a'>"+_("Sprinkler Stations")+"</li>";t.find("#mmm").prop("checked",!!controller.settings.mm),$.each(controller.stations.snames,function(t,a){e+=isStationMaster(t)?"<li data-icon='false' class='center"+(controller.status[t]?" green":"")+(isStationDisabled(t)?" station-hidden' style='display:none":"")+"'>"+a+" ("+_("Master")+")</li>":"<li data-icon='false'><a class='mm_station center"+(controller.status[t]?" green":"")+(isStationDisabled(t)?" station-hidden' style='display:none":"")+"'>"+a+"</a></li>"}),o=$("<ul data-role='listview' data-inset='true' id='mm_list'>"+e+"</ul>"),d=o.children("li").slice(1),o.find(".mm_station").on("vclick",i),t.find("#manual-station-list").html(o).enhanceWithin(),changeHeader({title:_("Manual Control"),leftBtn:{icon:"carat-l",text:_("Back"),class:"ui-toolbar-back-btn",on:goBack}}),$("#manual").remove(),$.mobile.pageContainer.append(t)}var t=$("<div data-role='page' id='manual'><div class='ui-content' role='main'><p class='center'>"+_("With manual mode turned on, tap a station to toggle it.")+"</p><fieldset data-role='collapsible' data-collapsed='false' data-mini='true'><legend>"+_("Options")+"</legend><div class='ui-field-contain'><label for='mmm'><b>"+_("Manual Mode")+"</b></label><input type='checkbox' data-on-text='On' data-off-text='Off' data-role='flipswitch' name='mmm' id='mmm'></div><p class='rain-desc smaller center' style='padding-top:5px'>"+_("Station timer prevents a station from running indefinitely and will automatically turn it off after the set duration (or when toggled off)")+"</p><div class='ui-field-contain duration-input'><label for='auto-off'><b>"+_("Station Timer")+"</b></label><button data-mini='true' name='auto-off' id='auto-off' value='3600'>1h</button></div></fieldset><div id='manual-station-list'></div></div></div>"),a=function(e){updateControllerStatus().done(function(){var t=d.eq(e).find("a");controller.options.mas&&(controller.status[controller.options.mas-1]?d.eq(controller.options.mas-1).addClass("green"):d.eq(controller.options.mas-1).removeClass("green")),t.text(controller.stations.snames[e]),controller.status[e]?t.removeClass("yellow").addClass("green"):t.removeClass("green yellow")})},i=function(){if(!controller.settings.mm)return showerror(_("Manual mode is not enabled. Please enable manual mode then try again.")),!1;var e=$(this),t=e.closest("li"),i=d.index(t),o=i+1,l=n.val();return!e.hasClass("yellow")&&(s=controller.status[i]?checkOSPiVersion("2.1")?"/sn?sid="+o+"&set_to=0&pw=":"/sn"+o+"=0":checkOSPiVersion("2.1")?"/sn?sid="+o+"&set_to=1&set_time="+l+"&pw=":"/sn"+o+"=1&t="+l,e.removeClass("green").addClass("yellow"),e.html("<p class='ui-icon ui-icon-loading mini-load'></p>"),sendToOS(s).always(function(){setTimeout(a,1e3,i)}),!1)},n=t.find("#auto-off"),s,o,d;return t.on("pagehide",function(){t.detach()}),storage.get("autoOff",function(e){e.autoOff&&(n.val(e.autoOff),n.text(dhms2str(sec2dhms(e.autoOff))))}),n.on("click",function(){var e=$(this),a=t.find("label[for='"+e.attr("id")+"']").text();return showDurationBox({seconds:e.val(),title:a,callback:function(t){e.val(t),e.text(dhms2str(sec2dhms(t))),storage.set({autoOff:t})},maximum:32768}),!1}),t.find("#mmm").on("change",flipSwitched),e}(),getRunonce=function(){function e(){if(d="<p class='center'>"+_("Zero value excludes the station from the run-once program.")+"</p>",r=[],controller.programs.pd.length)for(p=0;p<controller.programs.pd.length;p++){u=readProgram(controller.programs.pd[p]);var e=[];if(checkOSVersion(210))e=u.stations;else{var i=u.stations.split("");for(o=0;o<controller.stations.snames.length;o++)e.push(parseInt(i[o])?u.duration:0)}r.push(e)}for(c=r,l="<select data-mini='true' name='rprog' id='rprog'><option value='t'>"+_("Test All Stations")+"</option><option value='s' selected='selected'>"+_("Quick Programs")+"</option>",o=0;o<r.length;o++)m=checkOSVersion(210)?controller.programs.pd[o][5]:_("Program")+" "+(o+1),l+="<option value='"+o+"'>"+m+"</option>";if(l+="</select>",d+=l+"<form>",$.each(controller.stations.snames,function(e,t){d+=isStationMaster(e)?"<div class='ui-field-contain duration-input"+(isStationDisabled(e)?" station-hidden' style='display:none":"")+"'><label for='zone-"+e+"'>"+t+":</label><button disabled='true' data-mini='true' name='zone-"+e+"' id='zone-"+e+"' value='0'>Master</button></div>":"<div class='ui-field-contain duration-input"+(isStationDisabled(e)?" station-hidden' style='display:none":"")+"'><label for='zone-"+e+"'>"+t+":</label><button data-mini='true' name='zone-"+e+"' id='zone-"+e+"' value='0'>0s</button></div>"}),d+="</form><a class='ui-btn ui-corner-all ui-shadow rsubmit' href='#'>"+_("Submit")+"</a><a class='ui-btn ui-btn-b ui-corner-all ui-shadow rreset' href='#'>"+_("Reset")+"</a>",t.find(".ui-content").html(d).enhanceWithin(),"object"==typeof controller.settings.rodur){var h=0;for(o=0;o<controller.settings.rodur.length;o++)h+=controller.settings.rodur[o];0!==h&&a(controller.settings.rodur)}else storage.get("runonce",function(e){e=e.runonce,e&&(e=JSON.parse(e),a(e))});t.find("#rprog").on("change",function(){var e=$(this).val();return"s"===e?void n():"t"===e?void s(Array.apply(null,Array(controller.stations.snames.length)).map(function(){return 60})):void("undefined"==typeof c[e]||s(c[e]))}),t.on("click",".rsubmit",submitRunonce).on("click",".rreset",n),t.find("[id^='zone-']").on("click",function(){var e=$(this),a=t.find("label[for='"+e.attr("id")+"']").text().slice(0,-1);return showDurationBox({seconds:e.val(),title:a,callback:function(t){e.val(t),e.text(getDurationText(t)),0<t?e.addClass("green"):e.removeClass("green")},maximum:65535,showSun:!!checkOSVersion(214)}),!1}),changeHeader({title:_("Run-Once"),leftBtn:{icon:"carat-l",text:_("Back"),class:"ui-toolbar-back-btn",on:goBack},rightBtn:{icon:"check",text:_("Submit"),on:submitRunonce}}),$("#runonce").remove(),$.mobile.pageContainer.append(t)}var t=$("<div data-role='page' id='runonce'><div class='ui-content' role='main' id='runonce_list'></div></div>"),a=function(e){c.l=e,$("<option value='l' selected='selected'>"+_("Last Used Program")+"</option>").insertAfter(t.find("#rprog").find("option[value='t']")),s(e)},n=function(){return t.find("[id^='zone-']").val(0).text("0s").removeClass("green"),!1},s=function(e){t.find("[id^='zone-']").each(function(t,a){if(!isStationMaster(t)){var i=$(a);i.val(e[t]).text(getDurationText(e[t])),0<e[t]?i.addClass("green"):i.removeClass("green")}})},o,d,l,r,c,p,u,m;return t.on("pagehide",function(){t.detach()}),e}();// Runonce functions
function submitRunonce(e){e instanceof Array||(e=[],$("#runonce").find("[id^='zone-']").each(function(){e.push(parseInt(this.value)||0)}),e.push(0));var t=function(){$.mobile.loading("show"),storage.set({runonce:JSON.stringify(e)}),sendToOS("/cr?pw=&t="+JSON.stringify(e)).done(function(){$.mobile.loading("hide"),$.mobile.document.one("pageshow",function(){showerror(_("Run-once program has been scheduled"))}),refreshStatus(),goBack()})},a=isRunning();-1===a?t():areYouSure(_("Do you want to stop the currently running program?"),pidname(controller.settings.ps[a][0]),function(){$.mobile.loading("show"),stopStations(t)})}// Preview functions
var getPreview=function(){var t=Math.floor,a=Math.round;function e(){k=checkOSVersion(210),x=checkOSVersion(211),S=checkOSVersion(216),""===i.find("#preview_date").val()&&(y=new Date(1e3*controller.settings.devt),v=y.toISOString().slice(0,10).split("-"),w=new Date(v[0],v[1]-1,v[2]),i.find("#preview_date").val(v.join("-"))),changeHeader({title:_("Program Preview"),leftBtn:{icon:"carat-l",text:_("Back"),class:"ui-toolbar-back-btn",on:goBack}}),$("#preview").remove(),$.mobile.pageContainer.append(i)}var i=$("<div data-role='page' id='preview'><div class='ui-content' role='main'><div id='preview_header' class='input_with_buttons'><button class='preview-minus ui-btn ui-btn-icon-notext ui-icon-carat-l btn-no-border'></button><input class='center' type='date' name='preview_date' id='preview_date'><button class='preview-plus ui-btn ui-btn-icon-notext ui-icon-carat-r btn-no-border'></button></div><div id='timeline'></div><div data-role='controlgroup' data-type='horizontal' id='timeline-navigation'><a class='ui-btn ui-corner-all ui-icon-plus ui-btn-icon-notext btn-no-border' title='"+_("Zoom in")+"'></a><a class='ui-btn ui-corner-all ui-icon-minus ui-btn-icon-notext btn-no-border' title='"+_("Zoom out")+"'></a><a class='ui-btn ui-corner-all ui-icon-carat-l ui-btn-icon-notext btn-no-border' title='"+_("Move left")+"'></a><a class='ui-btn ui-corner-all ui-icon-carat-r ui-btn-icon-notext btn-no-border' title='"+_("Move right")+"'></a></div></div></div>"),n=i.find("#timeline"),s=i.find("#timeline-navigation"),o,d,l,r,c,p,u,m,h,b,g,f,v,w,y,k,x,S;return i.find("#preview_date").on("change",function(){v=this.value.split("-"),w=new Date(v[0],v[1]-1,v[2]),f()}),i.one("pagebeforeshow",function(){holdButton(i.find(".preview-plus"),function(){g(1)}),holdButton(i.find(".preview-minus"),function(){g(-1)})}),i.on({pagehide:function(){i.detach()},pageshow:function(){f()}}),d=function(e,a,i){o=[];var n=t(controller.settings.devt/86400),d=0,r=Date.UTC(i,e-1,a,0,0,0,0),c=r/1e3/3600/24>>0,p=8*controller.settings.nbrd,u=Array(p),b=Array(p),g=Array(p),f=Array(p),// Runtime queue for FW 2.1.6+
v=[],// Station qid for FW 2.1.6+
w=Array(p),y=0,_=0,C,T,j,P,O,D,M,A,U,W,E;for(P=0;P<p;P++)u[P]=-1,b[P]=0,g[P]=0,f[P]=0,w[P]=255;do{C=0,T=0;for(var I=0;I<controller.programs.pd.length;I++)if(j=controller.programs.pd[I],l(j,d,r,c,n))for(P=0;P<p;P++)// Skip master station
if(A=P>>3,W=P%8,!isStationMaster(P))if(k){// Skip disabled stations
if(controller.stations.stn_dis[A]&1<<W)continue;// Skip if water time is zero, or station is already scheduled
if(j[4][P]&&0===g[P]){var R=0;// Use weather scaling bit on
R=2&j[0]&&(0<controller.options.uwt&&c===n||0===controller.options.uwt)?getStationDuration(j[4][P],r)*controller.options.wl/100>>0:getStationDuration(j[4][P],r),0<R&&(S?v.length<p&&v.push({st:-1,dur:R,sid:P,pid:I+1,pl:1}):(g[P]=R,b[P]=I+1),T=1)}}else j[7+A]&1<<W&&(g[P]=j[6]*controller.options.wl/100>>0,b[P]=I+1,T=1);if(T){var L=60*d,B=L;if(x){if(_>L&&(B=_+controller.options.sdt),S)// Schedule all stations
for(O=0;O<v.length;O++)// Check if already scheduled or water time is zero
(D=v[O],!(0<=D.st||0===D.dur))&&(P=D.sid,U=P>>3,E=7&P,controller.stations.stn_seq[U]&1<<E?(D.st=B,B+=D.dur,B+=controller.options.sdt):(D.st=L,L++),C=1);else for(P=0;P<p;P++)(U=P>>3,E=7&P,!(0===g[P]||0<=u[P]))&&(controller.stations.stn_seq[U]&1<<E?(u[P]=B,B+=g[P],g[P]=B,B+=controller.options.sdt,f[P]=1):(u[P]=L,g[P]=L+g[P],f[P]=1),C=1);}else if(k&&controller.options.seq&&y>L&&(L=y+controller.options.sdt),controller.options.seq)for(P=0;P<8*controller.settings.nbrd;P++)0!==g[P]&&0!==b[P]&&(u[P]=L,L+=g[P],g[P]=L,L+=controller.options.sdt,C=1);else for(P=0;P<8*controller.settings.nbrd;P++)0!==g[P]&&0!==b[P]&&(u[P]=L,g[P]=L+g[P],C=1)}if(S){// Go through queue and assign queue elements to stations
for(O=0;O<v.length;O++)(D=v[O],P=D.sid,M=w[P],!(255>M&&v[M].st<D.st))&&(w[P]=O);// Next, go through stations and calculate the schedules
// Go through stations and remove jobs that have been done
for(h(60*d,v,w,r),d++,P=0;P<8*controller.settings.nbrd;P++)if((M=w[P],255!==M)&&(D=v[M],0<=D.st&&60*d>=D.st+D.dur)){// Remove element at index sqi
var N=v.length;M<N-1&&(v[M]=v[N-1],w[v[M].sid]===N-1&&(w[v[M].sid]=M)),v.pop(),w[P]=255}// Lastly, calculate lastSeqStopTime
for(_=0,O=0;O<v.length;O++){D=v[O],P=D.sid,U=P>>3,E=7&P;var F=D.st+D.dur;controller.stations.stn_seq[U]&1<<E&&F>_&&(_=F)}}else// Handle firmwares prior to 2.1.6
if(C){if(x)for(_=m(60*d,u,b,g,f,r),d++,P=0;P<8*controller.settings.nbrd;P++)0<b[P]&&60*d>=g[P]&&(u[P]=-1,b[P]=0,g[P]=0,f[P]=0);else if(k)for(y=m(60*d,u,b,g,f,r),d++,P=0;P<8*controller.settings.nbrd;P++)u[P]=-1,b[P]=0,g[P]=0;else{var z=m(60*d,u,b,g,f,r)/60>>0;for(controller.options.seq&&d!==z?d=z:d++,P=0;P<8*controller.settings.nbrd;P++)u[P]=-1,b[P]=0,g[P]=0}}else if(d++,x)for(P=0;P<8*controller.settings.nbrd;P++)0<b[P]&&60*d>=g[P]&&(u[P]=-1,b[P]=0,g[P]=0,f[P]=0)}while(1440>d)},h=function(e,t,a,i){for(var n=0,s;n<8*controller.settings.nbrd;n++)if(s=a[n],255!==s){var d=t[s];if(d.pl){// If this one hasn't been plotted
var l="undefined"!=typeof controller.options.mas2,r=controller.stations.masop[n>>3]&1<<n%8,c=!!l&&controller.stations.masop2[n>>3]&1<<n%8;isStationMaster(n)||(0<controller.options.mas&&r&&o.push({start:d.st+controller.options.mton,end:d.st+d.dur+controller.options.mtof,content:"",className:"master",shortname:"M"+(l?"1":""),group:"Master",station:n}),l&&0<controller.options.mas2&&c&&o.push({start:d.st+controller.options.mton2,end:d.st+d.dur+controller.options.mtof2,content:"",className:"master",shortname:"M2",group:"Master 2",station:n})),b(n,d.st,d.pid,d.st+d.dur,i),d.pl=0}}},m=function(e,t,a,i,n,s){for(var d=e,l=0;l<8*controller.settings.nbrd;l++)if(a[l])if(!x)1===controller.options.seq?(isStationMaster(l)&&controller.stations.masop[l>>3]&1<<l%8&&o.push({start:t[l]+controller.options.mton,end:i[l]+controller.options.mtof,content:"",className:"master",shortname:"M",group:"Master",station:l}),b(l,t[l],a[l],i[l],s),d=i[l]):(b(l,e,a[l],i[l],s),isStationMaster(l)&&controller.stations.masop[l>>3]&1<<l%8&&(d=d>i[l]?d:i[l]));else if(n[l]){var r="undefined"!=typeof controller.options.mas2,c=controller.stations.masop[l>>3]&1<<l%8,p=!!r&&controller.stations.masop2[l>>3]&1<<l%8;isStationMaster(l)||(0<controller.options.mas&&c&&o.push({start:t[l]+controller.options.mton,end:i[l]+controller.options.mtof,content:"",className:"master",shortname:"M"+(r?"1":""),group:"Master",station:l}),r&&0<controller.options.mas2&&p&&o.push({start:t[l]+controller.options.mton2,end:i[l]+controller.options.mtof2,content:"",className:"master",shortname:"M2",group:"Master 2",station:l})),b(l,t[l],a[l],i[l],s),n[l]=0,controller.stations.stn_seq[l>>3]&1<<(7&l)&&(d=d>i[l]?d:i[l])}return!x&&0===controller.options.seq&&0<controller.options.mas&&o.push({start:e,end:d,content:"",className:"master",shortname:"M",group:"Master",station:l}),d},b=function(e,t,a,i,n){var s="program-"+(a+3)%4,d="P"+a;(0!==controller.settings.rd&&n+t+900*(controller.options.tz-48)<=1e3*controller.settings.rdst||1===controller.options.urs&&1===controller.settings.rs)&&"object"==typeof controller.stations.ignore_rain&&0==(controller.stations.ignore_rain[parseInt(e/8)]&1<<e%8)&&(s="delayed"),checkOSVersion(210)&&(d=controller.programs.pd[a-1][5]),o.push({start:t,end:i,className:s,content:d,pid:a-1,shortname:"S"+(e+1),group:controller.stations.snames[e],station:e})},l=function(e,t,a,i,n){return S?u(e,t,a,i,n):k?c(e,t,a,i,n):r(e,t,a,i,n)},r=function(e,t,a,i,n){if(0===e[0])return 0;if(128&e[1]&&1<e[2]){var s=e[2],o=127&e[1];if(i%s!=(n+o)%s)return 0}else{var d=new Date(a),l=(d.getUTCDay()+6)%7;if(0==(e[1]&1<<l))return 0;var r=d.getUTCDate();if(128&e[1]&&0===e[2]&&0!=r%2)return 0;if(128&e[1]&&1===e[2]&&(31===r||29===r&&1===d.getUTCMonth()||1!=r%2))return 0}return t<e[3]||t>e[4]||isOSPi()&&t>=e[4]?0:0===e[5]?0:((t-e[3])/e[5]>>0)*e[5]==t-e[3]?1:0},p=function(e,t,a,i){var n=3&e[0]>>2,s=3&e[0]>>4,o=new Date(t);if(3==s){// Interval program
var d=e[2],l=e[1];if(a%d!=(i+l)%d)return 0}else if(0==s){// Weekly program
var r=(o.getUTCDay()+6)%7;if(0==(e[1]&1<<r))return 0}else return 0;// Odd/Even restriction handling
var c=o.getUTCDate();if(2==n){if(0!=c%2)return 0;}else if(1==n&&(31===c||29===c&&1===o.getUTCMonth()||1!=c%2))return 0;return 1},c=function(e,t,n,s,o){var d=1&e[0],l=1&e[0]>>6,r=new Date(n);if(0==d)return 0;if(!p(e,n,s,o))return 0;// Start time matching
if(0==l){// Repeating program
var u=getStartTime(e[3][0],r),m=e[3][1],h=e[3][2];if(t<u)return 0;if(0===m)// Single run program
return t===u?1:0;if(0===h)// If this is a multi-run, cycle time must be > 0
return 0;var b=a((t-u)/h);if(b*h==t-u&&b<=m)return 1}else for(var c=e[3],g=0;4>g;g++)if(t===getStartTime(c[g],r))return 1;// Set start time program
return 0},u=function(e,t,n,s,o){var d=1&e[0],l=1&e[0]>>6,r=new Date(n);if(0==d)return 0;var u=getStartTime(e[3][0],r),m=e[3][1],h=e[3][2],b;// Check if simday matches the program start days
if(p(e,n,s,o))// Match the start time
if(0==l){// Repeating program
if(t===u)return 1;if(t>u&&h&&(b=a((t-u)/h),b*h==t-u&&b<=m))return 1}else{for(var g=e[3],f=0;4>f;f++)if(t===getStartTime(g[f],r))return 1;// Set start time program
return 0}// To proceed, the program has to be repeating type,
// and interval and repeat must be non-zero
return l||!h?0:p(e,n-864e5,s-1,o)&&(b=a((t-u+1440)/h),b*h==t-u+1440&&b<=m)?1:0;// Check if the previous day is a program start day
},g=function(e){w.setDate(w.getDate()+e);var t=pad(w.getMonth()+1),a=pad(w.getDate()),n=w.getFullYear();v=[n,t,a],i.find("#preview_date").val(v.join("-")),f()},f=function(){if(d(v[1],v[2],v[0]),s.hide(),!o.length)return void i.find("#timeline").html("<p align='center'>"+_("No stations set to run on this day.")+"</p>");o.sort(sortByStation);var e=[],a=new Date(v[0],v[1]-1,v[2],24);$.each(o,function(){var i=this.start+this.end;if(this.start=new Date(v[0],v[1]-1,v[2],0,0,this.start),86400<i){var n=t(this.end/86400);this.end=new Date(v[0],v[1]-1,parseInt(v[2])+n,0,0,this.end%86400),a=a>this.end?a:this.end}else this.end=new Date(v[0],v[1]-1,v[2],0,0,this.end);e[this.group]=this.shortname});var l={width:"100%",editable:!1,axisOnTop:!0,eventMargin:10,eventMarginAxis:0,min:new Date(v[0],v[1]-1,v[2],0),max:a,selectable:!0,showMajorLabels:!1,zoomMax:86400000,zoomMin:3600000,groupsChangeable:!1,showNavigation:!1,groupsOrder:"none",groupMinHeight:20},r=function(){c.redraw()},c=new links.Timeline(n[0],l),p=new Date(y);p.setMinutes(p.getMinutes()+p.getTimezoneOffset()),c.setCurrentTime(p),links.events.addListener(c,"select",function(){var e=c.getSelection();e.length&&"undefined"!=typeof e[0].row&&changePage("#programs",{programToExpand:parseInt(c.getItem(e[0].row).pid)})}),$.mobile.window.on("resize",r),i.one("pagehide",function(){$.mobile.window.off("resize",r)}),c.draw(o),i.find(".timeline-groups-text").each(function(){var t=$(this),a=e[t.text()];t.attr("data-shortname",a)}),i.find(".timeline-groups-axis").children().first().html("<div class='timeline-axis-text center dayofweek' data-shortname='"+getDayName(w,"short")+"'>"+getDayName(w)+"</div>"),isAndroid?(s.find(".ui-icon-plus").off("click").on("click",function(){return c.zoom(.4),!1}),s.find(".ui-icon-minus").off("click").on("click",function(){return c.zoom(-.4),!1}),s.find(".ui-icon-carat-l").off("click").on("click",function(){return c.move(-.2),!1}),s.find(".ui-icon-carat-r").off("click").on("click",function(){return c.move(.2),!1}),s.show()):s.hide(),n.on("swiperight swipeleft",function(t){t.stopImmediatePropagation()})},e}();function getStationDuration(e,t){if(checkOSVersion(214)){var a=getSunTimes(t);65535===e?e=60*(a[0]+1440-a[1]):65534==e&&(e=60*(a[1]-a[0]))}return e}// Logging functions
var getLogs=function(){var t=Math.floor;function e(){var e=checkOSVersion(219)?[3===controller.options.sn1t?_("Soil Sensor"):_("Rain Sensor"),3===controller.options.sn2t?_("Soil Sensor"):_("Rain Sensor"),_("Rain Delay")]:[_("Rain Sensor"),_("Rain Delay")];if(T=$.merge($.merge([],controller.stations.snames),e),a.find(".clear_logs").toggleClass("hidden",!(isOSPi()||checkOSVersion(210))),""===S.val()||""===C.val()){var t=new Date(1e3*controller.settings.devt);S.val(new Date(t.getTime()-6048e5).toISOString().slice(0,10)),C.val(t.toISOString().slice(0,10))}changeHeader({title:_("Logs"),leftBtn:{icon:"carat-l",text:_("Back"),class:"ui-toolbar-back-btn",on:goBack},rightBtn:{icon:"refresh",text:_("Refresh"),on:k}}),$("#logs").remove(),$.mobile.pageContainer.append(a)}var a=$("<div data-role='page' id='logs'><div class='ui-content' role='main'><fieldset data-role='controlgroup' data-type='horizontal' data-mini='true' class='log_type'><input data-mini='true' type='radio' name='log_type' id='log_timeline' value='timeline'><label for='log_timeline'>"+_("Timeline")+"</label><input data-mini='true' type='radio' name='log_type' id='log_table' value='table'><label for='log_table'>"+_("Table")+"</label></fieldset><fieldset data-role='collapsible' data-mini='true' id='log_options' class='center'><legend>"+_("Options")+"</legend><fieldset data-role='controlgroup' data-type='horizontal' id='table_sort'><p class='tight'>"+_("Grouping:")+"</p><input data-mini='true' type='radio' name='table-group' id='table-sort-day' value='day' checked='checked'><label for='table-sort-day'>"+_("Day")+"</label><input data-mini='true' type='radio' name='table-group' id='table-sort-station' value='station'><label for='table-sort-station'>"+_("Station")+"</label></fieldset><div class='ui-field-contain'><label for='log_start'>"+_("Start:")+"</label><input data-mini='true' type='date' id='log_start'><label for='log_end'>"+_("End:")+"</label><input data-mini='true' type='date' id='log_end'></div><a data-role='button' data-icon='action' class='export_logs' href='#' data-mini='true'>"+_("Export")+"</a><a data-role='button' class='red clear_logs' href='#' data-mini='true' data-icon='alert'>"+_("Clear Logs")+"</a></fieldset><div id='logs_list' class='center'></div></div></div>"),n=a.find("#logs_list"),s=a.find("#table_sort"),o=a.find("#log_options"),d=[],l=[],r=[],c=function(e,a){var i=[],n={totalRuntime:0,totalCount:0};if("table"===e&&"station"===a)for(P=0;P<T.length;P++)i[P]=[];return $.each(d,function(){var s=this[1],o=parseInt(this[2]);// Adjust for negative watering time firmware bug
0>o&&(o+=65536);var d=new Date(parseInt(1e3*this[3])-1e3*o),l=new Date(d.getUTCFullYear(),d.getUTCMonth(),d.getUTCDate(),d.getUTCHours(),d.getUTCMinutes(),d.getUTCSeconds());if("string"==typeof s){if("rd"===s)s=T.length-1;else if("s1"===s)s=T.length-3;else if("s2"===s)s=T.length-2;else if("rs"===s)s=T.length-2;else return;}else if("number"==typeof s){if(s>T.length-2||isStationMaster(s))return;n.totalRuntime+=o,n.totalCount++}if("table"===e)switch(a){case"station":i[s].push([l,dhms2str(sec2dhms(o))]);break;case"day":var r=t(d.getTime()/1e3/60/60/24),c=[l,dhms2str(sec2dhms(o)),s];"object"==typeof i[r]?i[r].push(c):i[r]=[c];}else if("timeline"===e){var p=parseInt(this[0]),u,m,h,b;if("rs"===this[1])u="delayed",m=_("Rain Sensor"),h=m,b=_("RS");else if("rd"===this[1])u="delayed",m=_("Rain Delay"),h=m,b=_("RD");else if("s1"===this[1])u="delayed",m=3===controller.options.sn1t?_("Soil Sensor"):_("Rain Sensor"),h=m,b=_("SEN1");else if("s2"===this[1])u="delayed",m=3===controller.options.sn2t?_("Soil Sensor"):_("Rain Sensor"),h=m,b=_("SEN2");else{if(0===p)return;u="program-"+(p+3)%4,m=pidname(p),h=controller.stations.snames[s],b="S"+(s+1)}i.push({start:l,end:new Date(l.getTime()+1e3*o),className:u,content:m,pid:p-1,shortname:b,group:h,station:s})}}),"timeline"===e&&i.sort(sortByStation),[i,n]},p=function(e,a){var i=[],n=[];return l.length&&(e.avgWaterLevel=0,$.each(l,function(){i[t(this[3]/60/60/24)]=this[2],e.avgWaterLevel+=this[2]}),e.avgWaterLevel=parseFloat((e.avgWaterLevel/l.length).toFixed(2))),r.length&&(e.totalVolume=0,$.each(r,function(){var i=flowCountToVolume(this[0]);if("timeline"===a){var s=new Date(parseInt(1e3*this[3])),o=new Date(s.getUTCFullYear(),s.getUTCMonth(),s.getUTCDate(),s.getUTCHours(),s.getUTCMinutes(),s.getUTCSeconds());n.push({start:new Date(o.getTime()-parseInt(1e3*this[2])),end:o,className:"",content:i+" L",shortname:_("FS"),group:_("Flow Sensor")})}else{var d=t(this[3]/60/60/24);n[d]=n[d]?n[d]+i:i}e.totalVolume+=i})),[i,n,e]},u=function(e,t,a){if("object"!=typeof e||1>e.length||e.result&&32===e.result)return $.mobile.loading("hide"),void f();try{r=JSON.parse(r.replace(/,\s*inf/g,""))}catch(e){r=[]}d=e,l=$.isEmptyObject(t)?[]:t,r=$.isEmptyObject(a)?[]:a,m(),exportObj(".export_logs",d),$.mobile.loading("hide")},m=function(){a.find("#log_table").prop("checked")?b():a.find("#log_timeline").prop("checked")&&h()},h=function(){if(1>d.length)return void f();s.hide(),n.show(),o.collapsible("collapse");var e=c("timeline"),t=p(e[1],"timeline"),i=e[0].concat(t[1]),l=t[2],r={width:"100%",editable:!1,axisOnTop:!0,eventMargin:10,eventMarginAxis:0,min:w().start,max:new Date(w().end.getTime()+8634e4),selectable:!1,showMajorLabels:!1,groupsChangeable:!1,showNavigation:!1,groupsOrder:"none",groupMinHeight:20,zoomMin:60000},u=function(){b.redraw()},m=function(){$.mobile.window.off("resize",u)},h=[];n.on("swiperight swipeleft",function(t){t.stopImmediatePropagation()}),$.each(i,function(){h[this.group]=this.shortname});var b=new links.Timeline(n.get(0),r);$.mobile.window.on("resize",u),a.one("pagehide",m),a.find("input:radio[name='log_type']").one("change",m),b.draw(i),n.find(".timeline-groups-text").each(function(){this.setAttribute("data-shortname",h[this.textContent])}),n.prepend(g(l))},b=function(){if(1>d.length)return void f();s.show(),n.show();var e=a.find("input:radio[name='table-group']:checked").val(),t=c("table",e),l=t[0],r=p(t[1]),u=[],m=r[0],h=r[1],b=r[2],v="<table><thead><tr><th data-priority='1'>"+_("Runtime")+"</th><th data-priority='2'>"+("station"===e?_("Date/Time"):_("Time")+"</th><th>"+_("Station"))+"</th></tr></thead><tbody>",w=g(b)+"<div data-role='collapsible-set' data-inset='true' data-theme='b' data-collapsed-icon='arrow-d' data-expanded-icon='arrow-u'>",y=0,x,S,C;for(x in l)if(l.hasOwnProperty(x)){if(S=l[x].length,0===S)continue;for(u[y]="<div data-role='collapsible' data-collapsed='true'><h2>"+(checkOSVersion(210)&&"day"===e?"<a class='ui-btn red ui-btn-corner-all delete-day day-"+x+"'>"+_("delete")+"</a>":"")+"<div class='ui-btn-up-c ui-btn-corner-all custom-count-pos'>"+S+" "+(1===S?_("run"):_("runs"))+"</div>"+("station"===e?T[x]:dateToString(new Date(24*(60*(60*(1e3*x))))).slice(0,-9))+"</h2>",m[x]&&(u[y]+="<span style='border:none' class='"+(100===m[x]?"":100>m[x]?"green ":"red ")+"ui-body ui-body-a'>"+_("Average")+" "+_("Water Level")+": "+m[x]+"%</span>"),h[x]&&(u[y]+="<span style='border:none' class='ui-body ui-body-a'>"+_("Total Water Used")+": "+h[x]+" L</span>"),u[y]+=v,C=0;C<l[x].length;C++){var j=new Date(l[x][C][0]);u[y]+="<tr><td>"+l[x][C][1]+"</td><td>"+("station"===e?dateToString(j,!1):pad(j.getHours())+":"+pad(j.getMinutes())+":"+pad(j.getSeconds())+"</td><td>"+T[l[x][C][2]])+"</td></tr>"}u[y]+="</tbody></table></div>",y++}"day"===e&&u.reverse(),o.collapsible("collapse"),n.html(w+u.join("")+"</div>").enhanceWithin(),n.find(".delete-day").on("click",function(){var e,t;return $.each(this.className.split(" "),function(){if(0===this.indexOf("day-"))return e=this.split("day-")[1],!1}),t=dateToString(new Date(24*(60*(60*(1e3*e))))).slice(0,-9),areYouSure(_("Are you sure you want to ")+_("delete")+" "+t+"?","",function(){$.mobile.loading("show"),sendToOS("/dl?pw=&day="+e).done(function(){k(),showerror(t+" "+_("deleted"))})}),!1}),fixInputClick(n)},g=function(e){if(0===e.totalCount||0===e.totalRuntime)return"";var t="undefined"!=typeof e.avgWaterLevel;return"<div class='ui-body-a smaller' id='logs_summary'><div><span class='bold'>"+_("Total Station Events")+"</span>: "+e.totalCount+"</div><div><span class='bold'>"+_("Total Runtime")+"</span>: "+dhms2str(sec2dhms(e.totalRuntime))+"</div>"+(t?"<div><span class='bold'>"+_("Average")+" "+_("Water Level")+"</span>: <span class='"+(100===e.avgWaterLevel?"":100>e.avgWaterLevel?"green-text":"red-text")+"'>"+e.avgWaterLevel+"%</span></div>":"")+("undefined"!=typeof e.totalVolume&&0<e.totalVolume?"<div><span class='bold'>"+_("Total Water Used")+"</span>: "+e.totalVolume+" L"+(t&&100>e.avgWaterLevel?" (<span class='green-text'>"+(e.totalVolume-e.totalVolume*(e.avgWaterLevel/100)).toFixed(2)+"L saved</span>)":"")+"</div>":"")+"</div>"},f=function(){d=[],o.collapsible("expand"),s.hide(),n.show().html(_("No entries found in the selected date range"))},v=function(){$.mobile.loading("hide"),s.empty().hide(),n.show().html(_("Error retrieving log data. Please refresh to try again."))},w=function(){var e=S.val().split("-"),t=C.val().split("-");return{start:new Date(e[0],e[1]-1,e[2]),end:new Date(t[0],t[1]-1,t[2])}},y=function(){return"start="+w().start.getTime()/1e3+"&end="+(w().end.getTime()/1e3+86340)},k=function(){var e=w().end.getTime()/1e3,t=w().start.getTime()/1e3;if(e<t)return f(),void showerror(_("Start time cannot be greater than end time"));var a=0;if($.mobile.loading("show"),3154e4<e-t){showerror(_("The requested time span exceeds the maxiumum of 1 year and has been adjusted"),3500);var i=w().start;i.setFullYear(i.getFullYear()+1),$("#log_end").val(i.getFullYear()+"-"+pad(i.getMonth()+1)+"-"+pad(i.getDate())),a=500}var n=$.Deferred().resolve(),s=$.Deferred().resolve();checkOSVersion(211)&&(n=sendToOS("/jl?pw=&type=wl&"+y(),"json")),checkOSVersion(216)&&(s=sendToOS("/jl?pw=&type=fl&"+y())),setTimeout(function(){$.when(sendToOS("/jl?pw=&"+y(),"json"),n,s).then(u,v)},a)},x=!!(640>window.innerWidth),S=a.find("#log_start"),C=a.find("#log_end"),T,j,P;// Bind clear logs button
return a.find(".clear_logs").on("click",function(){return clearLogs(k),!1}),isiOS?S.add(C).on("blur",function(){a.hasClass("ui-page-active")&&k()}):S.add(C).change(function(){clearTimeout(j),j=setTimeout(k,1e3)}),s.find("input[name='table-group']").change(function(){b()}),a.find("input:radio[name='log_type']").change(m),a.on({pagehide:function(){a.detach()},pageshow:k}),a.find("#log_timeline").prop("checked",!x),a.find("#log_table").prop("checked",x),e}();function clearLogs(e){areYouSure(_("Are you sure you want to clear ALL your log data?"),"",function(){var t=isOSPi()?"/cl?pw=":"/dl?pw=&day=all";$.mobile.loading("show"),sendToOS(t).done(function(){"function"==typeof e&&e(),showerror(_("Logs have been cleared"))})})}function resetAllOptions(e){areYouSure(_("Are you sure you want to delete all settings and return to the default settings?"),"",function(){var t;isOSPi()?t="otz=32&ontp=1&onbrd=0&osdt=0&omas=0&omton=0&omtoff=0&orst=1&owl=100&orlp=0&ouwt=0&olg=1&oloc=Boston,MA":(t="o1=32&o2=1&o3=1&o12=80&o13=0&o15=0&o17=0&o18=0&o19=0&o20=0&o22=1&o23=100&o26=0&o27=110&o28=100&o29=15&o30=0&o31=0&o32=50&o33=97&o34=210&o35=169&o36=1&o37=0&o38=0&o39=0&loc=Boston,MA&wto=%22key%22%3A%22%22",transformKeysinString(t)),sendToOS("/co?pw=&"+t).done(function(){"function"==typeof e&&e(),updateController(updateWeather)})})}// Program management functions
var getPrograms=function(){function e(){var e=$(makeAllPrograms());e.find("[id^=program-]").on({collapsiblecollapse:function(){$(this).find(".ui-collapsible-content").empty()},collapsiblebeforecollapse:function(t){var e=$(this),a=e.find(".hasChanges");a.length&&(areYouSure(_("Do you want to save your changes?"),"",function(){a.removeClass("hasChanges").click(),e.collapsible("collapse")},function(){a.removeClass("hasChanges"),e.collapsible("collapse")}),t.preventDefault())},collapsibleexpand:function(){expandProgram($(this))}}),checkOSVersion(210)&&e.find(".move-up").removeClass("hidden").on("click",function(){var e=$(this).parents("fieldset"),a=parseInt(e.attr("id").split("-")[1]);return $.mobile.loading("show"),sendToOS("/up?pw=&pid="+a).done(function(){updateControllerPrograms(function(){$.mobile.loading("hide"),t.trigger("programrefresh")})}),!1}),e.find(".program-copy").on("click",function(){var e=parseInt($(this).parents("fieldset").attr("id").split("-")[1]);return changePage("#addprogram",{copyID:e}),!1}),t.find("#programs_list").html(e.enhanceWithin())}var t=$("<div data-role='page' id='programs'><div class='ui-content' role='main' id='programs_list'></div></div>"),a;return t.on("programrefresh",e).on("pagehide",function(){t.detach()}).on("pagebeforeshow",function(){updateProgramHeader(),"number"!=typeof a&&1===controller.programs.pd.length&&(a=0),"number"==typeof a&&(t.find("fieldset[data-collapsed='false']").collapsible("collapse"),$("#program-"+a).collapsible("expand"))}),function(i){a=i,changeHeader({title:_("Programs"),leftBtn:{icon:"carat-l",text:_("Back"),class:"ui-toolbar-back-btn",on:checkChangesBeforeBack},rightBtn:{icon:"plus",text:_("Add"),on:function(){checkChanges(function(){changePage("#addprogram")})}}}),e(),$("#programs").remove(),$.mobile.pageContainer.append(t)}}();function expandProgram(t){var a=parseInt(t.attr("id").split("-")[1]);t.find(".ui-collapsible-content").html(makeProgram(a)).enhanceWithin().on("change input click",function(a){"click"===a.type&&"BUTTON"!==a.target.tagName||($(this).off("change input click"),t.find("[id^='submit-']").addClass("hasChanges"))}),t.find("[id^='submit-']").on("click",function(){return submitProgram(a),!1}),t.find("[id^='delete-']").on("click",function(){return deleteProgram(a),!1}),t.find("[id^='run-']").on("click",function(){var e=checkOSVersion(210)?controller.programs.pd[a][5]:"Program "+a;return areYouSure(_("Are you sure you want to start "+e+" now?"),"",function(){var e=[],t=function(){e.push(0),submitRunonce(e)};if(!checkOSVersion(210)){var i=parseInt($("#duration-"+a).val()),n=$("[id^='station_'][id$='-"+a+"']");$.each(n,function(){$(this).is(":checked")?e.push(i):e.push(0)})}else if(e=controller.programs.pd[a][4],1&controller.programs.pd[a][0]>>1)return areYouSure(_("Do you wish to apply the current watering level?"),"",function(){for(var a=e.length-1;0<=a;a--)e[a]=parseInt(e[a]*(controller.options.wl/100));t()},t),!1;t()}),!1})}// Translate program array into easier to use data
function readProgram(e){return checkOSVersion(210)?readProgram21(e):readProgram183(e)}function readProgram183(e){var t=e[1],a=e[2],i=!1,o=!1,l=!1,r="",c="",p={};p.en=e[0];for(var u=0,m;u<controller.programs.nboards;u++){m=e[7+u];for(var h=0;8>h;h++)c+=m&1<<h?"1":"0"}if(p.stations=c,p.duration=e[6],p.start=e[3],p.end=e[4],p.interval=e[5],128&t&&1<a)r=[a,127&t],l=!0;else{//This is a weekly program
for(var b=0;7>b;b++)r+=t&1<<b?"1":"0";128&t&&0===a&&(i=!0),128&t&&1===a&&(o=!0)}return p.days=r,p.is_even=i,p.is_odd=o,p.is_interval=l,p}// Read program for OpenSprinkler 2.1+
function readProgram21(e){var t=e[1],a=e[2],i=3&e[0]>>2,n=3&e[0]>>4,s=1&e[0]>>6,o="",l={repeat:0,interval:0};if(l.en=1&e[0]>>0,l.weather=1&e[0]>>1,l.is_even=2==i,l.is_odd=1==i,l.is_interval=3==n,l.stations=e[4],l.name=e[5],0==s?(l.start=e[3][0],l.repeat=e[3][1],l.interval=e[3][2]):1==s&&(l.start=e[3]),3==n)o=[a,t];else if(0==n)//This is a weekly program
for(var r=0;7>r;r++)o+=t&1<<r?"1":"0";return l.days=o,l}function getStartTime(e,t){var a=2047&e,i=0,n=getSunTimes(t);if(0>e)return e;if(1&e>>13)i=1;else if(1&!(e>>14))return e;return 1&e>>12&&(a=-a),e=n[i],e+=a,0>e?e=0:1440<e&&(e=1440),e}function readStartTime(e){var t=2047&e,a=_("Sunrise");if(1&e>>13)a=_("Sunset");else if(1&!(e>>14))return minutesToTime(e);return 1&e>>12&&(t=-t),a+(0==t?"":(0<t?"+":"")+dhms2str(sec2dhms(60*t)))}// Translate program ID to it's name
function pidname(e){var t=_("Program")+" "+e;return 255===e||99===e?t=_("Manual program"):254===e||98===e?t=_("Run-once program"):checkOSVersion(210)&&e<=controller.programs.pd.length&&(t=controller.programs.pd[e-1][5]),t}// Check each program and change the background color to red if disabled
function updateProgramHeader(){$("#programs_list").find("[id^=program-]").each(function(e,t){var a=$(t),i=a.find(".ui-collapsible-heading-toggle"),n=checkOSVersion(210)?1&controller.programs.pd[e][0]:controller.programs.pd[e][0];n?i.removeClass("red"):i.addClass("red")})}//Make the list of all programs
function makeAllPrograms(){if(0===controller.programs.pd.length)return"<p class='center'>"+_("You have no programs currently added. Tap the Add button on the top right corner to get started.")+"</p>";for(var e="<p class='center'>"+_("Click any program below to expand/edit. Be sure to save changes.")+"</p><div data-role='collapsible-set'>",t=0,a;t<controller.programs.pd.length;t++)a=_("Program")+" "+(t+1),checkOSVersion(210)&&(a=controller.programs.pd[t][5]),e+="<fieldset id='program-"+t+"' data-role='collapsible'><h3><a "+(0<t?"":"style='visibility:hidden' ")+"class='hidden ui-btn ui-btn-icon-notext ui-icon-arrow-u ui-btn-corner-all move-up'></a><a class='ui-btn ui-btn-corner-all program-copy'>"+_("copy")+"</a><span class='program-name'>"+a+"</span></h3>",e+="</fieldset>";return e+"</div>"}function makeProgram(e,t){return checkOSVersion(210)?makeProgram21(e,t):makeProgram183(e,t)}function makeProgram183(e,t){var a=[_("Monday"),_("Tuesday"),_("Wednesday"),_("Thursday"),_("Friday"),_("Saturday"),_("Sunday")],n="",s=t?"new":e,o,d,l,r,c,p;if(c="new"===e?{en:0,weather:0,is_interval:0,is_even:0,is_odd:0,duration:0,interval:0,start:0,end:0,days:[0,0]}:readProgram(controller.programs.pd[e]),"string"==typeof c.days)for(o=c.days.split(""),d=o.length;d--;)o[d]|=0;else o=[0,0,0,0,0,0,0];if("undefined"!=typeof c.stations)for(r=c.stations.split(""),d=r.length-1;0<=d;d--)r[d]|=0;for(n+="<label for='en-"+s+"'><input data-mini='true' type='checkbox' "+(c.en||"new"===e?"checked='checked'":"")+" name='en-"+s+"' id='en-"+s+"'>"+_("Enabled")+"</label>",n+="<fieldset data-role='controlgroup' data-type='horizontal' class='center'>",n+="<input data-mini='true' type='radio' name='rad_days-"+s+"' id='days_week-"+s+"' value='days_week-"+s+"' "+(c.is_interval?"":"checked='checked'")+"><label for='days_week-"+s+"'>"+_("Weekly")+"</label>",n+="<input data-mini='true' type='radio' name='rad_days-"+s+"' id='days_n-"+s+"' value='days_n-"+s+"' "+(c.is_interval?"checked='checked'":"")+"><label for='days_n-"+s+"'>"+_("Interval")+"</label>",n+="</fieldset><div id='input_days_week-"+s+"' "+(c.is_interval?"style='display:none'":"")+">",n+="<div class='center'><p class='tight'>"+_("Restrictions")+"</p><select data-inline='true' data-iconpos='left' data-mini='true' id='days_rst-"+s+"'>",n+="<option value='none' "+(c.is_even||c.is_odd?"":"selected='selected'")+">"+_("None")+"</option>",n+="<option value='odd' "+(!c.is_even&&c.is_odd?"selected='selected'":"")+">"+_("Odd Days Only")+"</option>",n+="<option value='even' "+(!c.is_odd&&c.is_even?"selected='selected'":"")+">"+_("Even Days Only")+"</option>",n+="</select></div>",n+="<div class='center'><p class='tight'>"+_("Days of the Week")+"</p><select "+(560<$.mobile.window.width()?"data-inline='true' ":"")+"data-iconpos='left' data-mini='true' multiple='multiple' data-native-menu='false' id='d-"+s+"'><option>"+_("Choose day(s)")+"</option>",l=0;l<a.length;l++)n+="<option "+(!c.is_interval&&o[l]?"selected='selected'":"")+" value='"+l+"'>"+a[l]+"</option>";for(n+="</select></div></div>",n+="<div "+(c.is_interval?"":"style='display:none'")+" id='input_days_n-"+s+"' class='ui-grid-a'>",n+="<div class='ui-block-a'><label class='center' for='every-"+s+"'>"+_("Interval (Days)")+"</label><input data-wrapper-class='pad_buttons' data-mini='true' type='number' name='every-"+s+"' pattern='[0-9]*' id='every-"+s+"' value='"+c.days[0]+"'></div>",n+="<div class='ui-block-b'><label class='center' for='starting-"+s+"'>"+_("Starting In")+"</label><input data-wrapper-class='pad_buttons' data-mini='true' type='number' name='starting-"+s+"' pattern='[0-9]*' id='starting-"+s+"' value='"+c.days[1]+"'></div>",n+="</div>",n+="<fieldset data-role='controlgroup'><legend>"+_("Stations:")+"</legend>",l=0;l<controller.stations.snames.length;l++)n+="<label for='station_"+l+"-"+s+"'><input "+(isStationDisabled(l)?"data-wrapper-class='station-hidden hidden' ":"")+"data-mini='true' type='checkbox' "+("undefined"!=typeof r&&r[l]?"checked='checked'":"")+" name='station_"+l+"-"+s+"' id='station_"+l+"-"+s+"'>"+controller.stations.snames[l]+"</label>";return n+="</fieldset>",n+="<fieldset data-role='controlgroup' data-type='horizontal' class='center'>",n+="<button class='ui-btn ui-mini' name='s_checkall-"+s+"' id='s_checkall-"+s+"'>"+_("Check All")+"</button>",n+="<button class='ui-btn ui-mini' name='s_uncheckall-"+s+"' id='s_uncheckall-"+s+"'>"+_("Uncheck All")+"</button>",n+="</fieldset>",n+="<div class='ui-grid-a'>",n+="<div class='ui-block-a'><label class='center' for='start-"+s+"'>"+_("Start Time")+"</label><button class='timefield pad_buttons' data-mini='true' id='start-"+s+"' value='"+c.start+"'>"+minutesToTime(c.start)+"</button></div>",n+="<div class='ui-block-b'><label class='center' for='end-"+s+"'>"+_("End Time")+"</label><button class='timefield pad_buttons' data-mini='true' id='end-"+s+"' value='"+c.end+"'>"+minutesToTime(c.end)+"</button></div>",n+="</div>",n+="<div class='ui-grid-a'>",n+="<div class='ui-block-a'><label class='pad_buttons center' for='duration-"+s+"'>"+_("Station Duration")+"</label><button class='pad_buttons' data-mini='true' name='duration-"+s+"' id='duration-"+s+"' value='"+c.duration+"'>"+dhms2str(sec2dhms(c.duration))+"</button></div>",n+="<div class='ui-block-b'><label class='pad_buttons center' for='interval-"+s+"'>"+_("Program Interval")+"</label><button class='pad_buttons' data-mini='true' name='interval-"+s+"' id='interval-"+s+"' value='"+60*c.interval+"'>"+dhms2str(sec2dhms(60*c.interval))+"</button></div>",n+="</div>",!0===t||"new"===e?n+="<input data-mini='true' data-icon='check' type='submit' data-theme='b' name='submit-"+s+"' id='submit-"+s+"' value='"+_("Save New Program")+"'>":(n+="<button data-mini='true' data-icon='check' data-theme='b' name='submit-"+s+"' id='submit-"+s+"'>"+_("Save Changes to Program")+" "+(e+1)+"</button>",n+="<button data-mini='true' data-icon='arrow-r' name='run-"+s+"' id='run-"+s+"'>"+_("Run Program")+" "+(e+1)+"</button>",n+="<button data-mini='true' data-icon='delete' class='red bold' data-theme='b' name='delete-"+s+"' id='delete-"+s+"'>"+_("Delete Program")+" "+(e+1)+"</button>"),p=$(n),p.find("input[name^='rad_days']").on("change",function(){var e=$(this).val().split("-")[0],t;e=e.split("_")[1],t="n"===e?"week":"n",$("#input_days_"+e+"-"+s).show(),$("#input_days_"+t+"-"+s).hide()}),p.find("[id^='duration-'],[id^='interval-']").on("click",function(){var e=$(this),t=e.attr("id").match("interval")?1:0,a=p.find("label[for='"+e.attr("id")+"']").text();showDurationBox({seconds:e.val(),title:a,callback:function(t){e.val(t),e.text(dhms2str(sec2dhms(t)))},maximum:t?86340:65535,granularity:t})}),p.find(".timefield").on("click",function(){var e=$(this),t=p.find("label[for='"+e.attr("id")+"']").text();showTimeInput({minutes:e.val(),title:t,callback:function(t){e.val(t),e.text(minutesToTime(t))}})}),p.find("[id^='s_checkall-']").on("click",function(){return p.find("[id^='station_'][id$='-"+s+"']").prop("checked",!0).checkboxradio("refresh"),!1}),p.find("[id^='s_uncheckall-']").on("click",function(){return p.find("[id^='station_'][id$='-"+s+"']").prop("checked",!1).checkboxradio("refresh"),!1}),fixInputClick(p),p}function makeProgram21(e,t){var a=[_("Monday"),_("Tuesday"),_("Wednesday"),_("Thursday"),_("Friday"),_("Saturday"),_("Sunday")],n="",s=t?"new":e,o,d,l,r,c,p,u,m;if(r="new"===e?{name:"",en:0,weather:0,is_interval:0,is_even:0,is_odd:0,interval:0,start:0,days:[0,0],repeat:0,stations:[]}:readProgram(controller.programs.pd[e]),"string"==typeof r.days)for(o=r.days.split(""),d=o.length;d--;)o[d]|=0;else o=[0,0,0,0,0,0,0];for(p="object"==typeof r.start?r.start:[r.start,-1,-1,-1],n+="<div style='margin-top:5px' class='ui-corner-all'>",n+="<div class='ui-bar ui-bar-a'><h3>"+_("Basic Settings")+"</h3></div>",n+="<div class='ui-body ui-body-a center'>",n+="<label for='name-"+s+"'>"+_("Program Name")+"</label><input data-mini='true' type='text' name='name-"+s+"' id='name-"+s+"' maxlength='"+controller.programs.pnsize+"' placeholder='"+_("Program")+" "+(controller.programs.pd.length+1)+"' value='"+r.name+"'>",n+="<label for='en-"+s+"'><input data-mini='true' type='checkbox' "+(r.en||"new"===e?"checked='checked'":"")+" name='en-"+s+"' id='en-"+s+"'>"+_("Enabled")+"</label>",n+="<label for='uwt-"+s+"'><input data-mini='true' type='checkbox' "+(r.weather?"checked='checked'":"")+" name='uwt-"+s+"' id='uwt-"+s+"'>"+_("Use Weather Adjustment")+"</label>",n+="<label class='center' for='start_1-"+s+"'>"+_("Start Time")+"</label><button class='timefield' data-mini='true' id='start_1-"+s+"' value='"+p[0]+"'>"+readStartTime(p[0])+"</button>",n+="</div></div></div></div>",n+="<div style='margin-top:10px' class='ui-corner-all'>",n+="<div class='ui-bar ui-bar-a'><h3>"+_("Program Type")+"</h3></div>",n+="<div class='ui-body ui-body-a'>",n+="<fieldset data-role='controlgroup' data-type='horizontal' class='center'>",n+="<input data-mini='true' type='radio' name='rad_days-"+s+"' id='days_week-"+s+"' value='days_week-"+s+"' "+(r.is_interval?"":"checked='checked'")+"><label for='days_week-"+s+"'>"+_("Weekly")+"</label>",n+="<input data-mini='true' type='radio' name='rad_days-"+s+"' id='days_n-"+s+"' value='days_n-"+s+"' "+(r.is_interval?"checked='checked'":"")+"><label for='days_n-"+s+"'>"+_("Interval")+"</label>",n+="</fieldset>",n+="<div id='input_days_week-"+s+"' "+(r.is_interval?"style='display:none'":"")+">",n+="<div class='center'><p class='tight'>"+_("Days of the Week")+"</p><select "+(560<$.mobile.window.width()?"data-inline='true' ":"")+"data-iconpos='left' data-mini='true' multiple='multiple' data-native-menu='false' id='d-"+s+"'><option>"+_("Choose day(s)")+"</option>",l=0;l<a.length;l++)n+="<option "+(!r.is_interval&&o[l]?"selected='selected'":"")+" value='"+l+"'>"+a[l]+"</option>";n+="</select></div></div>",n+="<div "+(r.is_interval?"":"style='display:none'")+" id='input_days_n-"+s+"' class='ui-grid-a'>",n+="<div class='ui-block-a'><label class='center' for='every-"+s+"'>"+_("Interval (Days)")+"</label><input data-wrapper-class='pad_buttons' data-mini='true' type='number' name='every-"+s+"' pattern='[0-9]*' id='every-"+s+"' value='"+r.days[0]+"'></div>",n+="<div class='ui-block-b'><label class='center' for='starting-"+s+"'>"+_("Starting In")+"</label><input data-wrapper-class='pad_buttons' data-mini='true' type='number' name='starting-"+s+"' pattern='[0-9]*' id='starting-"+s+"' value='"+r.days[1]+"'></div>",n+="</div>",n+="<div class='center'><p class='tight'>"+_("Restrictions")+"</p><select data-inline='true' data-iconpos='left' data-mini='true' id='days_rst-"+s+"'>",n+="<option value='none' "+(r.is_even||r.is_odd?"":"selected='selected'")+">"+_("None")+"</option>",n+="<option value='odd' "+(!r.is_even&&r.is_odd?"selected='selected'":"")+">"+_("Odd Days Only")+"</option>",n+="<option value='even' "+(!r.is_odd&&r.is_even?"selected='selected'":"")+">"+_("Even Days Only")+"</option>",n+="</select></div>",n+="</div></div>",n+="<div style='margin-top:10px' class='ui-corner-all'>",n+="<div class='ui-bar ui-bar-a'><h3>"+_("Stations")+"</h3></div>",n+="<div class='ui-body ui-body-a'>";var h=$("#programs").hasClass("show-hidden")?"":"' style='display:none";// Show station duration inputs
for(l=0;l<controller.stations.snames.length;l++)isStationMaster(l)?n+="<div class='ui-field-contain duration-input"+(isStationDisabled(l)?" station-hidden"+h:"")+"'><label for='station_"+l+"-"+s+"'>"+controller.stations.snames[l]+":</label><button disabled='true' data-mini='true' name='station_"+l+"-"+s+"' id='station_"+l+"-"+s+"' value='0'>"+_("Master")+"</button></div>":(u=r.stations[l]||0,n+="<div class='ui-field-contain duration-input"+(isStationDisabled(l)?" station-hidden"+h:"")+"'><label for='station_"+l+"-"+s+"'>"+controller.stations.snames[l]+":</label><button "+(0<u?"class='green' ":"")+"data-mini='true' name='station_"+l+"-"+s+"' id='station_"+l+"-"+s+"' value='"+u+"'>"+getDurationText(u)+"</button></div>");// Close station group
for(n+="</div></div>",n+="<div style='margin-top:10px' class='ui-corner-all'>",n+="<div class='ui-bar ui-bar-a'><h3>"+_("Additional Start Times")+"</h3></div>",n+="<div class='ui-body ui-body-a'>",n+="<fieldset data-role='controlgroup' data-type='horizontal' class='center'>",n+="<input data-mini='true' type='radio' name='stype-"+s+"' id='stype_repeat-"+s+"' value='stype_repeat-"+s+"' "+("object"==typeof r.start?"":"checked='checked'")+"><label for='stype_repeat-"+s+"'>"+_("Repeating")+"</label>",n+="<input data-mini='true' type='radio' name='stype-"+s+"' id='stype_set-"+s+"' value='stype_set-"+s+"' "+("object"==typeof r.start?"checked='checked'":"")+"><label for='stype_set-"+s+"'>"+_("Fixed")+"</label>",n+="</fieldset>",n+="<div "+("object"==typeof r.start?"style='display:none'":"")+" id='input_stype_repeat-"+s+"'>",n+="<div class='ui-grid-a'>",n+="<div class='ui-block-a'><label class='pad_buttons center' for='interval-"+s+"'>"+_("Repeat Every")+"</label><button class='pad_buttons' data-mini='true' name='interval-"+s+"' id='interval-"+s+"' value='"+60*r.interval+"'>"+dhms2str(sec2dhms(60*r.interval))+"</button></div>",n+="<div class='ui-block-b'><label class='pad_buttons center' for='repeat-"+s+"'>"+_("Repeat Count")+"</label><button class='pad_buttons' data-mini='true' name='repeat-"+s+"' id='repeat-"+s+"' value='"+r.repeat+"'>"+r.repeat+"</button></div>",n+="</div></div>",n+="<table style='width:100%;"+("object"==typeof r.start?"":"display:none")+"' id='input_stype_set-"+s+"'><tr><th class='center'>"+_("Enable")+"</th><th>"+_("Start Time")+"</th></tr>",l=1;4>l;l++)m=-1===p[l],n+="<tr><td data-role='controlgroup' data-type='horizontal' class='use_master center'><label for='ust_"+(l+1)+"'><input id='ust_"+(l+1)+"' type='checkbox' "+(m?"":"checked='checked'")+"></label></td>",n+="<td><button class='timefield' data-mini='true' type='time' id='start_"+(l+1)+"-"+s+"' value='"+(m?0:p[l])+"'>"+readStartTime(m?0:p[l])+"</button></td></tr>";return n+="</table>",n+="</div></div>",!0===t||"new"===e?n+="<button data-mini='true' data-icon='check' data-theme='b' id='submit-"+s+"'>"+_("Save New Program")+"</button>":(n+="<button data-mini='true' data-icon='check' data-theme='b' id='submit-"+s+"'>"+_("Save Changes to")+" <span class='program-name'>"+r.name+"</span></button>",n+="<button data-mini='true' data-icon='arrow-r' id='run-"+s+"'>"+_("Run")+" <span class='program-name'>"+r.name+"</span></button>",n+="<button data-mini='true' data-icon='delete' class='bold red' data-theme='b' id='delete-"+s+"'>"+_("Delete")+" <span class='program-name'>"+r.name+"</span></button>"),c=$(n),c.find("input[name^='rad_days'],input[name^='stype']").on("change",function(){var e=$(this).val().split("-")[0].split("_");$("[id^='input_"+e[0]+"_']").hide(),$("#input_"+e[0]+"_"+e[1]+"-"+s).show()}),c.find("[id^='interval-']").on("click",function(){var e=$(this),t=c.find("label[for='"+e.attr("id")+"']").text();showDurationBox({seconds:e.val(),title:t,callback:function(t){e.val(t),e.text(dhms2str(sec2dhms(t)))},maximum:86340,granularity:1,preventCompression:!0})}),c.find(".timefield").on("click",function(){var e=$(this);showTimeInput({minutes:e.val(),title:_("Start Time"),showSun:!!checkOSVersion(213),callback:function(t){e.val(t),e.text(readStartTime(t))}})}),c.find("[id^='repeat-']").on("click",function(){var e=$(this),t=c.find("label[for='"+e.attr("id")+"']").text();showSingleDurationInput({data:e.val(),title:t,label:_("Repeat Count"),callback:function(t){e.val(t).text(t)},maximum:1440})}),c.find("[id^=station_]").on("click",function(){var e=$(this),t=controller.stations.snames[e.attr("id").split("_")[1].split("-")[0]];showDurationBox({seconds:e.val(),title:t,callback:function(t){e.val(t).addClass("green"),e.text(getDurationText(t)),0===t&&e.removeClass("green")},maximum:65535,showSun:!!checkOSVersion(214)})}),fixInputClick(c),c}function addProgram(e){e=0<=e?e:"new";var t=$("<div data-role='page' id='addprogram'><div class='ui-content' role='main' id='newprogram'><fieldset id='program-new'></fieldset></div></div>"),a=changeHeader({title:_("Add Program"),leftBtn:{icon:"carat-l",text:_("Back"),class:"ui-toolbar-back-btn",on:checkChangesBeforeBack},rightBtn:{icon:"check",text:_("Submit"),on:function(){return submitProgram("new"),!1}}});t.find("#program-new").html(makeProgram(e,!0)).one("change input",function(){a.eq(2).prop("disabled",!1).addClass("hasChanges")}),t.find("[id^='submit-']").on("click",function(){return submitProgram("new"),!1}),t.one("pagehide",function(){t.remove()}),"string"==typeof e&&a.eq(2).prop("disabled",!0),$("#addprogram").remove(),$.mobile.pageContainer.append(t)}function deleteProgram(e){var t=pidname(parseInt(e)+1);areYouSure(_("Are you sure you want to delete program")+" "+t+"?","",function(){$.mobile.loading("show"),sendToOS("/dp?pw=&pid="+e).done(function(){$.mobile.loading("hide"),updateControllerPrograms(function(){$("#programs").trigger("programrefresh"),showerror(_("Program")+" "+t+" "+_("deleted"))})})})}function submitProgram(e){$("#program-"+e).find(".hasChanges").removeClass("hasChanges"),checkOSVersion(210)?submitProgram21(e):submitProgram183(e)}function submitProgram183(e){var t=[],a=[0,0],n=0,o=$("#en-"+e).is(":checked")?1:0,d,l,r;if(t[0]=o,$("#days_week-"+e).is(":checked")){for(d=$("#d-"+e).val(),d=null===d?[]:parseIntArray(d),l=0;7>l;l++)-1!==$.inArray(l,d)&&(a[0]|=1<<l);if(0===a[0])return void showerror(_("Error: You have not selected any days of the week."));"odd"===$("#days_rst-"+e).val()?(a[0]|=128,a[1]=1):"even"===$("#days_rst-"+e).val()&&(a[0]|=128,a[1]=0)}else if($("#days_n-"+e).is(":checked")){if(a[1]=parseInt($("#every-"+e).val(),10),!(2<=a[1]&&128>=a[1]))return void showerror(_("Error: Interval days must be between 2 and 128."));if(a[0]=parseInt($("#starting-"+e).val(),10),!(0<=a[0]&&a[0]<a[1]))return void showerror(_("Error: Starting in days wrong."));a[0]|=128}if(t[1]=a[0],t[2]=a[1],t[3]=parseInt($("#start-"+e).val()),t[4]=parseInt($("#end-"+e).val()),t[3]>t[4])return void showerror(_("Error: Start time must be prior to end time."));t[5]=parseInt($("#interval-"+e).val()/60);var c=$("[id^=station_][id$=-"+e+"]"),p=c.length;t[6]=parseInt($("#duration-"+e).val());var u=[0],m,h;for(m=0;m<p/8;m++)for(u[m]=0,r=0;8>r;r++)h=8*m+r,$("#station_"+h+"-"+e).is(":checked")&&(u[m]|=1<<r,n=1);return t=JSON.stringify(t.concat(u)),0==n?void showerror(_("Error: You have not selected any stations.")):void($.mobile.loading("show"),"new"===e?sendToOS("/cp?pw=&pid=-1&v="+t).done(function(){$.mobile.loading("hide"),updateControllerPrograms(function(){$.mobile.document.one("pageshow",function(){showerror(_("Program added successfully"))}),goBack()})}):sendToOS("/cp?pw=&pid="+e+"&v="+t).done(function(){$.mobile.loading("hide"),updateControllerPrograms(function(){updateProgramHeader()}),showerror(_("Program has been updated"))}))}function submitProgram21(e,t){var a=[],n=[0,0],s=[0,0,0,0],o=0,d=$("#en-"+e).is(":checked")?1:0,l=$("#uwt-"+e).is(":checked")?1:0,r=0,c,p,u,m;// Set enable/disable bit for program
// Set program type
if(r|=d<<0,r|=l<<1,"odd"===$("#days_rst-"+e).val()?r|=4:"even"===$("#days_rst-"+e).val()&&(r|=8),$("#days_n-"+e).is(":checked")){if(r|=48,n[1]=parseInt($("#every-"+e).val(),10),!(2<=n[1]&&128>=n[1]))return void showerror(_("Error: Interval days must be between 2 and 128."));if(n[0]=parseInt($("#starting-"+e).val(),10),!(0<=n[0]&&n[0]<n[1]))return void showerror(_("Error: Starting in days wrong."))}else if($("#days_week-"+e).is(":checked")){for(r|=0,c=$("#d-"+e).val(),c=null===c?[]:parseIntArray(c),p=0;7>p;p++)-1!==$.inArray(p,c)&&(n[0]|=1<<p);if(0===n[0])return void showerror(_("Error: You have not selected any days of the week."))}// Set program start time type
if($("#stype_repeat-"+e).is(":checked"))r|=0,s[0]=parseInt($("#start_1-"+e).val()),s[1]=parseInt($("#repeat-"+e).val()),s[2]=parseInt($("#interval-"+e).val()/60);else if($("#stype_set-"+e).is(":checked")){r|=64;var h=$("[id^='start_'][id$='-"+e+"']");h.each(function(e,t){var a=parseInt(t.value);("number"!=typeof a||0<e&&!$("#ust_"+(e+1)).is(":checked"))&&(a=-1),s[e]=a})}var b=$("[id^=station_][id$=-"+e+"]"),g=[];// If the interval is an even number and a restriction is set, notify user of possible conflict
return b.each(function(){var e=parseInt(this.value);0<parseInt(e)&&(o=1),g.push(e)}),a[0]=r,a[1]=n[0],a[2]=n[1],a[3]=s,a[4]=g,u=$("#name-"+e).val(),m="&v="+JSON.stringify(a)+"&name="+encodeURIComponent(u),0==o?void showerror(_("Error: You have not selected any stations.")):!t&&$("#stype_repeat-"+e).is(":checked")&&0<s[1]&&calculateTotalRunningTime(g)>60*s[2]?void areYouSure(_("Warning: The repeat interval is less than the program run time."),_("Do you want to continue?"),function(){submitProgram21(e,!0)}):t||3!=(3&r>>4)||1&n[1]||!(0<(3&r>>2))?void($.mobile.loading("show"),"new"===e?sendToOS("/cp?pw=&pid=-1"+m).done(function(){$.mobile.loading("hide"),updateControllerPrograms(function(){$.mobile.document.one("pageshow",function(){showerror(_("Program added successfully"))}),goBack()})}):sendToOS("/cp?pw=&pid="+e+m).done(function(){$.mobile.loading("hide"),updateControllerPrograms(function(){updateProgramHeader(),$("#program-"+e).find(".program-name").text(u)}),showerror(_("Program has been updated"))})):void areYouSure(_("Warning: The use of odd/even restrictions with the selected interval day may result in the program not running at all."),_("Do you want to continue?"),function(){submitProgram21(e,!0)})}function raindelay(e){return $.mobile.loading("show"),sendToOS("/cv?pw=&rd="+e/3600).done(function(){$.mobile.loading("hide"),showLoading("#footer-running"),refreshStatus(),showerror(_("Rain delay has been successfully set"))}),!1}// Export and Import functions
function getExportMethod(){var e=$("<div data-role='popup' data-theme='a'><div class='ui-bar ui-bar-a'>"+_("Select Export Method")+"</div><div data-role='controlgroup' class='tight'><a class='ui-btn hidden fileMethod'>"+_("File")+"</a><a class='ui-btn pasteMethod'>"+_("Email")+"</a><a class='ui-btn localMethod'>"+_("Internal (within app)")+"</a></div></div>"),t=encodeURIComponent(JSON.stringify(controller)),a="OpenSprinkler Data Export on "+dateToString(new Date);isFileCapable&&e.find(".fileMethod").removeClass("hidden").attr({href:"data:text/json;charset=utf-8,"+t,download:"backup-"+new Date().toLocaleDateString().replace(/\//g,"-")+".json"}).on("click",function(){e.popup("close")});var i="mailto:?subject="+encodeURIComponent(a)+"&body="+t;e.find(".pasteMethod").attr("href",i).on("click",function(){window.open(i),e.popup("close")}),e.find(".localMethod").on("click",function(){e.popup("close"),storage.set({backup:JSON.stringify(controller)},function(){showerror(_("Backup saved on this device"))})}),openPopup(e,{positionTo:$("#sprinklers-settings").find(".export_config")})}function getImportMethod(e){var t=function(){var e=$("<div data-role='popup' data-theme='a' id='paste_config'><p class='ui-bar'><textarea class='textarea' rows='10' placeholder='"+_("Paste your backup here")+"'></textarea><button data-mini='true' data-theme='b'>"+_("Import")+"</button></p></div>"),t=$.mobile.window.width();return e.find("button").on("click",function(){var t=e.find("textarea").val();if(""!==t)try{t=JSON.parse($.trim(t).replace(/“|”|″/g,"\"")),e.popup("close"),importConfig(t)}catch(t){e.find("textarea").val(""),showerror(_("Unable to read the configuration file. Please check the file and try again."))}}),e.css("width",600<t?.4*t+"px":"100%"),openPopup(e),!1},a=$("<div data-role='popup' data-theme='a'><div class='ui-bar ui-bar-a'>"+_("Select Import Method")+"</div><div data-role='controlgroup' class='tight'><button class='hidden fileMethod'>"+_("File")+"</button><button class='pasteMethod'>"+_("Email (copy/paste)")+"</button><button class='hidden localMethod'>"+_("Internal (within app)")+"</button></div></div>");if(isFileCapable)a.find(".fileMethod").removeClass("hidden").on("click",function(){a.popup("close");var e=$("<input type='file' id='configInput' data-role='none' style='visibility:hidden;position:absolute;top:-50px;left:-50px'/>").on("change",function(){var e=this.files[0],t=new FileReader;"object"!=typeof e||(t.onload=function(t){try{var e=JSON.parse($.trim(t.target.result));importConfig(e)}catch(e){showerror(_("Unable to read the configuration file. Please check the file and try again."))}},t.readAsText(e))});return e.appendTo("#sprinklers-settings"),e.click(),!1});else// Handle local storage being unavailable and present paste dialog immediately
if(!e)return void t();a.find(".pasteMethod").on("click",function(){return a.popup("close"),t(),!1}),e&&a.find(".localMethod").removeClass("hidden").on("click",function(){return a.popup("close"),importConfig(JSON.parse(e)),!1}),openPopup(a,{positionTo:$("#sprinklers-settings").find(".import_config")})}function importConfig(e){var t="";return"object"==typeof e&&e.settings?void((checkOSVersion(210)&&"object"==typeof e.options&&(e.options.hp0!==controller.options.hp0||e.options.hp1!==controller.options.hp1)||e.options.dhcp!==controller.options.dhcp||e.options.devid!==controller.options.devid)&&(t=_("Warning: Network changes will be made and the device may no longer be accessible from this address.")),areYouSure(_("Are you sure you want to restore the configuration?"),t,function(){$.mobile.loading("show");var t="/cs?pw=",a="/co?pw=",o=isOSPi(),d=function(e){return keyIndex[e]===n},l,n,s,r;for(l in e.options)if(e.options.hasOwnProperty(l)&&keyIndex.hasOwnProperty(l)){if(n=keyIndex[l],-1!==$.inArray(n,[2,14,16,21,22,25,36])&&0===e.options[l])continue;if(3===n){checkOSVersion(210)&&1===controller.options.dhcp&&(a+="&o3=1");continue}if(o&&(n=Object.keys(keyIndex).find(d),void 0===n))continue;s=!0===checkOSVersion(208)&&"string"==typeof e.options[l]?e.options[l].replace(/\s/g,"_"):e.options[l],a+="&o"+n+"="+s}// Handle import from versions prior to 2.1.1 for enable logging flag
for(!o&&"number"==typeof e.options.fwv&&211>e.options.fwv&&checkOSVersion(211)&&(a+="&o36=1"),"object"==typeof e.settings.wto&&checkOSVersion(215)&&(a+="&wto="+escapeJSON(e.settings.wto)),"string"==typeof e.settings.ifkey&&checkOSVersion(217)&&(a+="&ifkey="+e.settings.ifkey),a+="&"+(o?"o":"")+"loc="+e.settings.loc,l=0;l<e.stations.snames.length;l++)r=!0===checkOSVersion(208)?e.stations.snames[l].replace(/\s/g,"_"):e.stations.snames[l],t+="&s"+l+"="+encodeURIComponent(r);for(l=0;l<e.stations.masop.length;l++)t+="&m"+l+"="+e.stations.masop[l];if("object"==typeof e.stations.masop2)for(l=0;l<e.stations.masop2.length;l++)t+="&n"+l+"="+e.stations.masop2[l];if("object"==typeof e.stations.ignore_rain)for(l=0;l<e.stations.ignore_rain.length;l++)t+="&i"+l+"="+e.stations.ignore_rain[l];if("object"==typeof e.stations.ignore_sn1)for(l=0;l<e.stations.ignore_sn1.length;l++)t+="&j"+l+"="+e.stations.ignore_sn1[l];if("object"==typeof e.stations.ignore_sn2)for(l=0;l<e.stations.ignore_sn2.length;l++)t+="&k"+l+"="+e.stations.ignore_sn2[l];if("object"==typeof e.stations.stn_dis)for(l=0;l<e.stations.stn_dis.length;l++)t+="&d"+l+"="+e.stations.stn_dis[l];if("object"==typeof e.stations.stn_spe)for(l=0;l<e.stations.stn_spe.length;l++)t+="&p"+l+"="+e.stations.stn_spe[l];if("object"==typeof e.stations.stn_seq)for(l=0;l<e.stations.stn_seq.length;l++)t+="&q"+l+"="+e.stations.stn_seq[l];else if(!o&&"number"==typeof e.options.fwv&&211>e.options.fwv&&!checkOSVersion(211)){var c;for(c=0;c<e.settings.nbrd;c++)t+="&q"+c+"="+(1===e.options.seq?255:0)}if("object"==typeof e.stations.act_relay)for(l=0;l<e.stations.act_relay.length;l++)t+="&a"+l+"="+e.stations.act_relay[l];// Normalize station special data object
e.special=e.special||{},$.when(sendToOS(transformKeysinString(a)),sendToOS(t),sendToOS("/dp?pw=&pid=-1"),$.each(e.programs.pd,function(t,a){var i="";// Handle data from firmware 2.1+ being imported to OSPi
if(o&&"number"==typeof e.options.fwv&&210<=e.options.fwv)return showerror(_("Program data is newer than the device firmware and cannot be imported")),!1;// Handle data from firmware 2.1+ being imported to a firmware prior to 2.1
if(!o&&"number"==typeof e.options.fwv&&210<=e.options.fwv&&!checkOSVersion(210))return showerror(_("Program data is newer than the device firmware and cannot be imported")),!1;// Handle data from firmware 2.1+ being imported to a 2.1+ device
// The firmware does not accept program name inside the program array and must be submitted seperately
// Handle data from firmware prior to 2.1 being imported to a 2.1+ device
if(!o&&"number"==typeof e.options.fwv&&210<=e.options.fwv&&checkOSVersion(210)&&(i="&name="+a[5],a=a.slice(0,5)),!o&&"number"==typeof e.options.fwv&&210>e.options.fwv&&checkOSVersion(210)){var d=readProgram183(a),l=a.length-7,r=[],c=0,p,u,m;// Set enable/disable bit for program
// Using the total number of stations, migrate the duration into each station
for(c|=d.en<<0,c|=d.is_even?8:d.is_odd?4:0,c|=d.is_interval?48:0,c|=0,a[0]=c,u=0;u<l;u++)for(p=a[7+u],m=0;8>m;m++)r.push(p&1<<m?d.duration:0);// Set the start time, interval time, and repeat count
a[3]=[d.start,parseInt((d.end-d.start)/d.interval),d.interval,0],a[4]=r,a=a.slice(0,5),i="&name="+_("Program")+" "+(t+1)}sendToOS("/cp?pw=&pid=-1&v="+JSON.stringify(a)+i)}),$.each(e.special,function(e,t){checkOSVersion(216)&&sendToOS("/cs?pw=&sid="+e+"&st="+t.st+"&sd="+encodeURIComponent(t.sd))})).then(function(){setTimeout(function(){updateController(function(){$.mobile.loading("hide"),showerror(_("Backup restored to your device")),updateWeather(),goHome(!0)},function(){$.mobile.loading("hide"),networkFail()})},1500)},function(){$.mobile.loading("hide"),showerror(_("Unable to import configuration."))})})):void showerror(_("Invalid configuration"))}// About page
var showAbout=function(){function e(){a=!("undefined"!=typeof controller.options.hwv),t.find(".hardware").toggleClass("hidden",a).text(getHWVersion()+getHWType()),t.find(".hardwareLabel").toggleClass("hidden",a),t.find(".firmware").text(getOSVersion()+getOSMinorVersion()),t.one("pagehide",function(){t.detach()}),changeHeader({title:_("About"),leftBtn:{icon:"carat-l",text:_("Back"),class:"ui-toolbar-back-btn",on:goBack}}),$("#about").remove(),$.mobile.pageContainer.append(t)}var t=$("<div data-role='page' id='about'><div class='ui-content' role='main'><ul data-role='listview' data-inset='true'><li><p>"+_("User manual for OpenSprinkler is available at")+" <a class='iab' target='_blank' href='https://openthings.freshdesk.com/support/solutions/folders/5000147083'>https://support.openthings.io</a></p></li></ul><ul data-role='listview' data-inset='true'><li><p>"+_("This is open source software: source code and changelog for this application can be found at")+" <a class='iab squeeze' target='_blank' href='https://github.com/OpenSprinkler/OpenSprinkler-App/'>https://github.com/OpenSprinkler/OpenSprinkler-App/</a></p><p>"+_("Open source attributions")+": <a class='iab iabNoScale squeeze' target='_blank' href='https://github.com/OpenSprinkler/OpenSprinkler-App/wiki/List-of-Integrated-Libraries'>https://github.com/OpenSprinkler/OpenSprinkler-App/wiki/List-of-Integrated-Libraries</a></p></li></ul><p class='smaller'>"+_("App Version")+": 2.1.7<br>"+_("Firmware")+": <span class='firmware'></span><br><span class='hardwareLabel'>"+_("Hardware Version")+":</span> <span class='hardware'></span></p></div></div>"),a;return e}();// OpenSprinkler controller methods
function isRunning(){for(var e=0;e<controller.status.length;e++)if(0<controller.status[e]&&0<controller.settings.ps[e][0])return e;return-1}function stopStations(e){// It can take up to a second before stations actually stop
$.mobile.loading("show"),sendToOS("/cv?pw=&rsn=1").done(function(){setTimeout(function(){$.mobile.loading("hide"),e()},1e3)})}function flowCountToVolume(e){return parseFloat((e*((controller.options.fpr1<<8)+controller.options.fpr0)/100).toFixed(2))}// OpenSprinkler feature detection functions
function isOSPi(){return!!(controller&&"object"==typeof controller.options&&"string"==typeof controller.options.fwv&&-1!==controller.options.fwv.search(/ospi/i))}// Check if password is valid
function checkPW(e,t){$.ajax({url:currPrefix+currIp+"/sp?pw="+encodeURIComponent(e)+"&npw="+encodeURIComponent(e)+"&cpw="+encodeURIComponent(e),cache:!1,crossDomain:!0,type:"GET"}).then(function(e){var a=e.result;"undefined"==typeof a||1<a?t(!1):t(!0)},function(){t(!1)})}// Device password management functions
function changePassword(e){e=$.extend({},{fixIncorrect:!1,name:"",callback:function(){},cancel:function(){}},e);var t=isOSPi(),a=!1,i=$("<div data-role='popup' class='modal' id='changePassword' data-theme='a' data-overlay-theme='b'><ul data-role='listview' data-inset='true'>"+(!0===e.fixIncorrect?"":"<li data-role='list-divider'>"+_("Change Password")+"</li>")+"<li>"+(!0===e.fixIncorrect?"<p class='rain-desc red-text bold'>"+_("Incorrect password for ")+e.name+". "+_("Please re-enter password to try again.")+"</p>":"")+"<form method='post' novalidate><label for='npw'>"+(!0===e.fixIncorrect?_("Password:"):_("New Password")+":")+"</label><input type='password' name='npw' id='npw' value=''"+(t?"":" maxlength='32'")+">"+(!0===e.fixIncorrect?"":"<label for='cpw'>"+_("Confirm New Password")+":</label><input type='password' name='cpw' id='cpw' value=''"+(t?"":" maxlength='32'")+">")+(!0===e.fixIncorrect?"<label for='save_pw'>"+_("Save Password")+"</label><input type='checkbox' data-wrapper-class='save_pw' name='save_pw' id='save_pw' data-mini='true'>":"")+"<input type='submit' value='"+_("Submit")+"'></form></li></ul></div>");i.find("form").on("submit",function(){var n=i.find("#npw").val(),s=i.find("#cpw").val();return!0===e.fixIncorrect?(a=!0,storage.get(["sites"],function(t){var a=parseSites(t.sites),s=function(t){currPass=t,a[e.name].os_pw=i.find("#save_pw").is(":checked")?t:"",storage.set({sites:JSON.stringify(a)},cloudSaveSites),i.popup("close"),e.callback()};checkPW(md5(n),function(e){!0===e?s(md5(n)):s(n)})}),!1):n===s?""===n?(showerror(_("Password cannot be empty")),!1):(!t&&32<n.length&&showerror(_("Password cannot be longer than 32 characters")),checkOSVersion(213)&&(n=md5(n),s=md5(s)),$.mobile.loading("show"),sendToOS("/sp?pw=&npw="+encodeURIComponent(n)+"&cpw="+encodeURIComponent(s),"json").done(function(e){var t=e.result;!t||1<t?2===t?showerror(_("Please check the current device password is correct then try again")):showerror(_("Unable to change password. Please try again.")):(storage.get(["sites","current_site"],function(e){var t=parseSites(e.sites);t[e.current_site].os_pw=n,currPass=n,storage.set({sites:JSON.stringify(t)},cloudSaveSites)}),$.mobile.loading("hide"),i.popup("close"),showerror(_("Password changed successfully")))}),!1):(showerror(_("The passwords don't match. Please try again.")),!1)}),i.one("popupafterclose",function(){document.activeElement.blur(),i.remove(),e.fixIncorrect&&!a&&e.cancel()}).popup().enhanceWithin(),e.fixIncorrect?storage.get(["sites","current_site"],function(t){var a=parseSites(t.sites),n=t.current_site,s=md5(a[n].os_pw);isMD5(a[n].os_pw)?i.popup("open"):$.ajax({url:currPrefix+currIp+"/jc?pw="+s,type:"GET",dataType:"json"}).then(function(){a[n].os_pw=currPass=s,storage.set({sites:JSON.stringify(a)},cloudSaveSites),e.callback()},function(){i.popup("open")})}):i.popup("open")}function requestCloudAuth(e){e=e||function(){};var t=$("<div data-role='popup' class='modal' id='requestCloudAuth' data-theme='a'><ul data-role='listview' data-inset='true'><li data-role='list-divider'>"+_("OpenSprinkler.com Login")+"</li><li><p class='rain-desc tight'>"+_("Use your OpenSprinkler.com login and password to securely sync sites between all your devices.")+"<br><br>"+_("Don't have an account?")+" <a href='https://opensprinkler.com/wp-login.php?action=register' class='iab'>"+_("Register here")+"</a></p></li><li><form method='post' novalidate><label for='cloudUser'>"+_("Username:")+"</label><input type='text' name='cloudUser' id='cloudUser' autocomplete='off' autocorrect='off' autocapitalize='off' spellcheck='false'><label for='cloudPass'>"+_("Password:")+"</label><input type='password' name='cloudPass' id='cloudPass'><input type='submit' value='"+_("Submit")+"'></form></li></ul></div>"),a=!1;t.find("form").on("submit",function(){return $.mobile.loading("show"),cloudLogin(t.find("#cloudUser").val(),t.find("#cloudPass").val(),function(e){return!1===e?void showerror(_("Invalid username/password combination. Please try again.")):void($.mobile.loading("hide"),a=!0,t.popup("close"))}),!1}),t.one("popupafterclose",function(){e(a),a&&cloudSyncStart()}),openPopup(t)}function cloudLogin(e,t,a){a=a||function(){},$.ajax({type:"POST",dataType:"json",url:"https://opensprinkler.com/wp-admin/admin-ajax.php",data:{action:"ajaxLogin",username:e,password:t},success:function(e){"string"==typeof e.token&&storage.set({cloudToken:e.token,cloudDataToken:sjcl.codec.hex.fromBits(sjcl.hash.sha256.hash(t))}),a(e.loggedin)},fail:function(){a(!1)}})}function cloudSaveSites(e){"function"!=typeof e&&(e=function(){}),storage.get(["cloudToken","cloudDataToken","sites"],function(t){return null===t.cloudToken||void 0===t.cloudToken?void e(!1):void $.ajax({type:"POST",dataType:"json",url:"https://opensprinkler.com/wp-admin/admin-ajax.php",data:{action:"saveSites",token:t.cloudToken,sites:encodeURIComponent(JSON.stringify(sjcl.encrypt(t.cloudDataToken,t.sites)))},success:function(t){!1===t.success?("BAD_TOKEN"===t.message&&handleExpiredLogin(),e(!1,t.message)):(storage.set({cloudToken:t.token}),e(t.success))},fail:function(){e(!1)}})})}function cloudGetSites(e){e=e||function(){},storage.get(["cloudToken","cloudDataToken"],function(t){return void 0===t.cloudToken||null===t.cloudToken?void e(!1):void 0===t.cloudDataToken||null===t.cloudDataToken?(handleInvalidDataToken(),void e(!1)):void $.ajax({type:"POST",dataType:"json",url:"https://opensprinkler.com/wp-admin/admin-ajax.php",data:{action:"getSites",token:t.cloudToken},success:function(a){if(!1===a.success||""===a.sites)"BAD_TOKEN"===a.message&&handleExpiredLogin(),e(!1,a.message);else{storage.set({cloudToken:a.token});var i;try{i=sjcl.decrypt(t.cloudDataToken,a.sites)}catch(t){"ccm: tag doesn't match"===t.message&&handleInvalidDataToken(),e(!1)}try{e(JSON.parse(i))}catch(t){e(!1)}}},fail:function(){e(!1)}})})}function cloudSyncStart(){cloudGetSites(function(e){var t=$(".ui-page-active").attr("id");"start"===t?(0<Object.keys(e).length&&storage.set({sites:JSON.stringify(e)}),changePage("#site-control")):(updateLoginButtons(),storage.get("sites",function(a){if(JSON.stringify(e)!==a.sites){if(a.sites=parseSites(a.sites),currLocal)return void findLocalSiteName(e,function(t){!1===t?areYouSure(_("Do you wish to add this location to your cloud synced site list?"),_("This site is not found in the currently synced site list but may be added now."),function(){e[currIp]=a.sites.Local,storage.set({sites:JSON.stringify(e)},cloudSaveSites),storage.set({current_site:currIp}),updateSiteList(Object.keys(e),currIp)},function(){storage.remove("cloudToken",updateLoginButtons)}):(storage.set({sites:JSON.stringify(e)},cloudSaveSites),storage.set({current_site:t}),updateSiteList(Object.keys(e),t))});if(0<Object.keys(e).length){// Handle how to merge when cloud is populated
var i=$("<div data-role='popup' data-theme='a' data-overlay-theme='b'><div class='ui-bar ui-bar-a'>"+_("Select Merge Method")+"</div><div data-role='controlgroup' class='tight'><button class='merge'>"+_("Merge")+"</button><button class='replaceLocal'>"+_("Replace local with cloud")+"</button><button class='replaceCloud'>"+_("Replace cloud with local")+"</button></div></div>"),n=function(){storage.set({sites:JSON.stringify(e)},cloudSaveSites),i.popup("close"),"site-control"===t&&changePage("#site-control")};i.find(".merge").on("click",function(){e=$.extend({},a.sites,e),n()}),i.find(".replaceLocal").on("click",function(){n()}),i.find(".replaceCloud").on("click",function(){e=a.sites,n()}),i.one("popupafterclose",function(){i.popup("destroy").remove()}).popup({history:!1,positionTo:"window"}).enhanceWithin().popup("open")}else cloudSaveSites()}}))})}function cloudSync(e){"function"!=typeof e&&(e=function(){}),storage.get(["cloudToken","current_site"],function(t){"string"!=typeof t.cloudToken||cloudGetSites(function(a){!1!==a&&storage.set({sites:JSON.stringify(a)},function(){updateSiteList(Object.keys(a),t.current_site),e(),$("html").trigger("siterefresh")})})})}var corruptionNotificationShown=!1;function handleCorruptedWeatherOptions(e){corruptionNotificationShown||(addNotification({title:_("Weather Options have Corrupted"),desc:_("Click here to retrieve the partial weather option data"),on:function(){var t=$(this).parent(),a=$("<div data-role='popup' data-theme='a' class='modal ui-content' id='weatherOptionCorruption'><h3 class='center'>"+_("Weather option data has corrupted")+"</h3><h5 class='center'>"+_("Please note this may indicate other data corruption as well, please verify all settings.")+"</h5><h6 class='center'>"+_("Below is the corrupt data which could not be parsed but may be useful for restoration.")+"</h6><code>"+e[0].substr(7)+"</code><a class='ui-btn ui-corner-all ui-shadow red reset-options' style='width:80%;margin:5px auto;' href='#'>"+_("Reset All Options")+"</a><a class='ui-btn ui-corner-all ui-shadow submit' style='width:80%;margin:5px auto;' href='#'>"+_("Dismiss")+"</a></div>");return a.find(".submit").on("click",function(){return removeNotification(t),a.popup("close"),!1}),a.find(".reset-options").on("click",function(){return removeNotification(t),a.popup("close"),resetAllOptions(function(){showerror(_("Settings have been saved"))}),!1}),openPopup(a),!1}}),corruptionNotificationShown=!0)}function handleExpiredLogin(){storage.remove(["cloudToken"],updateLoginButtons),addNotification({title:_("OpenSprinkler.com Login Expired"),desc:_("Click here to re-login to OpenSprinkler.com"),on:function(){var e=$(this).parent();return requestCloudAuth(function(t){removeNotification(e),!0===t&&(updateLoginButtons(),cloudSync())}),!1}})}function handleInvalidDataToken(){storage.remove(["cloudDataToken"]),addNotification({title:_("Unable to read cloud data"),desc:_("Click here to enter a valid password to decrypt the data"),on:function(){var e=$(this).parent(),t=$("<div data-role='popup' data-theme='a' class='modal ui-content' id='dataPassword'><p class='tight rain-desc'>"+_("Please enter your OpenSprinkler.com password. If you have recently changed your password, you may need to enter your previous password to decrypt the data.")+"</p><form><input type='password' id='dataPasswordInput' name='dataPasswordInput' placeholder='"+_("Password")+"' /><input type='submit' data-theme='b' value='"+_("Submit")+"' /></form></div>"),a=!1;//Bind submit
return t.find("form").on("submit",function(){return removeNotification(e),a=!0,storage.set({cloudDataToken:sjcl.codec.hex.fromBits(sjcl.hash.sha256.hash(t.find("#dataPasswordInput").val()))},function(){t.popup("close")}),!1}),t.one("popupafterclose",function(){!0==a&&cloudSync()}),openPopup(t),!1}})}function getTokenUser(e){return atob(e).split("|")[0]}function detectUnusedExpansionBoards(){"number"==typeof controller.options.dexp&&255>controller.options.dexp&&0<=controller.options.dexp&&controller.options.ext<controller.options.dexp&&addNotification({title:_("Unused Expanders Detected"),desc:_("Click here to enable all connected stations."),on:function(){return removeNotification($(this).parent()),changePage("#os-options",{expandItem:"station"}),!1}})}function showUnifiedFirmwareNotification(){isOSPi()&&storage.get("ignoreUnifiedFirmware",function(e){"1"!==e.ignoreUnifiedFirmware&&addNotification({title:_("Unified firmware is now avaialble"),desc:_("Click here for more details"),on:function(){var e=window.open("https://openthings.freshdesk.com/support/solutions/articles/5000631599","_blank","location="+(isAndroid?"yes":"no")+",enableViewportScale=yes,toolbarposition=top,closebuttoncaption="+_("Back"));return isIEMobile&&($.mobile.document.data("iabOpen",!0),e.addEventListener("exit",function(){$.mobile.document.removeData("iabOpen")})),!1},off:function(){return storage.set({ignoreUnifiedFirmware:"1"}),!0}})})}function intToIP(e){return(255&e>>24)+"."+(255&e>>16)+"."+(255&e>>8)+"."+(255&e)}function checkPublicAccess(e){// Check if the device is accessible from it's public IP
if(0!==e){var t=intToIP(e),a=currIp.match(/.*:(\d+)/),i=function(){storage.get("ignoreRemoteFailed",function(e){"1"!==e.ignoreRemoteFailed&&addNotification({title:_("Remote access is not enabled"),desc:_("Click here to troubleshoot remote access issues"),on:function(){var e=window.open("https://openthings.freshdesk.com/support/solutions/articles/5000569763","_blank","location="+(isAndroid?"yes":"no")+",enableViewportScale=yes,toolbarposition=top,closebuttoncaption="+_("Back"));return isIEMobile&&($.mobile.document.data("iabOpen",!0),e.addEventListener("exit",function(){$.mobile.document.removeData("iabOpen")})),!1},off:function(){return storage.set({ignoreRemoteFailed:"1"}),!0}})})};t===currIp||isLocalIP(t)||!isLocalIP(currIp)||(a=a?parseInt(a[1]):80,$.ajax({url:currPrefix+t+":"+a+"/jo?pw="+currPass,global:!1,dataType:"json",type:"GET"}).then(function(e){return"object"!=typeof e||!e.hasOwnProperty("fwv")||e.fwv!==controller.options.fwv||checkOSVersion(214)&&controller.options.ip4!==e.ip4?void i():void// Public IP worked, update device IP to use the public IP instead
storage.get(["sites","current_site"],function(e){var i=parseSites(e.sites),n=e.current_site;i[n].os_ip=t+(80===a?"":":"+a),storage.set({sites:JSON.stringify(i)},cloudSaveSites)})},i))}}function logout(e){"function"!=typeof e&&(e=function(){}),areYouSure(_("Are you sure you want to logout?"),"",function(){currLocal?storage.remove(["sites","current_site","lang","provider","wapikey","runonce","cloudToken"],function(){location.reload()}):storage.remove(["cloudToken"],function(){updateLoginButtons(),e()})})}function updateLoginButtons(){var e=$(".ui-page-active");storage.get("cloudToken",function(t){var a=$(".login-button"),i=$(".logout-button");null===t.cloudToken||t.cloudToken===void 0?(a.removeClass("hidden"),!currLocal&&i.addClass("hidden"),i.find("a").text(_("Logout")),"site-control"===e.attr("id")&&e.find(".logged-in-alert").remove()):(i.removeClass("hidden").find("a").text(_("Logout")+" ("+getTokenUser(t.cloudToken)+")"),a.addClass("hidden"),"site-control"===e.attr("id")&&0===e.find(".logged-in-alert").length&&e.find(".ui-content").prepend(addSyncStatus(t.cloudToken)))})}function addNotification(e){notifications.push(e),updateNotificationBadge();var t=$("#notificationPanel");t.hasClass("ui-panel-open")&&t.find("ul").append(createNotificationItem(e)).listview("refresh")}function updateNotificationBadge(){var e=notifications.length,t=$("#header");0===e?t.find(".notifications").hide():(t.find(".notifications").show(),t.find(".notificationCount").text(e))}function createNotificationItem(e){var t=$("<li><a class='primary' href='#'><h2>"+e.title+"</h2>"+(e.desc?"<p>"+e.desc+"</p>":"")+"</a><a class='ui-btn ui-btn-icon-notext ui-icon-delete'></a></li>");return t.find(".primary").on("click",e.on),t.find(".ui-icon-delete").on("click",function(){removeNotification($(this).parent())}),t}function showNotifications(){if(0!==notifications.length){for(var e=$("#notificationPanel"),t=$("#footer-menu"),a=[$("<li data-role='list-divider'>"+_("Notifications")+"<button class='ui-btn ui-btn-icon-notext ui-icon-delete btn-no-border clear-all delete'></button></li>").on("click",".clear-all",function(){var e=$(this);e.hasClass("clear")?clearNotifications():(e.removeClass("delete ui-btn-icon-notext ui-icon-delete").addClass("clear").text(_("Clear")),setTimeout(function(){$.mobile.document.one("click",function(){e.removeClass("clear").addClass("delete ui-btn-icon-notext ui-icon-delete").text("")})},1))})],n=notifications.length-1;0<=n;n--)a.push(createNotificationItem(notifications[n]));e.find("ul").replaceWith($("<ul/>").append(a).listview()),e.on("panelbeforeclose",function(){t.removeClass("moveLeft")}),e.panel().panel("option","classes.modal","needsclick ui-panel-dismiss"),t.addClass("moveLeft"),e.panel("open")}}function clearNotifications(){var e=$("#notificationPanel");notifications=[],updateNotificationBadge(),e.find("ul").empty(),e.hasClass("ui-panel-open")&&e.panel("close")}function removeNotification(e){var t=$("#notificationPanel"),a=notifications[e.index()-1].off;("function"!=typeof a||a())&&(notifications.remove(e.index()-1),e.remove(),updateNotificationBadge(),0===notifications.length&&t.hasClass("ui-panel-open")&&t.panel("close"))}function checkFirmwareUpdate(){checkOSVersion(200)&&("3.0"===getHWVersion()||isOSPi())&&$.getJSON("https://api.github.com/repos/opensprinkler/opensprinkler-firmware/releases").done(function(e){controller.options.fwv<e[0].tag_name&&storage.get("updateDismiss",function(t){(!t.updateDismiss||t.updateDismiss<e[0].tag_name)&&addNotification({title:_("Firmware update available"),on:function(){// Modify the changelog by parsing markdown of lists to HTML
var t=$(this).parent(),a=30===controller.options.hwv||63<controller.options.hwv&&checkOSVersion(216),i=e[0].html_url,n=$("<div data-role='popup' class='modal' data-theme='a'><h3 class='center' style='margin-bottom:0'>"+_("Latest")+" "+_("Firmware")+": "+e[0].name+"</h3><h5 class='center' style='margin:0'>"+_("This Controller")+": "+getOSVersion()+getOSMinorVersion()+"</h5><a class='iab ui-btn ui-corner-all ui-shadow' style='width:80%;margin:5px auto;' target='_blank' href='"+i+"'>"+_("View Changelog")+"</a><a class='guide ui-btn ui-corner-all ui-shadow' style='width:80%;margin:5px auto;' href='#'>"+_("Update Guide")+"</a>"+(a?"<a class='update ui-btn ui-corner-all ui-shadow' style='width:80%;margin:5px auto;' href='#'>"+_("Update Now")+"</a>":"")+"<a class='dismiss ui-btn ui-btn-b ui-corner-all ui-shadow' style='width:80%;margin:5px auto;' href='#'>"+_("Dismiss")+"</a></div>");n.find(".update").on("click",function(){return 30===controller.options.hwv?void $("<a class='hidden iab' href='"+currPrefix+currIp+"/update'></a>").appendTo(n).click():void// For OSPi/OSBo with firmware 2.1.6 or newer, trigger the update script from the app
sendToOS("/cv?pw=&update=1","json").then(function(){showerror(_("Update successful")),n.find(".dismiss").click()},function(){$.mobile.loading("show",{html:"<div class='center'>"+_("Update did not complete.")+"<br><a class='iab ui-btn' href='https://openthings.freshdesk.com/support/solutions/articles/5000631599-installing-and-updating-the-unified-firmware#upgrade'>"+_("Update Guide")+"</a></div>",textVisible:!0,theme:"b"}),setTimeout(function(){$.mobile.loading("hide")},3e3)})}),n.find(".guide").on("click",function(){var e=63<controller.options.hwv?"https://openthings.freshdesk.com/support/solutions/articles/5000631599-installing-and-updating-the-unified-firmware#upgrade":"https://openthings.freshdesk.com/support/solutions/articles/5000381694-opensprinkler-firmware-update-guide";// Open the firmware upgrade guide in a child browser
$("<a class='hidden iab' href='"+e+"'></a>").appendTo(n).click()}),n.find(".dismiss").one("click",function(){return storage.set({updateDismiss:e[0].tag_name}),n.popup("close"),removeNotification(t),!1}),openPopup(n)}})})})}function stopAllStations(){return!!isControllerConnected()&&void areYouSure(_("Are you sure you want to stop all stations?"),"",function(){$.mobile.loading("show"),sendToOS("/cv?pw=&rsn=1").done(function(){$.mobile.loading("hide"),removeStationTimers(),refreshStatus(),showerror(_("All stations have been stopped"))})})}function checkOSPiVersion(e){var t;return!!isOSPi()&&(t=controller.options.fwv.split("-")[0],t===e||(t=t.split("."),e=e.split("."),versionCompare(t,e)))}function checkOSVersion(e){var t=controller.options.fwv;// If check is 4 digits then we need to include the minor version number as well
return 1e3<=e&&(t=10*t+controller.options.fwm),!isOSPi()&&(e===t||versionCompare(t.toString().split(""),e.toString().split("")))}function versionCompare(e,t){for(// Returns false when check < ver and 1 when check > ver
var a=Math.min,n=Math.max,s=n(e.length,t.length),o;e.length<s;)e.push(0);for(;t.length<s;)t.push(0);for(var d=0;d<s&&(o=n(-1,a(1,e[d]-t[d])),0===o);d++);return-1===o&&(o=!1),o}function getOSVersion(e){return e||"object"!=typeof controller.options||(e=controller.options.fwv),"string"==typeof e&&-1!==e.search(/ospi/i)?e:(e/100>>0)+"."+(e/10>>0)%10+"."+e%10}function getOSMinorVersion(){return!isOSPi()&&"object"==typeof controller.options&&"number"==typeof controller.options.fwm&&0<controller.options.fwm?" ("+controller.options.fwm+")":""}function getHWVersion(e){if(!e)if("object"==typeof controller.options&&"undefined"!=typeof controller.options.hwv)e=controller.options.hwv;else return!1;return"string"==typeof e?e:64===e?"OSPi":128===e?"OSBo":192===e?"Linux":255===e?"Demo":(e/10>>0)%10+"."+e%10}function getHWType(){return isOSPi()||"number"!=typeof controller.options.hwt||0===controller.options.hwt?"":172===controller.options.hwt?" - AC":220===controller.options.hwt?" - DC":26===controller.options.hwt?" - Latching":""}// Accessory functions for jQuery Mobile
function areYouSure(e,t,a,i){$("#sure").popup("destroy").remove(),a=a||function(){},i=i||function(){};var n=$("<div data-role='popup' data-theme='a' id='sure'><h3 class='sure-1 center'>"+e+"</h3><p class='sure-2 center'>"+t+"</p><a class='sure-do ui-btn ui-btn-b ui-corner-all ui-shadow' href='#'>"+_("Yes")+"</a><a class='sure-dont ui-btn ui-corner-all ui-shadow' href='#'>"+_("No")+"</a></div>");//Bind buttons
n.find(".sure-do").one("click.sure",function(){return n.popup("close"),a(),!1}),n.find(".sure-dont").one("click.sure",function(){return n.popup("close"),i(),!1}),openPopup(n)}function showIPRequest(e){var t={title:_("Enter IP Address"),ip:[0,0,0,0],showBack:!0,callback:function(){}};e=$.extend({},t,e),$("#ipInput").popup("destroy").remove();var a=$("<div data-role='popup' id='ipInput' data-theme='a'><div data-role='header' data-theme='b'><h1>"+e.title+"</h1></div><div class='ui-content'><span><fieldset class='ui-grid-c incr'><div class='ui-block-a'><a href='#' data-role='button' data-mini='true' data-corners='true' data-icon='plus' data-iconpos='bottom'></a></div><div class='ui-block-b'><a href='#' data-role='button' data-mini='true' data-corners='true' data-icon='plus' data-iconpos='bottom'></a></div><div class='ui-block-c'><a href='#' data-role='button' data-mini='true' data-corners='true' data-icon='plus' data-iconpos='bottom'></a></div><div class='ui-block-d'><a href='#' data-role='button' data-mini='true' data-corners='true' data-icon='plus' data-iconpos='bottom'></a></div></fieldset><div class='ui-grid-c inputs'><div class='ui-block-a'><input data-wrapper-class='pad_buttons' class='ip_addr' type='number' pattern='[0-9]*' max='255' value='"+e.ip[0]+"'></div><div class='ui-block-b'><input data-wrapper-class='pad_buttons' class='ip_addr' type='number' pattern='[0-9]*' max='255' value='"+e.ip[1]+"'></div><div class='ui-block-c'><input data-wrapper-class='pad_buttons' class='ip_addr' type='number' pattern='[0-9]*' max='255' value='"+e.ip[2]+"'></div><div class='ui-block-d'><input data-wrapper-class='pad_buttons' class='ip_addr' type='number' pattern='[0-9]*' max='255' value='"+e.ip[3]+"'></div></div><fieldset class='ui-grid-c decr'><div class='ui-block-a'><a href='#' data-role='button' data-mini='true' data-corners='true' data-icon='minus' data-iconpos='bottom'></a></div><div class='ui-block-b'><a href='#' data-role='button' data-mini='true' data-corners='true' data-icon='minus' data-iconpos='bottom'></a></div><div class='ui-block-c'><a href='#' data-role='button' data-mini='true' data-corners='true' data-icon='minus' data-iconpos='bottom'></a></div><div class='ui-block-d'><a href='#' data-role='button' data-mini='true' data-corners='true' data-icon='minus' data-iconpos='bottom'></a></div></fieldset></span>"+(e.showBack?"<button class='submit' data-theme='b'>"+_("Submit")+"</button>":"")+"</div></div>"),i=function(t,i){var s=a.find(".inputs input").eq(t),o=parseInt(s.val());-1===i&&0===o||1===i&&255<=o||(s.val(o+i),e.callback(n()))},n=function(){return $.makeArray(a.find(".ip_addr").map(function(){return parseInt($(this).val())}))};a.find("button.submit").on("click",function(){e.callback(n()),a.popup("destroy").remove()}),a.on("focus","input[type='number']",function(){this.value=""}).on("blur","input[type='number']",function(){""===this.value&&(this.value="0")}),holdButton(a.find(".incr").children(),function(t){var e=$(t.currentTarget).index();return i(e,1),!1}),holdButton(a.find(".decr").children(),function(t){var e=$(t.currentTarget).index();return i(e,-1),!1}),a.css("max-width","350px").one("popupafterclose",function(){e.callback(n())}),openPopup(a)}function showDurationBox(e){var t=String.fromCharCode,a=Math.abs,n={seconds:0,title:_("Duration"),granularity:0,preventCompression:!1,incrementalUpdate:!0,showBack:!0,showSun:!1,minimum:0,callback:function(){}},s=0;e=$.extend({},n,e),$("#durationBox").popup("destroy").remove(),e.seconds=parseInt(e.seconds),65535===e.seconds?(s=1,e.seconds=0):65534===e.seconds&&(s=2,e.seconds=0),checkOSVersion(217)&&(e.preventCompression=!0);var o=["days","hours","minutes","seconds"],d=[_("Days"),_("Hours"),_("Minutes"),_("Seconds")],l=[86400,3600,60,1],r=[0,23,59,59],c=4-e.granularity,p=0,u=sec2dhms(e.seconds),m;if(!e.preventCompression&&checkOSVersion(210)&&64800<e.maximum&&(e.maximum=checkOSVersion(214)?57600:64800),e.maximum)for(m=l.length-1;0<=m;m--)if(e.maximum<l[m]){p=m+1,c=l.length-p-e.granularity;break}var h="<fieldset class='ui-grid-"+t(95+c)+" incr'>",b="<div class='ui-grid-"+t(95+c)+" inputs'>",g="<fieldset class='ui-grid-"+t(95+c)+" decr'>",f=$("<div data-role='popup' id='durationBox' data-theme='a'><div data-role='header' data-theme='b'><h1>"+e.title+"</h1></div><div class='ui-content'>"+(e.helptext?"<p class='rain-desc center smaller'>"+e.helptext+"</p>":"")+"<span></span>"+(e.showSun?"<div class='ui-grid-a useSun'><div class='ui-block-a'><button value='65534' class='ui-mini ui-btn rise "+(2==s?"ui-btn-active":"")+"'>"+_("Sunrise to Sunset")+"</button></div><div class='ui-block-b'><button value='65535' class='ui-mini ui-btn set "+(1==s?"ui-btn-active":"")+"'>"+_("Sunset to Sunrise")+"</button></div></div>":"")+(e.showBack?"<button class='submit' data-theme='b'>"+_("Submit")+"</button>":"")+"</div></div>"),v=function(t,i){var n=f.find(".inputs input").eq(t),s=t+p,o=parseInt(n.val());// Increment next time field on current max
if(!n.prop("disabled")&&!(-1===i&&(w()<=e.minimum||0>=o)||1===i&&w()+l[s]>e.maximum)&&(0!==r[s]&&0!==t&&a(o)>=r[s]&&(n.val(0),n=f.find(".inputs input").eq(t-1),o=parseInt(n.val())),n.val(o+i),e.incrementalUpdate&&e.callback(w()),!e.preventCompression&&checkOSVersion(210))){var d=1===i;1===i?(60<=w()&&y("seconds",d),10800<=w()&&y("minutes",d)):-1==i&&(-60>=w()?y("seconds",!d):-10800>=w()?y("minutes",!d):60>w()?y("seconds",d):10800>w()&&y("minutes",d))}},w=function(){var e=f.find(".useSun").find("button.ui-btn-active");return 1===e.length?parseInt(e.val()):dhms2sec({days:parseInt(f.find(".days").val())||0,hours:parseInt(f.find(".hours").val())||0,minutes:parseInt(f.find(".minutes").val())||0,seconds:parseInt(f.find(".seconds").val())||0})},y=function(e,t){f.find("."+e).toggleClass("ui-state-disabled",t).prop("disabled",t).val(function(){return t?0:this.value}).parent(".ui-input-text").toggleClass("ui-state-disabled",t)};for(m=p;m<l.length-e.granularity;m++)h+="<div "+(1<c?"class='ui-block-"+t(97+m-p)+"'":"")+"><a href='#' data-role='button' data-mini='true' data-corners='true' data-icon='plus' data-iconpos='bottom'></a></div>",b+="<div "+(1<c?"class='ui-block-"+t(97+m-p)+"'":"")+"><label class='center'>"+_(d[m])+"</label><input data-wrapper-class='pad_buttons' class='"+o[m]+"' type='number' pattern='[0-9]*' value='"+u[o[m]]+"'></div>",g+="<div "+(1<c?"class='ui-block-"+t(97+m-p)+"'":"")+"><a href='#' data-role='button' data-mini='true' data-corners='true' data-icon='minus' data-iconpos='bottom'></a></div>";h+="</fieldset>",b+="</div>",g+="</fieldset>",f.find("span").prepend(h+b+g),f.find("button.submit").on("click",function(){e.callback(w()),f.popup("destroy").remove()}),!e.preventCompression&&checkOSVersion(210)&&(-60>=e.seconds&&y("seconds",!0),-10800>=e.seconds&&y("minutes",!0),60<=e.seconds&&y("seconds",!0),10800<=e.seconds&&y("minutes",!0)),f.on("focus","input[type='number']",function(){this.value=""}).on("blur","input[type='number']",function(){""===this.value&&(this.value="0")}),holdButton(f.find(".incr").children(),function(t){var e=$(t.currentTarget).index();return v(e,1),!1}),holdButton(f.find(".decr").children(),function(t){var e=$(t.currentTarget).index();return v(e,-1),!1}),e.showSun&&f.find(".useSun").on("click","button",function(){var t=$(this),a=f.find(".useSun").find("button").not(t),i=f.find("span").find(".ui-btn,input");a.removeClass("ui-btn-active"),t.hasClass("ui-btn-active")?(t.removeClass("ui-btn-active"),i.prop("disabled",!1).removeClass("ui-disabled")):(t.addClass("ui-btn-active"),i.prop("disabled",!0).addClass("ui-disabled")),e.incrementalUpdate&&e.callback(w())}),f.css("max-width","350px").one("popupafteropen",function(){0!=s&&f.find("span").find(".ui-btn,input").prop("disabled",!0).addClass("ui-disabled")}).one("popupafterclose",function(){e.incrementalUpdate&&e.callback(w())}),openPopup(f)}function showSingleDurationInput(e){$("#singleDuration").popup("destroy").remove();var t={data:0,title:_("Duration"),minimum:0,label:"",updateOnChange:!0,showBack:!0,callback:function(){}};e=$.extend({},t,e);var a=$("<div data-role='popup' id='singleDuration' data-theme='a'><div data-role='header' data-theme='b'><h1>"+e.title+"</h1></div><div class='ui-content'>"+(e.helptext?"<p class='rain-desc center smaller'>"+e.helptext+"</p>":"")+"<label class='center'>"+e.label+"</label><div class='input_with_buttons'><button class='decr ui-btn ui-btn-icon-notext ui-icon-carat-l btn-no-border'></button><input type='number' pattern='[0-9]*' value='"+e.data+"'><button class='incr ui-btn ui-btn-icon-notext ui-icon-carat-r btn-no-border'></button></div>"+(e.updateOnChange&&!e.showBack?"":"<input type='submit' data-theme='b' value='"+_("Submit")+"'>")+"</div></div>"),i=a.find("input"),n=function(t){e.callback(parseInt(t).clamp(e.minimum,e.maximum))},s=function(t){var a=parseInt(i.val());-1===t&&a===e.minimum||1===t&&a===e.maximum||(i.val(a+t),e.updateOnChange&&n(a+t))};holdButton(a.find(".incr"),function(){return s(1),!1}),holdButton(a.find(".decr"),function(){return s(-1),!1}),a.find("input[type='number']").on("focus",function(){this.value=""}).on("blur",function(){""===this.value&&(this.value="0")}),a.find("input[type='submit']").on("click",function(){n(i.val()),a.popup("destroy").remove()}),a.one("popupafterclose",function(){e.updateOnChange&&n(i.val())}),openPopup(a)}function showDateTimeInput(e,t){var a=String.fromCharCode;$("#datetimeInput").popup("destroy").remove(),e instanceof Date||(e=new Date(1e3*e),e.setMinutes(e.getMinutes()-e.getTimezoneOffset())),t=t||function(){};var n=["Month","Date","FullYear","Hours","Minutes"],s=[_("Jan"),_("Feb"),_("Mar"),_("Apr"),_("May"),_("Jun"),_("Jul"),_("Aug"),_("Sep"),_("Oct"),_("Nov"),_("Dec")],o=$("<div data-role='popup' id='datetimeInput' data-theme='a'><div data-role='header' data-theme='b'><h1>"+_("Enter Date/Time")+"</h1></div><div class='ui-content'></div></div>"),d=function(a,i){e["setUTC"+a](e["getUTC"+a]()+i),t(new Date(e.getTime())),l()},l=function(){var t="<fieldset class='ui-grid-d incr'>",l="<div class='ui-grid-d inputs'>",r="<fieldset class='ui-grid-d decr'>",c,p,u;for(u=0;5>u;u++)c=e["getUTC"+n[u]](),p="",c="Month"===n[u]?"<p class='center'>"+s[c]+"</p>":"Date"===n[u]?"<p class='center'>"+c+",</p>":"Hours"===n[u]?"<p style='width:90%;display:inline-block' class='center'>"+c+"</p><p style='display:inline-block'>:</p>":"<p class='center'>"+c+"</p>",t+="<div class='ui-block-"+a(97+u)+"'><a href='#' data-role='button' data-mini='true' data-corners='true' data-icon='plus' data-iconpos='bottom'></a></div>",l+="<div id='"+n[u]+"' class='ui-block-"+a(97+u)+"'>"+c+"</div>",r+="<div class='ui-block-"+a(97+u)+"'><a href='#' data-role='button' data-mini='true' data-corners='true' data-icon='minus' data-iconpos='bottom'></a></div>";t+="</fieldset>",l+="</div>",r+="</fieldset>",o.find(".ui-content").html("<span>"+t+l+r+"</span>").enhanceWithin(),o.find(".incr").children().on("vclick",function(){var e=$(this).index();return d(o.find(".inputs").children().eq(e).attr("id"),1),!1}),o.find(".decr").children().on("vclick",function(){var e=$(this).index();return d(o.find(".inputs").children().eq(e).attr("id"),-1),!1})};l(),o.css("width","280px").one("popupafterclose",function(){t(e)}),openPopup(o)}function showTimeInput(e){var t={minutes:0,title:_("Time"),incrementalUpdate:!0,showBack:!0,showSun:!1,callback:function(){}};e=$.extend({},t,e),$("#timeInput").popup("destroy").remove();var a=2047&e.minutes,i=0;1&e.minutes>>12&&(a=-a),1&e.minutes>>14?i=1:1&e.minutes>>13&&(i=2);var n=!!(719<e.minutes),s=function(){return n?_("PM"):_("AM")},o=$("<div data-role='popup' id='timeInput' data-theme='a'><div data-role='header' data-theme='b'><h1>"+e.title+"</h1></div><div class='ui-content'>"+(e.helptext?"<p class='pad-top rain-desc center smaller'>"+e.helptext+"</p>":"")+"<span><fieldset class='ui-grid-b incr'><div class='ui-block-a'><a href='#' data-role='button' data-mini='true' data-corners='true' data-icon='plus' data-iconpos='bottom'></a></div><div class='ui-block-b'><a href='#' data-role='button' data-mini='true' data-corners='true' data-icon='plus' data-iconpos='bottom'></a></div><div class='ui-block-c'><a href='#' data-role='button' data-mini='true' data-corners='true' data-icon='plus' data-iconpos='bottom'></a></div></fieldset><div class='ui-grid-b inputs'><div class='ui-block-a'><input data-wrapper-class='pad_buttons' class='hour dontPad' type='number' pattern='[0-9]*' value='"+(0==parseInt(e.minutes/60)%12?12:parseInt(e.minutes/60)%12)+"'></div><div class='ui-block-b'><input data-wrapper-class='pad_buttons' class='minute' type='number' pattern='[0-9]*' value='"+pad(e.minutes%60)+"'></div><div class='ui-block-c'><p class='center period'>"+s()+"</p></div></div><fieldset class='ui-grid-b decr'><div class='ui-block-a'><a href='#' data-role='button' data-mini='true' data-corners='true' data-icon='minus' data-iconpos='bottom'></a></div><div class='ui-block-b'><a href='#' data-role='button' data-mini='true' data-corners='true' data-icon='minus' data-iconpos='bottom'></a></div><div class='ui-block-c'><a href='#' data-role='button' data-mini='true' data-corners='true' data-icon='minus' data-iconpos='bottom'></a></div></fieldset></span>"+(e.showSun?"<div class='ui-grid-a useSun'><div class='ui-block-a'><button class='ui-mini ui-btn rise "+(1==i?"ui-btn-active":"")+"'>"+_("Use Sunrise")+"</button></div><div class='ui-block-b'><button class='ui-mini ui-btn set "+(2==i?"ui-btn-active":"")+"'>"+_("Use Sunset")+"</button></div></div><div class='offsetInput'"+(0==i?" style='display: none;'":"")+"><h5 class='center tight'>"+_("Offset (minutes)")+"</h5><div class='input_with_buttons'><button class='decr ui-btn ui-btn-icon-notext ui-icon-carat-l btn-no-border'></button><input class='dontPad' type='number' pattern='[0-9]*' value='"+a+"'><button class='incr ui-btn ui-btn-icon-notext ui-icon-carat-r btn-no-border'></button></div></div>":"")+(e.showBack?"<button class='submit' data-theme='b'>"+_("Submit")+"</button>":"")+"</div></div>"),d=function(t,a){if(0===t||1===t){var i=l(),d=i+a*(0===t?60:1),r=o.find(".inputs input").eq(t),c=r.hasClass("hour"),p=parseInt(r.val());if(1===a){if(c&&12<=p&&(p=0),!c&&59<=p){p=-1;var u=o.find(".hour"),m=parseInt(u.val());12===m&&(m=0),u.val(m+1)}}else if(c&&1>=p)p=13;else if(!c&&0>=p)return;(!n&&719<d||n&&721>d||n&&1439<d||!n&&-1===a&&0>d)&&(n=!n,o.find(".period").text(s())),p=c?p+a:pad(p+a),r.val(p)}else 2===t&&(n=!n,o.find(".period").text(s()));e.incrementalUpdate&&e.callback(l())},l=function(){var e=o.find(".useSun").find("button.ui-btn-active");if(1===e.length){var t=0,a=parseInt(o.find(".offsetInput input").val());return e.hasClass("rise")?(0<=a?t=a:(t=-a,t|=4096),t|=16384):(0<=a?t=a:(t=-a,t|=4096),t|=8192),t}var i=parseInt(o.find(".hour").val());return n&&12!==i&&(i+=12),n||12!==i||(i=0),60*i+parseInt(o.find(".minute").val())};if(o.find("button.submit").on("click",function(){e.callback(l()),o.popup("destroy").remove()}),o.on("focus","input[type='number']",function(t){t.target.value=""}).on("blur","input[type='number']",function(t){var e=parseInt(t.target.value)||0;t.target.value=$(t.target).hasClass("dontPad")?e:pad(e)}),holdButton(o.find(".incr").children(),function(t){var e=$(t.currentTarget),a=e.index();return 0===e.find(".ui-disabled").length&&d(a,1),!1}),holdButton(o.find(".decr").children(),function(t){var e=$(t.currentTarget),a=e.index();return 0===e.find(".ui-disabled").length&&d(a,-1),!1}),e.showSun){o.find(".useSun").on("click","button",function(){var t=$(this),a=o.find(".useSun").find("button").not(t),i=o.find(".offsetInput"),n=o.find("span").find(".ui-btn,input,p");a.removeClass("ui-btn-active"),t.hasClass("ui-btn-active")?(t.removeClass("ui-btn-active"),i.slideUp(),n.prop("disabled",!1).removeClass("ui-disabled")):(t.addClass("ui-btn-active"),i.slideDown(),n.prop("disabled",!0).addClass("ui-disabled")),e.incrementalUpdate&&e.callback(l())});var r=o.find(".offsetInput").find("input"),c=function(t){var a=parseInt(r.val());-1===t&&-240===a||1===t&&240===a||(r.val(a+t),e.incrementalUpdate&&e.callback(l()))};r.on("focus",function(){this.value=""}).on("blur",function(){""===this.value?this.value="0":240<this.value?this.value="240":-240>this.value&&(this.value="-240")}),holdButton(o.find(".offsetInput").find(".incr"),function(){return c(1),!1}),holdButton(o.find(".offsetInput").find(".decr"),function(){return c(-1),!1})}o.css("max-width","350px").one("popupafteropen",function(){0!=i&&o.find("span").find(".ui-btn,input,p").prop("disabled",!0).addClass("ui-disabled")}).one("popupafterclose",function(){e.incrementalUpdate&&e.callback(l())}),openPopup(o)}function showHelpText(t){t.stopImmediatePropagation();var e=$(this),a=e.data("helptext"),i;return i=$("<div data-role='popup' data-theme='a'><p>"+a+"</p></div>"),openPopup(i,{positionTo:e}),!1}$.fn.focusInput=function(){if(this.get(0).setSelectionRange)this.focus(),this.get(0).setSelectionRange(0,this.val().length);else if(this.get(0).createTextRange){var e=this.get(0).createTextRange();e.collapse(!0),e.moveEnd("character",this.val().length),e.moveStart("character",0),e.select()}return this},Number.prototype.clamp=function(e,t){return Math.min(Math.max(this,e),t)};function changePage(e,t){// Close the panel before page transition to avoid bug in jQM 1.4+
t=t||{},0!==e.indexOf("#")&&(e="#"+e),closePanel(function(){$.mobile.pageContainer.pagecontainer("change",e,t)})}function openPopup(e,t){t=$.extend({},{history:!1,positionTo:"window",overlayTheme:"b"},t),$.mobile.pageContainer.append(e),e.one("popupafterclose",function(){e.popup("destroy").remove()}).popup(t).enhanceWithin(),e.popup("open")}function closePanel(e){var t=$(".ui-panel-open");return 0<t.length?(t.one("panelclose",function(){e()}),void t.panel("close")):void e()}// Change persistent header
function changeHeader(e){// Declare function defaults
var t=$("#header");// Merge defaults with supplied options
e=$.extend(!0,{},{title:"",class:"",animate:!0,leftBtn:{icon:"",class:"",text:"",on:function(){}},rightBtn:{icon:"",class:"",text:"",on:function(){}}},e),""===e.title&&""===e.class&&(e.class="logo");// Generate new header content
var a=$("<button data-icon='"+e.leftBtn.icon+"' "+(""===e.leftBtn.text?"data-iconpos='notext' ":"")+"class='ui-btn-left "+e.leftBtn.class+"'>"+e.leftBtn.text+"</button><h3 class='"+e.class+"'>"+e.title+"</h3><button data-icon='"+e.rightBtn.icon+"' "+(""===e.rightBtn.text?"data-iconpos='notext' ":"")+"class='ui-btn-right "+e.rightBtn.class+"'>"+e.rightBtn.text+"</button>"),i=e.animate?"fast":0;// Fade out the header content, replace it, and update the header
return t.children().stop().fadeOut(i,function(){t.html(a).toolbar(t.hasClass("ui-header")?"refresh":null),t.find(".ui-btn-left").on("click",e.leftBtn.on),t.find(".ui-btn-right").on("click",e.rightBtn.on)}).fadeIn(i),a}function getPageTop(){var e=$.mobile.window;return{x:(e[0].innerWidth||e.width())/2+e.scrollLeft(),y:e.scrollTop()+22.5}}// Show loading indicator within element(s)
function showLoading(e){e="string"==typeof e?$(e):e,e.off("click").html("<p class='ui-icon ui-icon-loading mini-load'></p>");var t=e.filter("#footer-running");1===t.length&&t.find(".mini-load").addClass("bottom")}function takePicture(e){"object"!=typeof navigator.camera||"function"!=typeof navigator.camera.getPicture||navigator.camera.getPicture(e,function(){},{quality:50,destinationType:Camera.DestinationType.DATA_URL,sourceType:Camera.PictureSourceType.PHOTOLIBRARY,allowEdit:!0,targetWidth:200,targetHeight:200})}function goHome(e){// Transition to home page after succesful load
if("sprinklers"!==$(".ui-page-active").attr("id")){$.mobile.document.one("pageshow",function(){// Allow future transitions to properly animate
delete $.mobile.navigate.history.getActive().transition});var t={reverse:!0};!0===e&&(t={firstLoad:!0,showLoading:!1,transition:"none"}),changePage("#sprinklers",t)}}function goBack(){var e=$(".ui-page-active");// Prevent back navigation during active page transition
if(1===e.length){e=e.attr("id");var t="site-control"===e&&!isControllerConnected(),a=$(".ui-popup-active");if(a.length)return void a.find("[data-role='popup']").popup("close");if("sprinklers"===e||"start"===e||t)try{navigator.app.exitApp()}catch(e){}else if(isChromeApp||"file:"===window.location.protocol){var i=$.mobile.navigate.history.getPrev().url;if("#"!==i.slice(0,1))return;changePage(i,{reverse:!0}),$.mobile.document.one("pagehide",function(){$.mobile.navigate.history.activeIndex-=2})}else 0<pageHistoryCount&&pageHistoryCount--,0==pageHistoryCount?navigator.app.exitApp():(goingBack=!0,$.mobile.back())}}function checkChangesBeforeBack(){checkChanges(goBack)}function checkChanges(e){var t=$(".ui-page-active"),a=t.find(".hasChanges");return e=e||function(){},0===a.length?void e():(areYouSure(_("Do you want to save your changes?"),"",function(){a.click(),a.hasClass("preventBack")||e()},e),!1)}// Show error message box
function showerror(e,t){// Hide after provided delay
t=t||2500,clearTimeout(errorTimeout),$.mobile.loading("show",{text:e,textVisible:!0,textonly:!0,theme:"b"}),errorTimeout=setTimeout(function(){$.mobile.loading("hide")},t)}function loadUnitSetting(){storage.get("isMetric",function(e){// We are using a switch because the boolean gets stored as a string
// and we don't want to impact the in-memory value of `isMetric` when
// no value in local storage exists.
switch(e.isMetric){case"true":isMetric=!0;break;case"false":isMetric=!1;break;default:}})}// Accessory functions
function fixInputClick(e){FastClick.notNeeded(document.body)||(e.find("input[type='checkbox']:not([data-role='flipswitch']),.ui-select > .ui-btn").addClass("needsclick"),e.find(".ui-collapsible-heading-toggle").on("click",function(){var e=$(this);setTimeout(function(){e.removeClass("ui-btn-active")},100)}))}// Bind buttons to allow push and hold effects
function holdButton(e,t){var a;e.on(isTouchCapable?"tap":"click",t).on("taphold",function(i){a=setInterval(function(){t(i)},100)}).on("vmouseup vmouseout vmousecancel touchend",function(){clearInterval(a)}).on("touchmove",function(t){t.preventDefault()})}// Insert style string into the DOM
function insertStyle(e){var t=document.createElement("style");t.innerHTML=e,document.head.appendChild(t)}// Convert all elements in array to integer
function parseIntArray(e){for(var t=0;t<e.length;t++)e[t]=+e[t];return e}function getDurationText(e){return 65535===e?_("Sunset to Sunrise"):65534===e?_("Sunrise to Sunset"):dhms2str(sec2dhms(e))}// Convert seconds into (HH:)MM:SS format. HH is only reported if greater than 0.
function sec2hms(e){var t=Math.max,a="",i=t(0,parseInt(e/3600)%24),n=t(0,parseInt(e/60)%60);return i&&(a+=pad(i)+":"),a+pad(n)+":"+pad(e%60)}// Convert seconds into array of days, hours, minutes and seconds.
function sec2dhms(e){var t=Math.max,a=Math.abs,i=0>e?-1:1;return e=a(e),{days:t(0,parseInt(e/86400))*i,hours:t(0,parseInt(e%86400/3600))*i,minutes:t(0,parseInt(e%86400%3600/60))*i,seconds:t(0,parseInt(e%86400%3600%60))*i}}function dhms2str(e){var t="";return e.days&&(t+=e.days+_("d")+" "),e.hours&&(t+=e.hours+_("h")+" "),e.minutes&&(t+=e.minutes+_("m")+" "),e.seconds&&(t+=e.seconds+_("s")+" "),""==t&&(t="0"+_("s")),t.trim()}// Convert days, hours, minutes and seconds array into seconds (int).
function dhms2sec(e){return parseInt(86400*e.days+3600*e.hours+60*e.minutes+e.seconds)}function isControllerConnected(){return!(""===currIp||$.isEmptyObject(controller)||$.isEmptyObject(controller.options)||$.isEmptyObject(controller.programs)||$.isEmptyObject(controller.settings)||$.isEmptyObject(controller.status)||$.isEmptyObject(controller.stations))}// Generate export link for JSON data
function exportObj(e,t,a){if(t=encodeURIComponent(JSON.stringify(t)),isFileCapable)$(e).attr({href:"data:text/json;charset=utf-8,"+t,download:"backup-"+new Date().toLocaleDateString().replace(/\//g,"-")+".json"});else{a=a||"OpenSprinkler Data Export on "+dateToString(new Date);var i="mailto:?subject="+encodeURIComponent(a)+"&body="+t;$(e).attr("href",i).on("click",function(){window.open(i)})}}function sortObj(e,t){var a=[];for(var n in e)e.hasOwnProperty(n)&&a.push(n);"function"==typeof t?a.sort(t):"value"===t?a.sort(function(t,a){var i=e[t],n=e[a];return i<n?-1:i>n?1:0}):a.sort();for(var s={},o=0;o<a.length;o++)s[a[o]]=e[a[o]];return s}// Return day of the week
function getDayName(e,t){var a=[_("Sunday"),_("Monday"),_("Tuesday"),_("Wednesday"),_("Thursday"),_("Friday"),_("Saturday")],i=[_("Sun"),_("Mon"),_("Tue"),_("Wed"),_("Thu"),_("Fri"),_("Sat")];return"short"===t?i[e.getDay()]:a[e.getDay()]}// Pad a single digit with a leading zero
function pad(e){var t=e+"";return 1===t.length&&(t="0"+t),t}// Escape characters for HTML support
function htmlEscape(e){return(e+"").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}//Localization functions
function _(e){//Translate item (key) based on currently defined language
if("object"==typeof language&&language.hasOwnProperty(e)){var t=language[e];return t?t:e}//If English
return e}function setLang(){//Update all static elements to the current language
$("[data-translate]").text(function(){var e=$(this),t=e.data("translate");return e.is("input[type='submit']")?void(e.val(_(t)),0<e.parent("div.ui-btn").length&&e.button("refresh")):_(t)}),$(".ui-toolbar-back-btn").text(_("Back")),checkCurrLang()}function updateLang(e){return(language={},"undefined"==typeof e)?void storage.get("lang",function(e){//Identify the current browser's locale
var t=e.lang||navigator.language||navigator.browserLanguage||navigator.systemLanguage||navigator.userLanguage||"en";updateLang(t.substring(0,2))}):(storage.set({lang:e}),currLang=e,"en"===e?void setLang():void $.getJSON(getAppURLPath()+"locale/"+e+".js",function(e){language=e.messages,setLang()}).fail(setLang))}function languageSelect(){$("#localization").popup("destroy").remove();/*
		Commented list of languages used by the string parser to identify strings for translation

		{af: _("Afrikaans"), am: _("Amharic"), zh: _("Chinese"), hr: _("Croatian"), cs: _("Czech"), et: _("Estonian")
		nl: _("Dutch"), en: _("English"), pes: _("Farsi"), fr: _("French"), de: _("German"), bg: _("Bulgarian"),
		el: _("Greek"), he: _("Hebrew"), hu: _("Hungarian"), is: _("Icelandic"), it: _("Italian"), lv: _("Latvian"),
		mn: _("Mongolian"), no: _("Norwegian"), pl: _("Polish"), pt: _("Portuguese"), ru: _("Russian"), ta: _("Tamil"),
		sk: _("Slovak"), sl: _("Slovenian"), es: _("Spanish"), th: _("Thai"), tr: _("Turkish"), sv: _("Swedish"), ro: _("Romanian")}
	*/var e="<div data-role='popup' data-theme='a' id='localization' data-corners='false'><ul data-inset='true' data-role='listview' id='lang' data-corners='false'><li data-role='list-divider' data-theme='b' class='center' data-translate='Localization'>"+_("Localization")+"</li>";return $.each({af:"Afrikaans",am:"Amharic",bg:"Bulgarian",zh:"Chinese",hr:"Croatian",cs:"Czech",nl:"Dutch",en:"English",et:"Estonian",pes:"Farsi",fr:"French",de:"German",el:"Greek",he:"Hebrew",hu:"Hungarian",is:"Icelandic",it:"Italian",lv:"Latvian",mn:"Mongolian",no:"Norwegian",pl:"Polish",pt:"Portuguese",ru:"Russian",sk:"Slovak",sl:"Slovenian",es:"Spanish",ta:"Tamil",th:"Thai",tr:"Turkish",sv:"Swedish",ro:"Romanian"},function(t,a){e+="<li><a href='#' data-translate='"+a+"' data-lang-code='"+t+"'>"+_(a)+"</a></li>"}),e+="</ul></div>",e=$(e),e.find("a").on("click",function(){var e=$(this),t=e.data("lang-code");updateLang(t)}),openPopup(e),!1}function checkCurrLang(){storage.get("lang",function(e){var t=$("#localization");t.find("a").each(function(){var t=$(this);t.data("lang-code")===e.lang?t.removeClass("ui-icon-carat-r").addClass("ui-icon-check"):t.removeClass("ui-icon-check").addClass("ui-icon-carat-r")}),t.find("li.ui-last-child").removeClass("ui-last-child")})}function getAppURLPath(){return currLocal?$.mobile.path.parseUrl($("head").find("script[src$='app.js']").attr("src")).hrefNoHash.slice(0,-9):""}function getUrlVars(e){for(var t={},a=e.slice(e.indexOf("?")+1).split("&"),n=0,s;n<a.length;n++)s=a[n].split("="),t[s[0]]=decodeURIComponent(s[1].replace(/\+/g,"%20"));return t}function escapeJSON(e){return JSON.stringify(e).replace(/\{|\}/g,"")}function unescapeJSON(e){return JSON.parse("{"+e+"}")}function isMD5(e){return /^[a-f0-9]{32}$/i.test(e)}function sortByStation(e,t){return e.station<t.station?-1:e.station>t.station?1:0}function minutesToTime(e){var t=719<e?"PM":"AM",a=parseInt(e/60)%12;return 0==a&&(a=12),a+":"+pad(e%60)+" "+t}function getBitFromByte(e,t){return 0!=(e&1<<t)}function getTimezoneOffset(){var e=Math.abs,t=controller.options.tz-48,a=0<=t?1:-1;return t=60*(e(t)/4>>0)+(15*(e(t)%4)/10>>0)+15*(e(t)%4)%10,t*a}// Credit Stacktrace
// https://stackoverflow.com/questions/3177836/how-to-format-time-since-xxx-e-g-4-minutes-ago-similar-to-stack-exchange-site/23259289#23259289
function humaniseDuration(e,t){var a=Math.abs,i=Math.floor,n=i((t-e)/1e3),s=!!(0<n),o;if(n=a(n),10>n)return _("Just Now");var d=i(n/31536e3);return 1<=d?o=1<d?_("years"):_("year"):(d=i(n/2592e3),1<=d?o=1<d?_("months"):_("month"):(d=i(n/86400),1<=d?o=1<d?_("days"):_("day"):(d=i(n/3600),1<=d?o=1<d?_("hours"):_("hour"):(d=i(n/60),1<=d?o=1<d?_("minutes"):_("minute"):(d=n,o=1<d?_("seconds"):_("second")))))),s?_("In")+" "+d+" "+o:d+" "+o+" "+_("ago")}function dateToString(e,t,a){var i=[_("Sun"),_("Mon"),_("Tue"),_("Wed"),_("Thr"),_("Fri"),_("Sat")],n=[_("Jan"),_("Feb"),_("Mar"),_("Apr"),_("May"),_("Jun"),_("Jul"),_("Aug"),_("Sep"),_("Oct"),_("Nov"),_("Dec")];return 0===e.getTime()?"--":(!1!==t&&e.setMinutes(e.getMinutes()+e.getTimezoneOffset()),"de"===currLang?pad(e.getDate())+"."+pad(e.getMonth()+1)+"."+e.getFullYear()+" "+pad(e.getHours())+":"+pad(e.getMinutes())+":"+pad(e.getSeconds()):1===a?n[e.getMonth()]+" "+pad(e.getDate())+", "+e.getFullYear()+" "+pad(e.getHours())+":"+pad(e.getMinutes())+":"+pad(e.getSeconds()):2===a?n[e.getMonth()]+" "+pad(e.getDate())+", "+pad(e.getHours())+":"+pad(e.getMinutes())+":"+pad(e.getSeconds()):i[e.getDay()]+", "+pad(e.getDate())+" "+n[e.getMonth()]+" "+e.getFullYear()+" "+pad(e.getHours())+":"+pad(e.getMinutes())+":"+pad(e.getSeconds()))}// Transform keys to JSON names for 2.1.9+
function transformKeys(e){if(checkOSVersion(219)){var t={};return Object.keys(e).forEach(function(a){var i=a.match(/^o(\d+)$/);i&&i[1]?t[Object.keys(keyIndex).find(function(e){return keyIndex[e]===parseInt(i[1],10)})]=e[a]:t[a]=e[a]}),t}return e}function transformKeysinString(e){var t={};e.split("&").forEach(function(e){e=e.split("="),t[e[0]]=e[1]}),t=transformKeys(t);var a=[];return Object.keys(t).forEach(function(e){a.push(e+"="+t[e])}),e=a.join("&"),e}